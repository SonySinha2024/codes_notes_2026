
dash.css

body { 
    font-family: Arial, sans-serif;
    padding: 0;
    background: #f5f5f5;
  }
  h1 {
    color: #088F8F;
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
  }
  th {
    background-color: #088F8F;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  tr:hover {
    background-color: #e9e9e9;
  }
  .controls {
    margin: 20px 0;
    text-align: center;
  }
  /* button {
    background-color: #088F8F;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px 20px;
    cursor: pointer;
    margin: 0 5px;
  } */
  button:hover {
    background-color: #077777;
  }


.main-container {
display: flex;
height: 100vh;
overflow: hidden;
}



.left-panel {
width: 215px;
padding: 2px;
background: #fff;
overflow-y: auto;
border-right: 1px solid #ccc;
}

.left-panel::-webkit-scrollbar {
width: 0.1rem;
}


.left-panel::-webkit-scrollbar-thumb {
  background-color: silver;
  border-radius: 0.5rem;
  background: transparent; 
}

.left-panel::-webkit-scrollbar-track {
  background: transparent;
}

.right-panel::-webkit-scrollbar {
width: 0.1rem;
}

.right-panel::-webkit-scrollbar-thumb {
  background-color: silver;
  border-radius: 0.5rem;
  background: transparent; 
}

.right-panel::-webkit-scrollbar-track {
  background: transparent;
}

.right-panel {
flex: 1;
padding: 30px;
overflow-y: auto;
}

img {
width: 200px;
margin-bottom: 20px;
}

h2, h3 {
color: #333;
}

button {
  width: fit-content;
background-color: #088F8F;
color: white;
border: none;
border-radius: 4px;
padding: 8px 16px;
margin: 5px 0;
cursor: pointer;
transition: background-color 0.3s ease;

}

button:hover {
background-color: #4CAF50;
}

/* table {
border-collapse: collapse;
width: 100%;
margin-top: 10px;
} */

th, td {
text-align: left;
border: 1px solid #ddd;
padding: 8px;
}

th {
background-color: #f2f2f2;
}

#tableContainer,
#chatContainer,
#combinedContainer {
display: none;
margin-top: 10px;
}

.filter-container {
margin-top: 10px;
padding: 10px;
background: #f9f9f9;
border-radius: 8px;
width:12rem;
border: 1px solid #ddd;
}

.filter-group {
margin-bottom: 15px;
}

.search-container {
margin-top: 10px;
}

label {
font-weight: bold;
}

input, select {
width: 95%;
margin-top: 5px;
margin-bottom: 5px;
padding: 6px;
border: 1px solid #ccc;
border-radius: 4px;
}

.charts {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 30px;
}

.chart-box {
border: 1px solid #ccc;
padding: 10px;
border-radius: 10px;
background: #fff;
box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

canvas {
width: 100% !important;
height: 300px !important;
background: white;
border-radius: 8px;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.loader {
border: 5px solid #f3f3f3;
border-top: 5px solid #088F8F;
border-radius: 50%;
width: 30px;
height: 30px;
animation: spin 2s linear infinite;
margin: 20px auto;
display: none;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Styling for the combined table with potentially wide content */
#combined-table {
table-layout: fixed;
width: 100%;
}

#combined-table th, 
#combined-table td {
word-wrap: break-word;
overflow-wrap: break-word;
max-width: 200px;
overflow: hidden;
text-overflow: ellipsis;
}

.truncate {
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
max-width: 200px;
display: block;
}

.expandable-cell {
cursor: pointer;
position: relative;
}

.expandable-cell:hover {
background-color: #f5f5f5;
}

.expandable-cell:hover::after {
content: "Click to expand";
position: absolute;
bottom: 0;
right: 0;
font-size: 10px;
background: rgba(0,0,0,0.7);
color: white;
padding: 2px 5px;
border-radius: 3px;
}

.expanded-content {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: white;
padding: 20px;
box-shadow: 0 0 20px rgba(0,0,0,0.3);
z-index: 1000;
max-width: 80%;
max-height: 80%;
overflow: auto;
border-radius: 8px;
display: none;
}

.close-expanded {
position: absolute;
top: 10px;
right: 10px;
cursor: pointer;
font-weight: bold;
font-size: 18px;
}

.overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 999;
display: none;
}
.top-bar {
display: flex;
justify-content: space-between;
align-items: flex-start;
/* padding: 10px 20px; */
background-color: #f5f5f5;
}

.logo-img {
max-height: 60px;
}

.top-right-controls {
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 10px;
}

#refreshBtn {
background-color: transparent;
width:fit-content;
color: white;
border: none;
padding: 4px 5px;
font-weight: bold;
border-radius: 5px;
cursor: pointer;
}

.search-box {
display: flex;
align-items: center;
gap: 8px;
}

.search-box input {
padding: 5px;
border-radius: 4px;
border: 1px solid #ccc;
}

.search-box button {
padding: 5px 10px;
border: none;
border-radius: 4px;
cursor: pointer;
}

#searchBtn {
background-color:#088F8F;
color: white;
width:fit-content;
}

#clearSearch {
background-color:#088F8F;
color: white;
width:fit-content;
}
.downloads-section {
margin-top: 1px; 
padding: 2px;
width: 13rem;
background: #f9f9f9;
border-radius: 8px;
border: 1px solid #ddd;
}

.downloads-section h3 {
/* margin-bottom:1rem; */

margin-left: 0.5rem;
color: #333;
}

.downloads-section button {
width: fit-content;
margin-top: 5px;
margin-left: 0.5rem;
}
.download-icon {
width: 20px;
height: 20px;
transform: translateY(135%);
}

#downloadUserDetails {
display: flex;
align-items: center;
gap: 8px; /* space between icon and text */
}

.download-icons {
width: 20px;
height: 20px;
transform: translateY(-25px);
margin-left: 7.3rem;
}

.summary-card h3 {
margin-bottom: -10px;
}

.summary-card .card-value {
margin-top: -8px;
}

.h6-style {
font-size: 0.8rem;       
font-weight: 600;
margin: 0;
}
#searchBtn,
#clearSearch {
display: none;
}

===
codes tech 

apps.py

from flask import Flask, request, jsonify, render_template
import uuid
import pytz
from google.cloud import firestore
from pytz import timezone
from datetime import timedelta
from datetime import datetime
from dotenv import load_dotenv
from flask import Flask, request, jsonify, render_template, session
from flask_session import Session
import uuid
from flask_cors import CORS
import os
import time
import google.generativeai as genai
from bs4 import BeautifulSoup
import requests
import random
import re
import json
import logging as log
from langchain_community.document_loaders import UnstructuredURLLoader
from langchain.text_splitter import CharacterTextSplitter
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_community.vectorstores import Chroma
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime
from google.cloud import storage
from html.parser import HTMLParser
import secrets

app = Flask(__name__)

config_file_path='C:/s_codes/git_clone/poc_chatbot/version1/chatbot_codes/config/.env'
load_dotenv(dotenv_path=config_file_path)

## Configure logging
log.basicConfig(level=log.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
log = log.getLogger(__name__)

## Load environment variables from .env file
env_path = os.path.join(os.path.dirname(__file__), "config", ".env")
load_dotenv(env_path)
dotenv_path = os.path.join(os.path.dirname(__file__), '..', 'config', '.env')
load_dotenv(dotenv_path=dotenv_path)

## API Key
google_api_key = os.getenv('google_api_key')
if not google_api_key:
    log.error("Required API keys are missing from environment variables.")
    raise EnvironmentError("Required API keys are missing from environment variables.")

## GOOGLE_APPLICATION_CREDENTIALS
google_credentials_path = os.getenv("GOOGLE_APPLICATION_CREDENTIALS")
if not google_credentials_path:
    log.error("Required google_credentials_path are missing from environment variables.")
    raise EnvironmentError("Required google_credentials_path are missing from environment variables.")

## Set GOOGLE_APPLICATION_CREDENTIALS environment variable
if google_credentials_path:
    os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = google_credentials_path
print("GOOGLE_APPLICATION_CREDENTIALS:", os.getenv("GOOGLE_APPLICATION_CREDENTIALS"))

## Initialize Google Cloud Storage client
storage_client = storage.Client()
BUCKET_NAME = "testrig-bot-static-files"
bucket = storage_client.bucket(BUCKET_NAME)
print("Google Cloud Storage client initialized successfully!")

## Store chat sessions temporarily
chat_sessions = {}
## Initialize Google Cloud Storage client
firestore_client = firestore.Client()

genai.configure(api_key=google_api_key)
model = genai.GenerativeModel("gemini-2.0-flash-lite")
chat = model.start_chat()

CORS(app, supports_credentials=True)

## List of URLs to fetch and process
url_input = [
    "https://www.testrigtechnologies.com/",
    "https://www.testrigtechnologies.com/case-study/",
    "https://www.testrigtechnologies.com/blogs/",
    "https://www.testrigtechnologies.com/industries/",
    "https://www.testrigtechnologies.com/ai-testing-services/"
]

## Preprocess query
def preprocess_query(user_query):
    corrected_query = user_query.strip().lower()
    if "software testing" in corrected_query:
        rephrased_query = f"Could you provide information about {corrected_query.replace('software testing', 'software testing related topics')}?"
    else:
        rephrased_query = f"Can you tell me more about {corrected_query}?"
    return rephrased_query

## Fetch and process content from URL
def fetch_text_from_url(url_input):
    try:
        response = requests.get(url_input)
        soup = BeautifulSoup(response.content, "html.parser")
        text = " ".join(p.get_text() for p in soup.find_all("p"))
        return text
    except Exception as e:
        log.error(f"Error fetching text from URL: {e}")
        return ""

def fetch_keywords_from_url(url_input):
    try:
        response = requests.get(url_input)
        soup = BeautifulSoup(response.content, "html.parser")
        text = " ".join(p.get_text() for p in soup.find_all("p"))
        keywords = set(re.findall(r'\b\w+\b', text.lower()))
        return keywords
    except Exception as e:
        log.error(f"Error fetching keywords from URL: {e}")
        return set()
    
url_input = "https://www.testrigtechnologies.com/"
keywords = fetch_keywords_from_url(url_input)
log.info(f"Extracted keywords: {list(keywords)[:20]}")

## System Prompt defining chatbot's role and behaviour

system_prompt = """
You are the official chatbot of Testrig Technologies, specializing strictly in software testing and development services. Respond only using the verified content from these sources:

- https://www.testrigtechnologies.com/
- https://www.testrigtechnologies.com/case-study/
- https://www.testrigtechnologies.com/blogs/
- https://www.testrigtechnologies.com/industries/
- https://www.testrigtechnologies.com/ai-testing-services/
- https://www.testrigtechnologies.com/ai-automation-testing-services/

Response Guidelines:
- Limit your answers to 30‚Äì150 words.
- Use bold headers or subheaders for structure.
- Organize into clear short paragraphs, separated by line breaks.
- Do not use bullets, numbering, or any numeric data (e.g., prices, counts, durations).
- Use only clickable <a href> links from the official site.
- Avoid repetitive or filler content.
- Maintain a professional, helpful tone.

Query Types & Content Handling:
- For queries related to automation, API, performance, mobile, security, AI/ML, IoT, or web app testing ‚Äî provide relevant service page links.
- If the query asks for blogs or case studies, include the appropriate URL.
- If the user wants to connect, suggest:
  <a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>

For email queries, include:
Email: <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>

Strict Restrictions:
- Do not answer off-topic or irrelevant queries (examples include: football, travel plans, MBA studies, movies, feelings, weather, games, vehicles, music, fashion, hacking, etc.).
- Do not provide general knowledge, opinions, or fabricated content.
- Do not estimate or suggest timelines, costs, or internal data.
- Do not redirect to unlisted or third-party sources.

When receiving an off-topic query, respond only with:
Please feel free to ask about Testrig Technologies, we are happy to assistüòä  
<a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>

 Note:
Always follow the structure and tone of few_shot_qna(question) when forming responses.
"""


# system_prompt = """
# You are the official chatbot of Testrig Technologies, specializing in software testing solutions. Respond strictly using only the content available from the following sources:

# - https://www.testrigtechnologies.com/
# - https://www.testrigtechnologies.com/case-study/
# - https://www.testrigtechnologies.com/blogs/
# - https://www.testrigtechnologies.com/industries/
# - https://www.testrigtechnologies.com/ai-testing-services/
# - https://www.testrigtechnologies.com/ai-automation-testing-services/

# Guidelines for Generating Responses:
# - Responses must be between 30 to 150 words.
# - Use bold headers or subheaders and new lines when switching sections.
# - Do not use bullets, numbering, or include any numeric values (e.g., costs, timelines, employee count).
# - Always include clickable <a href> links from the official site for any service, case study, blog, or industry.
# - Avoid repetition. Keep the tone professional and informative.

# Query Handling:
# - For services like security, API testing, performance, mobile, AI/ML, IoT, automation, or web app testing, always include the corresponding service page link.
# - If asked about blogs or case studies, include the appropriate blog/case-study URL.
# - If recommending contacting the team or visiting the website, provide a **<a href> contact or demo link.

# Prohibited Actions:
# - Do not hallucinate, speculate, or answer with general knowledge**.
# - Do notgenerate personal opinions or fabricate responses.
# - Do not provide estimates or figures of any kind.

# For Off-topic Queries (e.g., rainbow, ocean, hacking, music, food,travels, games,dresses,feelings, vehicles, transport, profession etc.):
# Reply:  
# Please feel Free to ask about Testrig Technologies, We will be happy to assistüòä  
# <a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>

# Email: To contact by Email Id, always include:  
# Email:<a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>

# You must always follow the structure of few_shot_qna(question) when responding.
# """

def strict_prompt(query):
     return system_prompt.format(query=query)

def fetch_texts_from_urls(urls):
    url_data = {}
    with ThreadPoolExecutor() as executor:
        futures = {executor.submit(fetch_text_from_url, url): url for url in urls}
        for future in futures:
            url = futures[future]
            try:
                url_data[url] = future.result()
            except Exception as e:
                log.error(f"Error fetching content from {url}: {e}")
    return url_data

## Initialize vector database and embeddings
def initialize_vectordb(urls):
    loader = UnstructuredURLLoader(urls=urls)
    data = loader.load()
    text_splitter = CharacterTextSplitter(separator='\n', chunk_size=1000, chunk_overlap=200)
    text_chunks = text_splitter.split_documents(data)
    embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/all-MiniLM-L6-v2")
    vectordb = Chroma.from_documents(text_chunks, embedding=embeddings, persist_directory="db")
    vectordb.persist()
    return vectordb

def few_shot_qna(question):
    examples = [
        ("Is TestAlloy a product of Testrig Technologies?",
         "Yes, TestAlloy is a Testing Software Product of Testrig Technologies developed to provide End to End Testing Solutions with features like AI-Powered Test Case Generation,Modern Test Management and Defect tracking,Release Management,Project Management Dashboard."),
        ("Do you offer security testing services?", 
         "Yes, we offer Security testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/security-testing/' target='_blank'>Security Testing Services</a><br>"),
        ("Do you offer AI/ML testing services?", 
         "Yes, we offer AI/ML testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/ai-testing-services/' target='_blank'>AI/ML Testing Services</a><br>"),
        ("Do you offer API testing services?", 
         "Yes, we offer API Testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/api-testing/' target='_blank'>API Testing Services</a><br>"),
        ("Do you offer Performance Testing services?", 
         "Yes, we offer Performance Testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/performance-testing/' target='_blank'>Performance Testing Services</a><br>"),
        ("Do you offer training for in-house testing teams?", 
         "Absolutely, We prioritize the professional development of our in-house testing teams through structured training sessions and practical learning modules.<br>Our management team curates targeted courses designed to upskill team members while tracking their progress to ensure consistent growth and excellence."),
        ("How to contact Testrig Technologies?",
         """You can connect with us through the following channels:<br>
         1 Schedule a meeting directly with our team: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>
         2 Email us at: <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>
         3 Submit your inquiry via our contact form: <a href='https://www.testrigtechnologies.com/contact-us/' target='_blank'>Contact Us</a>"""),
         ("What kind of reporting process does Testrig Technologies follow?",
          """We maintain a clear and transparent reporting process:<br>
             1.Daily Updates: Detailed test execution reports shared regularly. <br>
             2.Collaborative Calls: Essential calls with development teams to address blockers and align on progress. <br>
             3.Custom Reports: Tailored reporting formats to meet client-specific requirements, providing actionable insights. <br>
             This ensures seamless communication and progress tracking throughout the project lifecycle.<br> 
             We have a daily report format with essential calls from the development team. We believe ‚Äúon connect‚Äù on a daily basis as per need."""),
             ("provide me case study of testing services in ecommerce domain?",
             "Yes,We offer Testing services for Ecommerce,<br>You can visit our services here: <a href= 'https://www.testrigtechnologies.com/case-study/elevating-user-experience-and-functionality-test-automation-implementation-for-a-global-b2b-e-commerce-company/' target='_blank'>Ecommerce Testing Services Case Study</a><br>"),
            ("can u provide some success stories or client speaks or testimonials"),
            ("Yes,You can find case studies: <a href= 'https://www.testrigtechnologies.com/testimonials/' target='_blank'>Testimonials</a><br>"),
            ("What tools does Testrig Technologies use for automation testing?",
             """ At Testrig Technologies, we leverage a variety of advanced tools for efficient automation testing, including:<br>
                Selenium:Web automation for multiple browsers.<br>
                Cypress:Fast, modern testing for web applications.<br>
                Playwright:Cross-browser testing with robust features.<br>
                Appium:Mobile app automation for iOS and Android.<br>
                Postman:API testing and automation.<br>
                Jest:JavaScript testing for unit and integration tests.<br>
                JUnit & TestNG: Java-based frameworks for unit and integration testing.<br>
                Katalon Studio:Comprehensive automation for web, API, and mobile.<br>
                Ranorex:All-in-one test automation for desktop, web, and mobile.<br>
                Jenkins:CI/CD integration for automated testing.<br>
                These tools help us deliver reliable, scalable automation testing solutions.<br>
                Explore our automation testing services: <a href='https://www.testrigtechnologies.com/' target='_blank'>Explore our Services</a>"""),
            ("What tools does Testrig Technologies use for Security testing?",
                 """ Testrig Technologies, we use the following tools for security testing:<br>
                    OWASP ZAP: We utilize this powerful open-source tool to identify vulnerabilities in web applications.<br>
                    Burp Suite: We rely on Burp Suite for comprehensive web application vulnerability scanning and security testing.<br>
                    Nmap: We use Nmap for network scanning to discover devices and potential security risks within your infrastructure.<br>
                    Metasploit: We leverage Metasploit for penetration testing, helping us to exploit vulnerabilities and assess your application's security.<br>
                    These tools enable us to perform thorough security assessments, ensuring the safety and integrity of your systems.<br>
                    For more details, visit: <a href='https://www.testrigtechnologies.com/security-testing/' target='_blank'>Security Testing Services</a><br>"),
                """),
            ("What tools does Testrig Technologies use for mobile application testing?",
             """Testrig Technologies uses the following tools for mobile app automation testing<br>
                Appium: For cross-platform mobile automation.<br>
                Robot Framework: A keyword-driven framework for efficient testing.<br>
                Katalon Studio: A comprehensive tool for web and mobile app testing.<br>
                BrowserStack: For real-device and cross-browser testing.<br>
                AWS Device Farm: Cloud-based testing on real devices.<br>
                These tools ensure thorough, reliable testing across all mobile platforms.<br>
                For more details, visit:<a href='https://www.testrigtechnologies.com/mobile-app-testing/' target='_blank'>Mobile App Testing Services</a><br>"),
             """),
             ("What tools does Testrig Technologies use for Performance testing?",
              """   Testrig Technologies, we use the following tools for performance testing<br>
                JMeter: We use JMeter for load testing and performance measurement of web applications.<br>
                LoadRunner: This tool helps us simulate virtual users and assess the performance of applications under varying load conditions.<br>
                Locust: We leverage Locust for easy and scalable load testing, particularly in distributed environments.<br>
                LoadNinja: We use LoadNinja to perform real-time, browser-based load testing for web applications.
                K6: We rely on K6 for modern load testing, focusing on API testing and performance.<br>
                BlazeMeter: We use BlazeMeter for continuous performance testing, enabling efficient testing of apps at scale.<br>
                These tools help us ensure your application can handle high traffic and deliver optimal performance under pressure.<br>
                For more details visit: <a href='https://www.testrigtechnologies.com/performance-testing/' target='_blank'>Performance Testing Services</a><br>"),
                """),
                ("What QA services does Testrig Technologies offer?",
                """  Testrig Technologies, We deliver a wide range of QA services, including<br>
                  Automation Testing: Streamlined test automation using modern tools and frameworks.
                  Security Testing: Identifying vulnerabilities and ensuring robust application security.
                  Mobile Testing: Comprehensive testing for mobile applications across various platforms and devices.
                  Performance Testing: Assessing system reliability and scalability under varying loads.
                  Web Testing: Ensuring flawless functionality, performance, and usability across browsers.
                  Functional and Non-Functional Testing: Ensuring every feature works as intended while addressing user experience and system behavior under different conditions.
                  We combine Agile and DevOps methodologies with cutting-edge tools to deliver efficient and high-quality QA solutions. 
                  Explore our Services: <a href='https://www.testrigtechnologies.com/' target='_blank'>Explore our Services</a>"""),
                ("What is Testrig Technology?",
                """Testrig Technologies is a premier software testing and quality assurance firm specializing in comprehensive end-to-end testing solutions.<br>Testrig ensures the reliability, scalability, and security of software applications.<br>The company excels in delivering high-quality services across web and mobile application testing, API validation, performance engineering, and security testing, empowering organizations to achieve seamless digital transformation while optimizing their time-to-market and operational efficiency."""),
                ("Who is the CEO and Founder of Testrig Technologies? ",
                """Parimal Kumar, the CEO and Founder of Testrig Technologies, is a dynamic leader with extensive expertise in Software Testing and Quality Assurance.<br>His forward-thinking approach leverages advanced methodologies, including AI and ML-powered testing frameworks, to deliver cutting-edge solutions.<br>Passionate about fostering excellence, Parimal is dedicated to empowering businesses worldwide by ensuring robust, secure, and high-performing software applications. <br>Connect with him on LinkedIn to learn more about his professional journey and insights."""),
                ("do u have any testimonials or success stories or use cases",
                """Yes, we have client testimonials available on our website. Here's the link: <a href='https://www.testrigtechnologies.com/testimonials/' target='_blank'>Explore our Testimonials</a>"""),
                ("colors of rainbow,sky is blue, ocean,earth,sun,moon,cricket,football,games,hacking,stealing,killing,dancing,smiling,face,singing,walking,enjoying,stationery,school,college,medical",
                """Please feel free to ask about our domain, and We will be happy to serve.<br>Please visit <a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a> for more information."""),
                ("Who is the CEO and Founder of Testrig Technologies? ",
                 """Parimal Kumar, the CEO and Founder of Testrig Technologies, is a dynamic leader with extensive expertise in Software Testing and Quality Assurance.<br>His forward-thinking approach leverages advanced methodologies, including AI and ML-powered testing frameworks, to deliver cutting-edge solutions.<br>Passionate about fostering excellence, Parimal is dedicated to empowering businesses worldwide by ensuring robust, secure, and high-performing software applications. <br>Connect with him on LinkedIn:<a href='href='https://www.linkedin.com/in/parimalkr/' target='_blank'>Connect on Linkedln</a to explore more about his professional journey and insights."""),
                ("what is mission of Testrig Technologies",
                 """Yes, Testrig Technologies has vision of Empowering businesses through innovative and reliable testingsolutions.<br>Testrig Technologies envisions becoming a global leader in software testing, driving digital transformation, and ensuring exceptional quality in every software product."""),
                ("what is mission of Testrig Technologies",
                """At Testrig Technologies is dedicated to delivering exceptional software testing services that empower organizations to build robust, reliable, and secure software products, driving their success in a competitive marketplace."""),
                ("what is Core Values of Testrig Technologies",
                """Customer Centric,Trust,Continuous Learning,Ownership,Team Work are core values of Testrig Technologies """),
                ("what is Foundation Day of Testrig Technologies ",
                """Testrig Technologies is founded on 15 Oct, 2015 by Parimal Kumar.Connect:<a href='https://www.linkedin.com/in/parimalkr/' target='_blank'>Connect on Linkedln</a> """),
                ("how many days takes for performance or load or security or manual or ai/ml or mobile or web app testing or any other testing services",
                """The duration of automation testing can vary depending on various factors such as the complexity of the application, the size of the test suite, and the number of resources allocated.<br>Schedule a meeting directly with our team: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>"""),
                ("what is the cost of performance or load or security or manual or ai/ml or mobile or web app testing or any other testing services",
                """The cost of testing services can vary depending on the specific requirements of your project.For an accurate quote, we recommend scheduling a free consultation with our team.<br>This will allow us to better understand your needs and provide you with a tailored solution that meets your budget.<br>Schedule a meeting directly with our team: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>"""),
                ("what is the number of staffs for performance or load or security or manual or ai/ml or mobile or web app testing or any other testing services",
                """We employ a dedicated team of highly skilled and certified testing professionals who are passionate about delivering exceptional services.<br>This will allow us to better understand your needs and provide you with a tailored solution that meets your budget.<br>Schedule a meeting directly with our team: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>"""),
                ("who created you or who developed you and What is the purpose?",
                "I am a Techbot created by Testrig Technologies developed to answer queries and to serve you for any type of Software Testing Services."),
                ]
    formatted_examples = "\n".join([f"Q: {ex[0]}\nA: {ex[1]}" for ex in examples])
    return f"{formatted_examples}\nQ: {question}"

## Summarization template
def summarization_template(text):
    return f"Summarize the following information based on information found only in the URL https://www.testrigtechnologies.com/:\n\n{text}"

## Q&A template
def qna_template(question):
    return f"Answer the following Testrig Technology-related question in simple terms:\n\n{question}"

# def get_gemini_response(question, context=None, prompt_type="few_shot_qna", min_words=30, max_words=90):
#     try:
#         chat = model.start_chat(history=[])
#         if context:
#             question = f"{context}: {question}"

#         query_keywords = set(re.findall(r'\b\w+\b', question.lower()))
#         if prompt_type == "few_shot_qna":
#             question = few_shot_qna(question)

#         ## Check if the question is related to Testrig Technologies
#         if not query_keywords.intersection(keywords):
#             return """We are unable to assist with your query.<br>
#                       Please feel free to ask about Testrig Technologies Testing Services<br>We will be happy to assist.
#                       üìß:<a href=\"https://www.testrigtechnologies.com/contact-us/\" target=\"_blank\">Contact Us</a>"""

#         response = chat.send_message(question, stream=True)
#         full_response = "".join([chunk.text for chunk in response])

#         # Clean up unwanted formatting or numbered lists
#         full_response = re.sub(r'\*+|\d+\.', '', full_response)
#         full_response = re.sub(r'\s+', ' ', full_response).strip()

#         # Enforce word limits
#         words = full_response.split()
#         if len(words) < min_words:
#             return format_response(full_response)

#         limited_response = " ".join(words[:max_words])
#         sentences = re.split(r'(?<=[.!?]) +', limited_response)
#         final_response = " ".join(sentences[:-1]) if len(" ".join(sentences[:-1]).split()) >= min_words else limited_response

#         # Formatting headers/subheaders in bold on new lines
#         def format_text(text):
#             lines = []
#             for line in re.split(r'(?<=\.)\s+(?=[A-Z])', text):
#                 line = line.strip()
#                 if ':' in line:
#                     header, rest = line.split(':', 1)
#                     lines.append(f"<br><b>{header.strip()}:</b><br>{rest.strip()}")
#                 else:
#                     lines.append(line)
#             return "<br>".join(lines)

#         final_response = format_text(final_response)
#         final_response += '<br><br> üìß<a href=\"https://www.testrigtechnologies.com/contact-us/\" target=\"_blank\">Contact Us</a><br>'

#         return format_response(final_response)

#     except Exception as e:
#         log.error(f"Error in Gemini API response: {e}")
#         return 'Server is busy.<br>üí¨<a href="mailto:info@testrigtechnologies.com">info@testrigtechnologies.com</a><br>'


def format_response(response):
    # Only remove "A:" if both capital A and : are present together
    if response.startswith("A:"):
        response = response[2:].strip()
    
    # Replace AI-related phrases with "testrig technologies"
    ai_phrases = [
        r"\bi am techbot\b",
        r"\bi am llm model\b", 
        r"\bas a llm model,?\s*i am not programmed to\b",
        r"\bas a[n]? AI\b",
        r"\bI am a language model\b",
        r"\bas an AI\b",
        r"\bI'm an AI\b",
        r"\bI am an AI\b"
    ]
    
    for phrase in ai_phrases:
        response = re.sub(phrase, "testrig technologies", response, flags=re.IGNORECASE)
    
    # Remove markdown formatting
    response = re.sub(r"\*{1,2}(\S.*?\S?)\*{1,2}", r"\1", response)  
    return response

def get_gemini_response(question, context=None, prompt_type="few_shot_qna", min_words=30, max_words=90):
    try:
        chat = model.start_chat(history=[])
        if context:
            question = f"{context}: {question}"
        query_keywords = set(re.findall(r'\b\w+\b', question.lower()))
        if prompt_type == "few_shot_qna":
            question = few_shot_qna(question)
        ## Check if the question is related to Testrig Technologies
        if not query_keywords.intersection(keywords):
            return """Sorry,Please feel free to query related to Testrig Technologies.<br>We will be glad to assist.<br>
                      <a href=\"https://www.testrigtechnologies.com/contact-us/\" target=\"_blank\">Contact Us</a><br>
                      <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>"""
        response = chat.send_message(question, stream=True)
        full_response = "".join([chunk.text for chunk in response])
        
        # Replace AI-related phrases with "testrig technologies" BEFORE other processing
        ai_phrases = [
            r"\bi am techbot\b",
            r"\bi am llm model\b", 
            r"\bas a llm model,?\s*i am not programmed to\b",
            r"\bas a[n]? AI\b",
            r"\bI am a language model\b",
            r"\bas an AI\b",
            r"\bI'm an AI\b",
            r"\bI am an AI\b"
        ]
        
        for phrase in ai_phrases:
            full_response = re.sub(phrase, "testrig technologies", full_response, flags=re.IGNORECASE)
        
        # Only remove "A:" if it appears at the start with capital A followed by colon
        if full_response.strip().startswith('A:'):
            full_response = full_response.strip()[2:].strip()
        
        # Clean up unwanted formatting or numbered lists
        full_response = re.sub(r'\*+|\d+\.', '', full_response)
        full_response = re.sub(r'\s+', ' ', full_response).strip()
        
        # Enforce word limits
        words = full_response.split()
        if len(words) < min_words:
            return format_response(full_response)
        limited_response = " ".join(words[:max_words])
        sentences = re.split(r'(?<=[.!?]) +', limited_response)
        final_response = " ".join(sentences[:-1]) if len(" ".join(sentences[:-1]).split()) >= min_words else limited_response
        
        # Formatting headers/subheaders in bold on new lines
        def format_text(text):
            lines = []
            for line in re.split(r'(?<=\.)\s+(?=[A-Z])', text):
                line = line.strip()
                if ':' in line:
                    header, rest = line.split(':', 1)
                    lines.append(f"<br><b>{header.strip()}:</b><br>{rest.strip()}")
                else:
                    lines.append(line)
            return "<br>".join(lines)
        
        final_response = format_text(final_response)
        final_response += '<br><br>For any queries:<a href=\"https://www.testrigtechnologies.com/contact-us/\" target=\"_blank\">Contact Us</a><br><a href="mailto:info@testrigtechnologies.com">info@testrigtechnologies.com</a><br>'
        return format_response(final_response)
    except Exception as e:
        log.error(f"Error in Gemini API response: {e}")
        return 'Server is busy.<br>üí¨<a href="mailto:info@testrigtechnologies.com">info@testrigtechnologies.com</a><br>'

## Process URL content
def process_url_content(url):
    try:
        with ThreadPoolExecutor() as executor:
            future = executor.submit(fetch_text_from_url, url)
            text = future.result()
        text_splitter = CharacterTextSplitter(separator='\n', chunk_size=1000, chunk_overlap=200)
        chunks = text_splitter.split_text(text)
        return chunks
    except Exception as e:
        log.error(f"Error processing URL content: {e}")
        return []

## Initialize context
url_input = "https://www.testrigtechnologies.com/"
if url_input:
    try:
        context_text = fetch_text_from_url(url_input)
        vectordb = initialize_vectordb([url_input])
        retriever = vectordb.as_retriever()
        log.info("URL content loaded successfully.")
    except Exception as e:
        log.error(f"Failed to fetch content from URL: {e}")

## Function to remove HTML tags
def strip_html_tags(text):
    # Remove HTML tags, including malformed ones
    clean = re.compile(r'</?p[^>]*>|<br\s*/?>', re.IGNORECASE)
    text = re.sub(clean, '', text)
    return text

def clean_html_tags(text):
    """
    Replace specific HTML fragments with a space:
    '</p><p style='margin:0;', '<p style='margin:0;', '</p><br>', '</p>', and '<br>'.
    """
    return re.sub(r"</?p(?: style='margin:0;')?>|<br>", ' ', text).strip()

## Predefined responses
responses = {
    "greetings": [
        "Hi there!", "Hello!", "Greetings!", "Hey! Nice to see you.","hi","hii","hiii,"
        "Good to have you here!", "Hi! How's it going?", "What's up?", "Hey there!"
    ],
    "how are you?": [
        "Thanks for asking!", "Doing well, how about you?",
        "I'm here to assist!", "I'm functioning at full capacity!",
        "I'm doing great!", "Ready to assist! How are you today?",
        "Thanks for asking! How about yourself?"
    ],
    "bye": [
        "Goodbye!", "See you later!", "Take care!",
        "Have a good one!", "Catch you later!", "Bye for now!", "Goodbye, have a great day!"
    ],
    "what is time": [
        "I'm sure it's the perfect time to be productive!",
        "I can help you anytime!", "It is always a good time for a chat!"
    ],
    "how can you help": [
        "I'm here to assist from answering questions to offering support.",
        "Feel free to ask me anything, I'm ready to help.",
        "Let me know what you need, and I'll do my best to assist."
    ]
}

def get_date_folder():
    return datetime.now().strftime("%b-%d-%Y").lower()

def save_combined_chat_logs_to_firestore(service, email, username, chat_history_path):
    with open(chat_history_path, 'r') as f:
        chat_content = f.read()
        chat_content = strip_html_tags(chat_content)

    session_id = str(uuid.uuid4())
    timestamp = datetime.utcnow().isoformat()

    log_data = {
        'timestamp': datetime.utcnow(),
        'username': username,
        'email': email,
        'sessionId': session_id,
        'service': service,
        'visit time': timestamp,
        'chat_history': chat_content
    }
    firestore_client.collection("chat_logs").add(log_data)
    print("Saved to Firestore (chat_logs):", log_data)

def save_user_details_to_firestore(username, email, session_id, service, chat_entry=None):
    timestamp = datetime.utcnow().isoformat()
    data_to_store = {
        'timestamp': datetime.utcnow(),
        'username': username,
        'email': email,
        'sessionId': session_id,
        'service': service,
        'visit time': timestamp,
        'time': timestamp,
        'chat_entry': chat_entry or ""
    }
    firestore_client.collection("user_details").add(data_to_store)
    print("Saved to Firestore (user_details):", data_to_store)

def save_new_user(session_id, username, email, service="Unknown"):
    data = request.json
    service = data.get("service_clicked_by_user", "Unknown")
    formatted_username = " ".join([word.capitalize() for word in username.split()])
    save_user_details_to_firestore(formatted_username, email, session_id, service)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/get_session', methods=['POST'])
def get_session():
    data = request.json
    email = data.get("email")
    if not email:
        return jsonify({"response": "Please enter your email ID."}), 400

    session_id = str(uuid.uuid4())
    chat_sessions[session_id] = []
    return jsonify({
        "exists": False,
        "session_id": session_id,
        "response": "Welcome to Testrig Technologiesüéâ. Please share your name:"
    })

@app.route('/ask', methods=['POST'])
def ask():
    data = request.json
    message = data.get("message")
    session_id = data.get("sessionID")
    email = data.get("email")
    username = data.get("username")
    service = data.get("service", "Unknown")
    if not message or not session_id:
        return jsonify({"error": "Invalid request. Missing message or session ID."}), 400

    if message.strip().lower() in ["hi", "hii", "hiii", "hello", "hey", "hey there", "this side"]:
        response = random.choice(responses["Greetingsüéâ How may I assist you"])
    else:
        response = get_gemini_response(message, prompt_type="few_shot_qna")

    if session_id in chat_sessions:
        chat_sessions[session_id].append(f"User: {message}")
        chat_sessions[session_id].append(f"Bot: {response}")

    log_bot_interaction(session_id, email, username, message, response)
    save_session()
    return jsonify({"response": response})

def log_bot_interaction(session_id, email, username, user_query, bot_response):
    doc_ref = firestore_client.collection("testrig_queries").document(session_id)
    try:
        doc = doc_ref.get()
        data = doc.to_dict() if doc.exists else {}
        existing_queries = [key for key in data.keys() if key.startswith("query_by_bot")]
        query_count = len(existing_queries) + 1

        update_data = {
            f"query_by_bot{query_count}": user_query,
            f"response_by_bot{query_count}": strip_html_tags(bot_response),
            "timestamp": datetime.utcnow(),
            "time": datetime.utcnow().isoformat(),
            "sessionId": session_id
        }

        doc_ref.set(update_data, merge=True)
        print(f"Updated Firestore document for session {session_id} with query/response #{query_count}")
    except Exception as e:
        print("Error saving to Firestore:", e)

@app.route("/finalize_session", methods=["POST"])
def finalize_session():
    data = request.json
    session_id = data.get("session_id")
    email = data.get("email")
    if not session_id or not email:
        return jsonify({"error": "Missing session_id or email"}), 400
    # Remove GCS usage here ‚Äì just return success or save in Firestore if needed
    return jsonify({"message": "Session finalized successfully"})

@app.route("/save_chat", methods=["POST"])
def save_chat():
    data = request.json
    session_id = data.get("session_id")
    email = data.get("email")
    username = data.get("username")
    if not session_id or not email or not username:
        return jsonify({"error": "Missing session_id, email, or username"}), 400
    chat_history = "\n".join(chat_sessions.get(session_id, []))
    return jsonify({"message": "Chat history saved successfully"})


def get_indian_timestamp():
    india_tz = pytz.timezone("Asia/Kolkata")
    ist_now = datetime.now(india_tz)
    return ist_now.strftime("%Y-%m-%dT%H:%M:%S") 

# Firestore client
firestore_client = firestore.Client()

def get_indian_timestamp():
   
    return datetime.now(timezone("Asia/Kolkata")).strftime("%Y-%m-%d %H:%M:%S")

@app.route('/save_session', methods=['POST']) 
def save_session():
    """Saves session data to Firestore only."""
    data = request.json
    if not data.get("name") or not data.get("email"):
        return jsonify({"error": "Name and email are required"}), 400

    session_id = str(os.urandom(8).hex())
    timestamp = get_indian_timestamp()

    session_data = {
        "session_id": session_id,
        "username": data["name"],
        "email": data["email"],
        "time": timestamp,
        "service": data.get("service_clicked_by_user", "Not provided"),
        "chat_history": []
    }

    try:
        firestore_client.collection("testrig_UserDetails").document(session_id).set(session_data)
        print("Saved session to Firestore:", session_data)

        formatted_username = session_data["username"].capitalize()
        chatbot_response = f"Thanks, {formatted_username}! Feel free to chat with us."

        return jsonify({
            "message": "Session saved",
            "session_id": session_id,
            'visit time': timestamp,

            "response": chatbot_response
        })
    except Exception as e:
        return jsonify({"error": f"Failed to save session: {str(e)}"}), 500

@app.route('/save', methods=['POST'])
def save_data():
    """Waits 3 minutes, then stores basic user data in Firestore."""
    user_data = request.json
    service = user_data.get('service')
    email = user_data.get('email')
    username = user_data.get('username')

    if not service:
        return jsonify({"error": "Service is required"}), 400

    session_id = str(uuid.uuid4())
    timestamp = get_indian_timestamp()

    data_to_store = {
        "session_id": session_id,
        "service": service,
        "email": email,
        "username": username,
        "time": timestamp
    }

    time.sleep(180)

    try:
        firestore_client.collection("testrig_UserDetails").document(session_id).set(data_to_store)
        print("Saved basic info to Firestore:", data_to_store)
        return jsonify({"message": "Data saved successfully", "session_id": session_id})
    except Exception as e:
        return jsonify({"error": f"Failed to save to Firestore: {str(e)}"}), 500

def clean_html_tags(text):
    import re
    return re.sub(r'<[^>]*>', '', text)

def update_combined_chat_logs(session_id, email, new_chat_entry):
    """Update chat logs in Firestore for a given session."""
    try:
        doc_ref = firestore_client.collection("testrig_UserDetails").document(session_id)
        doc = doc_ref.get()
        if doc.exists:
            session_data = doc.to_dict()
        else:
            session_data = {
                "session_id": session_id,
                "email": email,
                "chat_history": []
            }

        if isinstance(new_chat_entry, str):
            new_chat_entry = {"user_message": new_chat_entry, "chatbot_response": ""}

        if "user_message" in new_chat_entry:
            new_chat_entry["user_message"] = clean_html_tags(new_chat_entry["user_message"])

        if "chatbot_response" in new_chat_entry:
            new_chat_entry["chatbot_response"] = clean_html_tags(new_chat_entry["chatbot_response"])

        session_data["chat_history"].append(new_chat_entry)

        doc_ref.set(session_data)
        print(f"Chat log updated in Firestore: {session_id}")
    except Exception as e:
        print("Error updating Firestore chat log:", e)


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8089)
=============


<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Application</title>
    <style> 
        .read-more-button {
            background-color: transparent;
            color: #179b5c;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .read-more-button:hover {
            text-decoration: underline;
        }     
        .chat-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color:whitesmoke;
            box-shadow: 0 5px 10px slategrey;
            z-index: 1000;
        }       
        .chat-header {
        background: linear-gradient(to bottom right, #20bc75, #2d9782); 
        padding: 10px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        }        
        .chat-header img {
            height: 25px;
            margin-right: 5px;
        }
        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        .chat-window {
            height: 340px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            background-color: #f9f9f9;
        }
        .chatbot-message {
            background: #d4f1c5; 
            margin: 8px 10px; 
            border-radius: 10px;
            padding: 5px 5px;
            position: relative;
            display: inline-block;
            max-width: 90%;
            font-size: 14px;
            margin: 10px 0;
            box-shadow: -2px 2px #20bc75;
            line-height: 1.2;
        }        
        .chatbot-message-container {
            position: relative;
            display: flex;
            align-items: top;
            flex-direction: column;
        }
        .chatbot-image {
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            position: absolute;
            top: -50px; 
        }
        .user-message {
            background-color:#d9edf7;
            color: black;
            box-shadow: -2px 2px black;
            padding: 5px 5px; 
            border-radius: 10px;
            margin: 8px 10px; 
            max-width: 90%;
            margin-right: auto; 
            line-height: 1.2;
            box-shadow: -2px 2px #179b5c;
            float: right;
        }
        #user-input {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
        }
        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
            background-color:whitesmoke;
        }        
        .chat-input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .chat-input-container button {
            margin-left: 10px;
            padding: 10px 15px;
            background-color:#20bc75;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .chat-input-container button:hover {
            background-color: #179b5c;
        }
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #20bc75;
            color: white;
            border: none;
            border-radius: 50px;
            width: auto;
            height: 50px;
            padding: 0 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-toggle-btn:hover {
            background-color: #179b5c;
        }
        .chat-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: transparent; 
        border: none; 
        border-radius: 50%; 
        width: 60px; 
        height: 60px; 
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0; }
        .chat-toggle-btn:hover {
            background-color: #179b5c;
        }
        #send-btn {
            margin-left: 10px;
            background-color:silver;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        #send-btn:hover {
            background-color:#179b5c;}
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap:2px;
        }
        .chatbot-button {
            background-color:#d4f1c5;
            color:black;
            border:none;
            border-radius:none;     
            margin: 5px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: -2px 2px #20bc75;
        }
        .chatbot-button-group {
            display: flex;
            flex-wrap: nowrap; 
            gap: 2px; 
        }       
            .chat-window::-webkit-scrollbar {
            width: 4px; 
            height: 4px; 
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color:silver;
            border-radius: 10px;
            background: transparent; 
        }
        .chat-window::-webkit-scrollbar-track {
            background: transparent; 
        }
        .chat-window:hover {
           overflow-y: auto;
            overflow-x: auto;
        }             
        .chat-window .message {
            margin-bottom: 5px; 
        }
        .message-wrapper {
            display: flex;
            align-items: center;
            width: 250px;
        }
        .message-wrapper > span {
            width: 200px;
        }
        .message-wrapper > span > a {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal; 
        }
        #header-title {
            color: white !important;
        }     
    </style>
</head>
<body>
    <button class="chat-toggle-btn" onclick="toggleChat()">
        <img src="https://storage.googleapis.com/testrig-bot-bucket/bot_pic.png" alt="Chat Toggle Button" style="height: 40px;border: radius 50px;">
    </button>   
        <div id="chat-container" class="chat-container">
            <div id="chat-header" class="chat-header">
                <div id="header-content" style="display: flex; align-items: center;">
                    <img src="https://storage.googleapis.com/testrig-bot-bucket/testrigLogo.png" alt="Bot Image" style="height: 20px; margin-right: 10px;width:80px">
                    <span id="header-title" style="color: white;"></span>
                </div>
                <div style="display: flex; align-items: center;">
                    <button onclick="toggleChat()" 
                        style="background: none; border: none; color: #fff; cursor: pointer; width: 25px;">‚úñ</button>
                </div>              
            </div>
            <div id="chat-content">
                <div id="chat-window" class="chat-window"></div>
                <div id="chat-input-container" class="chat-input-container">
                    <input type="text" id="user-input" placeholder="Type your messageüí¨">
                    <button id="send-btn" style="background: none; border: none; padding: 0; cursor: pointer;">
                        <img src="https://storage.googleapis.com/testrig-bot-bucket/send_icon.jpg" alt="Send" style="height: 30px; width: 30px;">
                    </button>
                </div>
            </div>
        </div>       
    </div>
    <script>
     let selectedService = "";  // Global variable to store service
     let user_name = "";
     let user_email="";
     let inactivityTimer;
     let hasReminderShown = false;
     let sessionID = 1; 
     let sessionData = {
        sessionID: sessionID,
        // name: "enquiry",
        email: "",
        timestamp: new Date().toISOString(),
    };

        function toggleChat() {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer.style.display === 'none' || chatContainer.style.display === '') {
                chatContainer.style.display = 'block';
            } else {
                chatContainer.style.display = 'none';
            }
        }
       
        function appendMessage(sender, message, messageClass) {
            const chatWindow = document.getElementById('chat-window');
            const formattedMessage = message.replace(/\n/g, '<br>');
            const messageElement = document.createElement('div');
            messageElement.classList.add(messageClass);

             if (sender === 'Testrig Bot') {
                messageElement.innerHTML = `
                 <div class="message-wrapper">
                    <img src="https://storage.googleapis.com/testrig-bot-bucket/i_logo.png" alt="Bot Image" style="height: 18px; margin-right: 10px;width:30px;">
                    <span>${formattedMessage}</span>
                 </div>`;
            } else 
            { 
            messageElement.innerHTML = `
               <div style="display: flex; align-items: center; justify-content: flex-end;">
                  <span style="margin-right: 10px;">${formattedMessage}</span>
                  <div style="background-color:#e7ffe7; border-radius: 50%; padding: 5px;">
                  <img src="https://storage.googleapis.com/testrig-bot-bucket/message.png" alt="User Image" style="height: 18px;">
                   </div>
                </div>`;}
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        window.onload = function () {
            const welcomeMessage = `Hiüëã,I am TestAlloy<br>How can I assist youüí¨?`;
            appendMessage('Testrig Bot', welcomeMessage, 'chatbot-message');

        // Add a delay before showing the next message and buttons
            setTimeout(() => {
                const followUpMessage = "Click the service,you are interested in‚ú®";
                appendMessage('Testrig Bot', followUpMessage, 'chatbot-message');
    
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
    
                const buttons = {
                 "AI-Powered Test Case Generation": "https://testalloy.com/testalloydemo/",
                 "Modern Test Management and Defect tracking": "https://testalloy.com/testalloydemo/",
                 "Release Management": "https://testalloy.com/testalloydemo/",          
                 "Automation Testing": "https://testalloy.com/testalloydemo/",
                 "Robust Security Testing": "https://testalloy.com/testalloydemo/",
                 "High-Performance Testing": "https://testalloy.com/testalloydemo/",
                 "Project Management Dashboard": "https://testalloy.com/testalloydemo/",
                 "Connect": "https://testalloy.com/testalloydemo/",                                 
                };

                Object.keys(buttons).forEach(buttonText => {
                    const button = document.createElement('button');
                    button.className = 'chatbot-button';
                    button.innerText = buttonText;
                    button.onclick = () => handleServiceClick(buttonText, buttons[buttonText]);
                    buttonContainer.appendChild(button);
                });
    
                document.getElementById('chat-window').appendChild(buttonContainer);
            }, 1000);
        };

   
    function handleServiceClick(service, link) {
        selectedService = service;  // Store service globally
        appendMessage('User', `üôãI am interested in ${service}.`, 'user-message');

        setTimeout(() => {
            const responseMessage = `Thank you for your interest in ${service}‚úÖ.<br>
            You can read more üîó <a href="${link}" target="_blank">${link}</a>`;
            appendMessage('Testrig Bot', responseMessage, 'chatbot-message');
            }, 500);

        setTimeout(() => {
            appendMessage('Testrig Bot', "May I know your email id‚úçÔ∏è?", 'chatbot-message');
        }, 2500);
        }
         // Handle user input
        document.getElementById('send-btn').onclick = function () {
            sendMessage();
        };

        document.getElementById('user-input').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
            sendMessage();
        }
        });

        function sendMessage() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) return;

            appendMessage('User', userInput, 'user-message');
            document.getElementById('user-input').value = '';

            if (!sessionData.email) {
                checkEmail(userInput);
                return;
            }
            if (!sessionData.username) {
                saveUserName(userInput);
                return;
            }

            sendToChatbot(userInput);
            }

        // Modify saveUserName function to include service
        function saveUserName(name) {
            fetch('/save_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name, 
                    email: sessionData.email, 
                    service_clicked_by_user: selectedService // Include service
                })
             })
            .then(response => response.json())
            .then(data => {
                sessionData.sessionID = data.session_id;
                sessionData.username = name;
                sessionData.service = selectedService; // Store service in session
                console.log("‚úÖ Username Set:", sessionData);
                appendMessage('Testrig Bot', data.response, 'chatbot-message');
            })
            .catch(error => console.error('Error:', error));
            }

    function checkEmail(email) {
        fetch('/get_session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                sessionData = {
                    sessionID: data.session_id,
                    email: email,
                    username: data.username || "Unknown"
                };
                console.log("‚úÖ Email Found:", sessionData);
                appendMessage('Testrig Bot', data.response, 'chatbot-message');
            } else {
                sessionData.email = email;
                console.log("‚ö†Ô∏è Email not found. Asking for username.");
                appendMessage('Testrig Bot', "Welcome to Testrig Technologies. Please share your Name:", 'chatbot-message');
                }
            })
        .catch(error => console.error('Error:', error));
        }

        
        // Send user input to chatbot
        function sendToChatbot(message) {
            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, sessionID: sessionData.sessionID })
            })
            .then(response => response.json())
            .then(data => {
                appendMessage('Testrig Bot', data.response, 'chatbot-message');
            })
            .catch(error => console.error('Error:', error));
        }  

        const chatInput = document.getElementById('user-input');
        chatInput.dataset.expectingName = true;
        chatInput.dataset.service = selectedService;
        resetInactivityTimer();

        // Monitor for page visibility change
       // let visibilityChangeEvent = 'visibilitychange';
        //if (typeof document.hidden !== "undefined") {
            //document.addEventListener(visibilityChangeEvent, () => {
               // if (document.hidden) {
                   // setTimeout(() => {
                       // if (document.hidden) {
                        //    alert("To continue to chatüí¨with us,please return to chatbotüìù.");
                      //  }
                   // }, 2000);  
                  //  }
               // });
          //  }     
        // Function to handle inactivity and show the reminder message
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
            if (!hasReminderShown) {  // Ensure message appears only once per inactivity period
                const reminderMessage = `üôèThank you for visiting usüòä,<br>
                Please read üìñblogs: <a href='https://www.testrigtechnologies.com/blogs/' target='_blank'>Blogs</a>.<br>
                üìäCase Studies: <a href='https://www.testrigtechnologies.com/case-study/' target='_blank'>Case Studies</a>.<br>
                üìÖFeel free to: <a href='https://www.testrigtechnologies.com/contact-us/' target='_blank'>Contact Us</a> for more details.`;

                appendMessage('Testrig Bot', reminderMessage, 'chatbot-message');
                hasReminderShown = true; // Set flag so it doesn't repeat
                }
            }, 60000); // 60 seconds inactivity
        }       
        
        // Ask for the user's name
        setTimeout(() => {
            const questions = "May,I know your name?";
            appendMessage('Testrig Bot', followUpQuestion, 'chatbot-message');
                }, 5000); 
                                              

    document.getElementById('send-btn').onclick = function () {
    const userInput = document.getElementById('user-input').value.trim();
    if (userInput) {
        appendMessage('User', userInput, 'user-message');
        document.getElementById('user-input').value = '';
        clearTimeout(inactivityTimer);
        hasReminderShown = false; 
        resetInactivityTimer();
        const chatWindow = document.getElementById('chat-window');
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'user-loading'; 

        // Create a button element for the loading spinner
        const loadingButton = document.createElement('button');
        loadingButton.className = 'buttonload';
        loadingButton.style.backgroundColor = '#d4f1c5; ';
        loadingButton.style.border = 'none';
        loadingButton.style.color = 'green';
        loadingButton.style.padding = '6px 12px';
        loadingButton.style.fontSize = '12px';
        loadingButton.style.display = 'block';
        loadingButton.style.marginBottom='40px';
        loadingButton.style.marginTop='40px';
        loadingButton.style.borderRadius = '10px';
        const loadingIcon = document.createElement('i');
        loadingIcon.className = 'fa fa-spinner fa-spin';
        loadingIcon.style.marginRight = '8px';
        loadingButton.appendChild(loadingIcon);
        loadingButton.appendChild(document.createTextNode('...'));
        loadingMessage.appendChild(loadingButton);
        chatWindow.appendChild(loadingMessage);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        let loadingTimeout = setTimeout(() => {
            loadingMessage.style.display = 'block';
        }, 4000); 

        // Initialize inactivity timer on page load
        resetInactivityTimer();

        // Send the user input to the server
        fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=${encodeURIComponent(userInput)}&sessionID=${sessionData.sessionID}`
        })
        .then(response => response.json())
        .then(data => {
            clearTimeout(loadingTimeout);
            loadingMessage.remove(); 
            const cleanedResponse = data.response.replace(/^A:/, '').trim();
            appendMessage('Testrig Bot', cleanedResponse, 'chatbot-message');
        })
        .catch(error => {
            console.error('Error:', error);
            clearTimeout(loadingTimeout);
            loadingMessage.remove();
            appendMessage('Testrig Bot', "An error occurred.Please try againüîÑ", 'chatbot-message');
        });
        }
        };
        

        // Function to show the full response when "Read More..." is clicked
        function showFullResponse(responseId) {
            const fullResponse = globalState.read_more_response[responseId];
            const responseElement = document.getElementById(responseId);

            if (responseElement && fullResponse) {
                responseElement.innerHTML = fullResponse;
                }
        }

        function showFullResponse(responseId) {
            const fullResponse = globalState["read_more_response"][responseId];
            const responseElement = document.getElementById(responseId);
    
            if (responseElement) {
                responseElement.innerHTML = fullResponse;
            }
        }
       
        function saveSessionData() {
        fetch('/save-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(sessionData),
        }).then(response => {
            if (!response.ok) {
                console.error('Failed to save session data.');
            }
        }).catch(error => {
            console.error('Error:', error);
        });
        }

        document.getElementById('user-input').addEventListener('focus', resetInactivityTimer);
        document.getElementById('user-input').addEventListener('input', resetInactivityTimer);
        document.getElementById('user-input').addEventListener('input', function () {
        if (this.dataset.expectingName) {
            sessionData.name = this.value || "enquiry"; 
        }
        });
        window.onbeforeunload = saveSessionData;
    </script>
    <!-- Fetch Event Source Polyfill -->
    <script src="https://unpkg.com/@microsoft/fetch-event-source@latest/dist/fetch-event-source.umd.min.js"></script>
</body>
</html>


========================


GOOGLE_APPLICATION_CREDENTIALS = config/service_account.json
google_api_key = ""


====================

==============


flask
google-cloud-storage
uuid
requests
flask_cors
google.generativeai
unstructured
langchain_community
flask_session
chromadb
mysql-connector-python
packages
gunicorn
click
python-dotenv
functions-framework
pytz
google-cloud-firestore

=================


## set up
from setuptools import setup, find_packages
setup(
    name='gemBot',
    version='0.1.0',
    packages=find_packages(),
    install_requires=[
        'flask',
        'google-cloud-storage',
        'uuid',
        'requests',
        'flask_cors',
        'google.generativeai',
        'unstructured',
        'langchain_community',
        'flask_session',
        'chromadb',
        'google-cloud-datastore',
        'packages',
        'gunicorn',
        'click',
        'python-dotenv',
        'mysql-connector-python',
        'functions-framework',
        'pytz',
        'google-cloud-firestore'
    ],
    author='Testrig',
    description='TestrigBot',
    url='https://github.com/TestrigTechnologies/poc_chatbot.git',
    classifiers=[
        'Programming Language :: Python :: 3',
        'License :: OSI Approved :: MIT License',
        'Operating System :: OS Independent',
    ],
    python_requires='>=3.9',
)


====================================================




# Use an official Python runtime as a parent image

FROM python:3.9
 
# Set the working directory in the container

WORKDIR /app
 
# Copy only requirements first (to leverage Docker cache)

COPY requirements.txt /app/
 
# Install dependencies

RUN pip install --no-cache-dir -r requirements.txt
 
# Copy the rest of the application files

COPY . /app
 
# Expose the port your app runs on

EXPOSE 8080
 
# Ensure Python outputs logs in real-time

ENV PYTHONUNBUFFERED=1
 
# Run the application

# CMD ["python3", "main.py"]
CMD ["gunicorn", "--bind", "0.0.0.0:8080", "app:app"]

 ==============================


<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testrig Bot</title>
    <link rel="stylesheet" href="test.css">
</head>
<body>
    <script src="s.js" ></script>      
</body>
</html>
=================


const userDetails = [];
let stopVisibilityAlert = false;
let sessionDataSaved = false;
let emailPromptTriggered = false;
let inactivityTimer;
let reminderMessageDisplayed = false;
let userName = null;
let userEmail = null;
let sessionId = generateSessionId();
let sessionTimestamp = new Date().toISOString();
let expectingEmail = false;
let expectingName = false;
let hasReminderShown = false;
let chatOpenedBefore = false;
let selectedService = null;
let inactivityMessageShown = false;
let invalidNameAttempts = 0;
let invalidEmailAttempts = 0;
let emailTimeoutTimer;
let nameTimeoutTimer;

const link = document.createElement('link');
link.rel = 'stylesheet';
link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css'; 
document.head.appendChild(link);

let emailPromptTimer = null;
let namePromptTimer = null;
let finalGreetingTimer = null;
let inactivityAlertTimer = null;
let lastActivityTime = Date.now();
let serviceButtonClicked = false;

function generateSessionId() {
    return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// Update last activity time
function updateActivity() {
    lastActivityTime = Date.now();
    
    // Reset the inactivity message flag when user is active
    inactivityMessageShown = false;
    
    // Reset inactivity timer
    if (inactivityAlertTimer) {
        clearTimeout(inactivityAlertTimer);
    }
    
    // Set 4 mins inactivity timer
    inactivityAlertTimer = setTimeout(() => {
        showInactivityAlert();
    }, 240000); 
}

function showInactivityAlert() {
    // Check if the inactivity message has already been shown
    if (inactivityMessageShown) {
        return; 
    }
    
    // Mark that the inactivity message has been shown
    inactivityMessageShown = true;
    
    showTypingIndicator();
    setTimeout(() => {
        hideTypingIndicator();
        addBotMessage('Hi, Are u still there?<br>Connect with us:<br><a href="mailto:info@testrigtechnologies.com">info@testrigtechnologies.com</a><br>');
    }, 1000);
}

// Clear all timers
function clearAllTimers() {
    if (emailPromptTimer) clearTimeout(emailPromptTimer);
    if (namePromptTimer) clearTimeout(namePromptTimer);
    if (finalGreetingTimer) clearTimeout(finalGreetingTimer);
    if (inactivityAlertTimer) clearTimeout(inactivityAlertTimer);
}

document.addEventListener("DOMContentLoaded", function () {
    initializeChatbot();
    updateActivity(); 
});

function initializeChatbot() {
    // Create chat toggle button
    let chatButton = document.createElement("button");
    chatButton.id = "abchat-toggle-btn";
    chatButton.className = "abchat-toggle-btn";
    chatButton.innerHTML = `<img src="https://testalloyas.web.app/pic_botss.avif" alt="Chat">`;
    chatButton.onclick = toggleChat;
    document.body.appendChild(chatButton);

    // Create chat container
    let chatContainer = document.createElement("div");
    chatContainer.id = "abchat-container";
    chatContainer.className = "abchat-container";
    chatContainer.style.display = "none";
    chatContainer.innerHTML = `
        <div class="abchat-header">
            <div style="display: flex; align-items: center;">
                <img src="https://chat-bot-project-781b9.web.app/testrigLogos.png" alt="Testrig">
                <span id="header-title"></span>
            </div>
            <div class="header-buttons">
                <button id="refresh-chat-btn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="close-chat-btn" class="close-btn">√ó</button>
            </div>
        </div>
        <div id="abchat-window" class="abchat-window"></div>
        <div class="chat-input-container">
            <div class="abinput-wrapper">
                <textarea id="abuser-input" placeholder="Type here..." rows="1"></textarea>
                <button id="absend-btn">
                    <img src="https://chat-bot-project-781b9.web.app/send-button-testrig.png" alt="Send">
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(chatContainer);
    setupEventListeners();
}

function setupEventListeners() {
    // Close button
    document.getElementById("close-chat-btn").addEventListener("click", function () {
        document.getElementById("abchat-container").style.display = "none";
        document.getElementById("abchat-toggle-btn").style.display = "block";
        updateActivity();
    });

    // Refresh button
    document.getElementById("refresh-chat-btn").addEventListener("click", function () {
        refreshChat();
        updateActivity();
    });

    // Send button
    document.getElementById('absend-btn').addEventListener('click', () => {
        sendMessage();
        updateActivity();
    });

    // Enter key
    document.getElementById('abuser-input').addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
            updateActivity();
        }
    });

    // Auto-resize textarea
    document.getElementById('abuser-input').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        updateActivity();
    });
}

function toggleChat() {
    const chatContainer = document.getElementById("abchat-container");
    const chatButton = document.getElementById("abchat-toggle-btn");

    updateActivity();
    
    if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
        chatContainer.style.display = "block";
        chatButton.style.display = "none";

        if (!chatOpenedBefore) {
            setTimeout(() => {
                showWelcomeMessage();
            }, 300);
            chatOpenedBefore = true;
        }
    } else {
        chatContainer.style.display = "none";
        chatButton.style.display = "block";
    }
}

// function refreshChat() {
//     // Clear all timers
//     clearAllTimers();
    
//     // Clear chat window
//     document.getElementById('abchat-window').innerHTML = '';
    
//     // Reset all variables
//     emailPromptTriggered = false;
//     expectingEmail = false;
//     expectingName = false;
//     userName = null;
//     userEmail = null;
//     sessionId = generateSessionId();
//     serviceButtonClicked = false;
//     chatOpenedBefore = false;
    
//     // Clear input
//     document.getElementById('abuser-input').value = '';
    
//     // Show welcome message again
//     setTimeout(() => {
//         showWelcomeMessage();
//      }, 300);
// }


function refreshChat() {
    // Clear all timers
    clearAllTimers();
    
    // Clear chat window
    document.getElementById('abchat-window').innerHTML = '';
    
    // Reset all variables including the new flag
    emailPromptTriggered = false;
    expectingEmail = false;
    expectingName = false;
    userName = null;
    userEmail = null;
    sessionId = generateSessionId();
    serviceButtonClicked = false;
    chatOpenedBefore = false;
    inactivityMessageShown = false; 
    
    // Clear input
    document.getElementById('abuser-input').value = '';
    
    // Show welcome message again
    setTimeout(() => {
        showWelcomeMessage();
     }, 300);
}

function showWelcomeMessage() {
    // Show typing indicator first
    showTypingIndicator();
    
    setTimeout(() => {
        hideTypingIndicator();
        
        // Create welcome message container
        const welcomeContainer = document.createElement('div');
        welcomeContainer.className = 'bot-message-container';
        
        // Greeting message
        const greetingDiv = document.createElement('div');
        greetingDiv.className = 'bot-greeting';
        greetingDiv.innerHTML = 'Hiüëã, I am Tesi';
        
        // Response message
        const responseDiv = document.createElement('div');
        
        welcomeContainer.appendChild(greetingDiv);
        welcomeContainer.appendChild(responseDiv);
        
        document.getElementById('abchat-window').appendChild(welcomeContainer);
        scrollToBottom();
        
        // Show services after delay
        setTimeout(() => {
            showServices();
        }, 1000);
    }, 1000);
}

function showServices() {
    const services = {
        "Performance Testing": "https://www.testrigtechnologies.com/performance-testing/",
        "Mobile App Testing": "https://www.testrigtechnologies.com/mobile-app-testing/",
        "Automation Testing": "https://www.testrigtechnologies.com/automation-testing/",
        "Security Testing": "https://www.testrigtechnologies.com/security-testing/",
        "Web App Testing": "https://www.testrigtechnologies.com/web-app-testing/",
        "AI/ML Testing": "https://www.testrigtechnologies.com/ai-ml-testing/",
        "API Testing": "https://www.testrigtechnologies.com/api-testing/",
        "Partnerships": "https://www.testrigtechnologies.com/about-us/",
        "Jobs/Careers": "https://www.testrigtechnologies.com/careers/",
        "Connect/Inquiry": "https://www.testrigtechnologies.com/about-us/"
    };

    // Show typing indicator
    showTypingIndicator();
    
    setTimeout(() => {
        hideTypingIndicator();
        
        // Create services message
        const servicesContainer = document.createElement('div');
        servicesContainer.className = 'bot-message-container';
        
        const selectServiceDiv = document.createElement('div');
        selectServiceDiv.className = 'bot-response';
        selectServiceDiv.innerHTML = 'What are you looking for?';
        
        servicesContainer.appendChild(selectServiceDiv);
        
        // Create services grid
        const servicesGrid = document.createElement('div');
        servicesGrid.className = 'services-container';
        
        const gridContainer = document.createElement('div');
        gridContainer.className = 'services-grid';
        
        Object.keys(services).forEach(service => {
            const button = document.createElement('button');
            button.className = 'service-btn';
            button.innerText = service;
            button.onclick = () => handleServiceClick(service, services[service]);
            gridContainer.appendChild(button);
        });
        
        servicesGrid.appendChild(gridContainer);
        servicesContainer.appendChild(servicesGrid);
        
        document.getElementById('abchat-window').appendChild(servicesContainer);
        scrollToBottom();

        // Start timer for email prompt if no service is clicked (60 seconds)
        emailPromptTimer = setTimeout(() => {
            if (!serviceButtonClicked && !emailPromptTriggered) {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage('Please share your Email Id.');
                    emailPromptTriggered = true;
                    expectingEmail = true;
                    
                    // Start timer for name prompt if no email is entered (60 seconds)
                    namePromptTimer = setTimeout(() => {
                        if (expectingEmail && !userEmail) {
                            showTypingIndicator();
                            setTimeout(() => {
                                hideTypingIndicator();
                                addBotMessage('Welcome to Testrig Technologies.');
                                
                                setTimeout(() => {
                                    showTypingIndicator();
                                    setTimeout(() => {
                                        hideTypingIndicator();
                                        addBotMessage('May I know your name?');
                                        expectingEmail = false;
                                        expectingName = true;
                                        
                                        // Start timer for final greeting if no name is entered (60 seconds)
                                        finalGreetingTimer = setTimeout(() => {
                                            if (expectingName && !userName) {
                                                showTypingIndicator();
                                                setTimeout(() => {
                                                    hideTypingIndicator();
                                                    addBotMessage('Hi, Please Feel free to chat with us.');
                                                    expectingName = false;
                                                }, 1000);
                                            }
                                        }, 60000); 
                                    }, 500);
                                }, 500);
                            }, 500);
                        }
                    }, 60000); 
                }, 500);
            }
        }, 60000);
    }, 500);
}

function handleServiceClick(service, link) {
    serviceButtonClicked = true;
    
    // Clear the email prompt timer since user clicked a service
    if (emailPromptTimer) {
        clearTimeout(emailPromptTimer);
    }
    
    updateActivity();
    
    // Add user message
    addUserMessage(`I am interested in ${service}.`);
    
    // Show typing indicator
    showTypingIndicator();
    selectedService = service; 
    serviceButtonClicked = true;
    setTimeout(() => {
        hideTypingIndicator();
        addBotMessage(`We appreciate your interest in ${service}<br>Visit Us üîó <a href="${link}" target="_blank" style="color: #667eea ;">${service}</a>`);
        
        if (!emailPromptTriggered) {
            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage('Please share your Email Id.');
                    expectingEmail = true;
                    emailPromptTriggered = true;
                }, 500);
            }, 500);
        }
    }, 500);
}

async function sendMessage() {
    const userInput = document.getElementById('abuser-input');
    const message = userInput.value.trim();
    
    if (message === "") return;
    
    addUserMessage(message);
    userInput.value = '';
    userInput.style.height = 'auto';
    
    // Handle different types of input
    if (expectingEmail) {
        handleEmailInput(message);
    } else if (expectingName) {
        handleNameInput(message);
    } else {
        await handleGeneralMessage(message);
    }
}

function handleEmailInput(email) {
    clearTimeout(emailTimeoutTimer);

    if (validateEmail(email)) {
        userEmail = email;
        expectingEmail = false;
        invalidEmailAttempts = 0;

        showTypingIndicator();
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage('Welcome to Testrig Technologies.');

            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage('May I know your name?');
                    expectingName = true;

                    nameTimeoutTimer = setTimeout(() => {
                        if (expectingName && !userName) {
                            showTypingIndicator();
                            setTimeout(() => {
                                hideTypingIndicator();
                                addBotMessage('Hi, Please Feel free to chat with us.');
                                expectingName = false;
                            }, 1000);
                        }
                    }, 120000); 
                }, 400);
            }, 500);
        }, 400);
    } else {
        invalidEmailAttempts++;

        showTypingIndicator();
        setTimeout(() => {
            hideTypingIndicator();

            if (invalidEmailAttempts >= 3) {
                addBotMessage('You did not shared a valid Email Id.');
                addBotMessage('Welcome to Testrig Technologies.');

                setTimeout(() => {
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addBotMessage('May I know your name?');
                        expectingEmail = false;
                        expectingName = true;

                        nameTimeoutTimer = setTimeout(() => {
                            if (expectingName && !userName) {
                                showTypingIndicator();
                                setTimeout(() => {
                                    hideTypingIndicator();
                                    addBotMessage('Hi, Please Feel free to chat with us.');
                                    expectingName = false;
                                }, 1000);
                            }
                        }, 120000); // 120 sec
                    }, 1000);
                }, 1000);
            } else {
                addBotMessage('Your details are secured with usüîí<br>Please share a valid Email Id.');
                expectingEmail = true;

                emailTimeoutTimer = setTimeout(() => {
                    if (expectingEmail && !userEmail) {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addBotMessage('Welcome to Testrig Technologies.');

                            setTimeout(() => {
                                showTypingIndicator();
                                setTimeout(() => {
                                    hideTypingIndicator();
                                    addBotMessage('May I know your name?');
                                    expectingEmail = false;
                                    expectingName = true;

                                    nameTimeoutTimer = setTimeout(() => {
                                        if (expectingName && !userName) {
                                            showTypingIndicator();
                                            setTimeout(() => {
                                                hideTypingIndicator();
                                                addBotMessage('Hi, Please Feel free to chat with us.');
                                                expectingName = false;
                                            }, 1000);
                                        }
                                    }, 120000);
                                }, 200);
                            }, 200);
                        }, 200);
                    }
                }, 120000); 
            }
        }, 200);
    }
}



// function checkTestAlloyAndFAQ(message) {
//     const lower = message.toLowerCase();

//     const faqData = [
//         {
//             keywords: ["testalloy", "test alloy", "testrig product", "testrig software"],
//             response: "Yes, TestAlloy is a Testing Software Product of Testrig Technologies developed to provide End to End Testing Solutions with features like AI-Powered Test Case Generation, Modern Test Management and Defect tracking, Release Management, Project Management Dashboard."
//         },
//         {
//             keywords: ["security testing", "security test"],
//             response: "Yes, we offer Security testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/security-testing/' target='_blank'>Security Testing</a><br>"
//         },
//         {
//             keywords: ["Automation Testing", "Automation test"],
//             response: "Yes, we offer Security testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/automation-testing/' target='_blank'>Automation Testing</a><br>"
//         },
//         {
//             keywords: ["Mobile App Testing", "Mobile test","Mobile App Test","Mobile Testing"],
//             response: "Yes, we offer Security testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/mobile-app-testing/' target='_blank'>Mobile App Testing</a><br>"
//         },
//         {
//             keywords: ["Web App Testing", "Web test","Web App Test","Web Testing"],
//             response: "Yes, we offer Security testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/web-app-testing/' target='_blank'>Web App Testing</a><br>"
//         },
//         {
//             keywords: ["ai/ml testing", "ai ml testing", "artificial intelligence testing", "machine learning testing"],
//             response: "Yes, we offer AI/ML testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/ai-testing-services/' target='_blank'>AI/ML Testing</a><br>"
//         },
//         {
//             keywords: ["api testing", "api test"],
//             response: "Yes, we offer API Testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/api-testing/' target='_blank'>API Testing</a><br>"
//         },
//         {
//             keywords: ["performance testing", "performance test"],
//             response: "Yes, we offer Performance Testing services.<br>You can visit us: <a href='https://www.testrigtechnologies.com/performance-testing/' target='_blank'>Performance Testing</a><br>"
//         },
//         {
//             keywords: ["training", "in-house testing teams", "team training"],
//             response: "Absolutely, We prioritize the professional development of our in-house testing teams through structured training sessions and practical learning modules.<br>Our management team curates targeted courses designed to upskill team members while tracking their progress to ensure consistent growth and excellence."
//         },
//         {
//             keywords: ["contact", "how to contact", "reach testrig","connect","reach","meet","enquiry","sure","ok"],
//             response: `You can connect with us through the following channels:<br>
//                 1 Schedule a meeting directly with our team: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>
//                 2 Mail us:<a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>
//                 3 Submit your inquiry via our contact form: <a href='https://www.testrigtechnologies.com/contact-us/' target='_blank'>Contact Us</a>`
//         },
//         {
//             keywords: ["sure", "thank u", "team training","ok"],
//             response: "Absolutely, We prioritize the professional development of our in-house testing teams through structured training sessions and practical learning modules.<br>Our management team curates targeted courses designed to upskill team members while tracking their progress to ensure consistent growth and excellence."
//         },

//         {
//             keywords: ["reporting process", "reporting", "reports"],
//             response: `We maintain a clear and transparent reporting process:<br>
//                 1.Daily Updates: Detailed test execution reports shared regularly. <br>
//                 2.Collaborative Calls: Essential calls with development teams to address blockers and align on progress. <br>
//                 3.Custom Reports: Tailored reporting formats to meet client-specific requirements, providing actionable insights. <br>
//                 We believe "on connect" on a daily basis as per need.`
//         },
        
//     {
//         keywords: ["ecommerce testing case study", "case study ecommerce", "ecommerce testing services case study", "testing services ecommerce domain"],
//         response: "Yes, we offer Testing services for Ecommerce,<br>You can visit our services here: <a href='https://www.testrigtechnologies.com/case-study/elevating-user-experience-and-functionality-test-automation-implementation-for-a-global-b2b-e-commerce-company/' target='_blank'>Ecommerce Testing Services Case Study</a><br>"
//     },
//     {
//         keywords: ["client speaks", "success stories", "testimonials", "customer feedback"],
//         response: "Yes, you can find case studies and testimonials here: <a href='https://www.testrigtechnologies.com/testimonials/' target='_blank'>Testimonials</a><br>"
//     },
//     {
//         keywords: ["automation testing tools", "tools for automation testing", "testrig automation tools"],
//         response: `At Testrig Technologies, we leverage a variety of advanced tools for efficient automation testing, including:<br>
//             Selenium, Cypress, Playwright, Appium, Postman, Jest, JUnit, TestNG, Katalon Studio, Ranorex, Jenkins.<br>
//             Explore our automation testing services: <a href='https://www.testrigtechnologies.com/' target='_blank'>Explore our Services</a>`
//     },
//     {
//         keywords: ["security testing tools", "tools for security testing", "testrig security tools"],
//         response: `Testrig Technologies uses the following tools for security testing:<br>
//             OWASP ZAP, Burp Suite, Nmap, Metasploit.<br>
//             For more details, visit: <a href='https://www.testrigtechnologies.com/security-testing/' target='_blank'>Security Testing Services</a><br>`
//     },
//     {
//         keywords: ["mobile testing tools", "tools for mobile application testing", "testrig mobile testing tools"],
//         response: `Testrig Technologies uses tools like Appium, Robot Framework, Katalon Studio, BrowserStack, AWS Device Farm.<br>
//             For more details, visit: <a href='https://www.testrigtechnologies.com/mobile-app-testing/' target='_blank'>Mobile App Testing Services</a><br>`
//     },
//     {
//         keywords: ["performance testing tools", "tools for performance testing", "testrig performance testing tools"],
//         response: `Testrig Technologies uses tools like JMeter, LoadRunner, Locust, LoadNinja, K6, BlazeMeter.<br>
//             For more details visit: <a href='https://www.testrigtechnologies.com/performance-testing/' target='_blank'>Performance Testing Services</a><br>`
//     },
//     {
//         keywords: ["qa services", "testing services", "what qa services", "testrig qa offerings"],
//         response: `Testrig Technologies delivers a wide range of QA services:<br>
//             Automation Testing, Security Testing, Mobile Testing, Performance Testing, Web Testing, Functional and Non-Functional Testing.<br>
//             Explore our Services: <a href='https://www.testrigtechnologies.com/' target='_blank'>Explore our Services</a>`
//     },
//     {
//         keywords: ["what is testrig", "testrig technologies", "about testrig","Testrig Tech","Testrig Tech","testrig excels","testrig uniqueness","testrig famous","your company excells","your company famous for"],
//         response: `Testrig Technologies is a premier software testing and QA firm specializing in comprehensive end-to-end testing solutions.<br>
//             Ensuring the reliability, scalability, and security of software applications for digital transformation.`
//     },
//     {
//         keywords: ["ceo of testrig", "founder of testrig", "who is parimal kumar","testrig ceo","chairperson of testrig", "testrig owner", "owner of testrig technologies"],
//         response: `Parimal Kumar, the CEO and Founder of Testrig Technologies, is a dynamic leader in Software Testing and QA.<br>
//             Connect with him on LinkedIn: <a href='https://www.linkedin.com/in/parimalkr/' target='_blank'>Connect on LinkedIn</a>`
//     },
//     {
//         keywords: ["testimonials", "use cases", "client success stories", "success stories","client speak"],
//         response: `Yes, we have client testimonials available on our website. Here's the link: <a href='https://www.testrigtechnologies.com/testimonials/' target='_blank'>Explore our Testimonials</a>`
//     },
//     {
//         keywords: ["mission of testrig", "testrig mission", "vision of testrig"],
//         response: `Testrig Technologies is dedicated to delivering exceptional software testing services that empower organizations to build robust, reliable, and secure software products.`
//     },
//     {
//         keywords: ["core values of testrig", "values of testrig", "testrig core values"],
//         response: `Customer Centric, Trust, Continuous Learning, Ownership, Team Work are core values of Testrig Technologies.`
//     },
//     {
//         keywords: ["foundation day of testrig", "testrig founding date", "testrig started"],
//         response: `Testrig Technologies was founded on 15 Oct,2015 by Parimal Kumar.<br>Connect: <a href='https://www.linkedin.com/in/parimalkr/' target='_blank'>Connect on LinkedIn</a>`
//     },
//     {
//         keywords: ["testing duration", "how long does testing take", "duration of qa services"],
//         response: `The duration of testing varies by complexity and scope.<br>Schedule a meeting: <a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>`
//     },
//     {
//         keywords: ["Job", "Jobs", "Career", "Careers"],
//         response: "You can visit: <a href='https://www.testrigtechnologies.com/careers/' target='_blank'>Careers</a><br>"
//     },
//     {
//         keywords: ["cost of testing", "costs to test", "price", "Amount"],
//         response: " Testrig Technologies delivers a wide range of QA services:Automation Testing, Security Testing, Mobile Testing, Performance Testing, Web Testing,Functional and Non-Functional Testing.<a href='https://www.testrigtechnologies.com/about-us/' target='_blank'>About Us</a><br>"
//     },

//     ];

//     for (const faq of faqData) {
//         if (faq.keywords.some(keyword => lower.includes(keyword))) {
//             return { handled: true, response: faq.response };
//         }
//     }

//     return { handled: false, response: '' };
// }
// function handleNameInput(name) {
//     if (isValidName(name)) {
//         userName = formatName(name);
//         expectingName = false;
        
//         showTypingIndicator();
//         setTimeout(() => {
//             hideTypingIndicator();
//             addBotMessage(`Hello ${userName}, Feel free to chat with us.`);
            
//             // Save user details to Firestore after getting both email and name
//             if (userName && userEmail && !sessionDataSaved) {
//                 const service = selectedService || "General Inquiry";
//                 saveUserInputToFirestore(service, userEmail, userName);
//                 sessionDataSaved = true;
//             }
//         }, 500);
//     } else {
//         showTypingIndicator();
//         setTimeout(() => {
//             hideTypingIndicator();
//             addBotMessage('Please enter a valid name with only alphabets (min 2 letters per word)');
//             expectingName = true;
//         }, 1000);
//     }
// }

    const services = {
        "automation testing": "https://www.testrigtechnologies.com/automation-testing/",
        "security testing": "https://www.testrigtechnologies.com/security-testing/",
        "mobile app testing": "https://www.testrigtechnologies.com/mobile-app-testing/",
        "ai/ml testing": "https://www.testrigtechnologies.com/ai-ml-testing/",
        "performance testing": "https://www.testrigtechnologies.com/performance-testing/",
        "api testing": "https://www.testrigtechnologies.com/api-testing/",
        "web app testing": "https://www.testrigtechnologies.com/web-app-testing/",
        "hire qa tester": "https://www.testrigtechnologies.com/hire-qa-tester/",
        "partnership": "https://www.testrigtechnologies.com/about-us/",
        "connect": "https://www.testrigtechnologies.com/about-us/",
        "inquiry": "https://www.testrigtechnologies.com/about-us/",
        "jobs": "https://www.testrigtechnologies.com/about-us/",
        "portals": "https://www.testrigtechnologies.com/about-us/"
    };

    

    function checkOtherTestingKeywords(message) {
    const lowerInput = message.toLowerCase().trim();

    const otherTestingKeywords = [
        "a/b testing", "ab testing", "split testing", "continuous testing", "continous testing",
        "hypothesis testing", "usability testing", "penetration testing",
        "iot testing", "cloud testing", "rpa testing", "agile testing","data testing",
        "big data testing", "ml testing", "gen ai testing", "llm model testing",
        "api automation testing"
    ];

    for (const keyword of otherTestingKeywords) {
        const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        if (regex.test(lowerInput)) {
            return true;
        }
    }
    return false;
}


async function handleGeneralMessage(message) {
    showTypingIndicator();

    const lower = message.toLowerCase();
    let handled = false;

    // Partnership/Outsourcing check
    if (checkPartnershipOrOutsourcing(message)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`We would be delighted to explore a business opportunity with you.<br>Mail us for more details:<br><a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br><a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>`);
        }, 1000);
        return; 
    }   

    // Check other testing keywords
    if (checkOtherTestingKeywords(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`We do offer this service.<br>Please feel free to mail us for more details.<br><a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br><a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>`);
        }, 1000);
        handled = true;
    }
    // Greeting check
    else if (isGreeting(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`Greetingsüéâ, How can I assist you?`);
        }, 1000);
        handled = true;
    }

   
    else if (isContact(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`You can connect with us through the following channels:<br>
            <a href=\"https://www.testrigtechnologies.com/contact-us/\" target=\"_blank\">Contact Us</a><br>
            <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>`);
        }, 1000);
        handled = true;
    }

    else if (isCareer(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`You can connect with us through the following channels:<br>
            <a href=\"https://www.testrigtechnologies.com/careers/\" target=\"_blank\">Careers</a><br>
            <a href='mailto:careers@testrigtechnologies.com'>careers@testrigtechnologies.com</a><br>`);
        }, 1000);
        handled = true;
    }


    else if (isbusiness(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`Testrig Technologies is a premier software testing and quality assurance firm specializing in comprehensive end-to-end testing solutions.<br>Testrig ensures the reliability, scalability, and security of software applications.<br>The company excels in delivering high-quality services across web and mobile application testing, API validation, performance testing and security testing, empowering organizations to achieve seamless digital transformation while optimizing their time-to-market and operational efficiency.`);
        }, 1000);
        handled = true;
    }
    else if (isservices(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`Testrig Technologies is a premier software testing and quality assurance firm specializing in comprehensive end-to-end testing solutions.<br>The company excels in delivering high-quality services across web and mobile application testing,Automation Testing, API validation, performance Testing, and security testing,AI/ML Testing and other Testing services.`);
        }, 1000);
        handled = true;
    }


    
    // Thankful response
    else if (isThankful(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`You are welcomeüôè<br>Connect with us:<br><a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>`);
        }, 1000);
        handled = true;
    }

    // Thankful response
    else if (iswords(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`Thanks, Connect with us: <br><a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>`);
        }, 1000);
        handled = true;
    }

    // Exit/info response
    else if (isExitOrInfoRequest(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`See You Soon.<br>
                Connect with us <br>
                <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>
                `);
        }, 1000);
        handled = true;
    }
    // Case Study check
    else if (checkCaseStudyQuery(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`We have numerous Case studies on various tools and frameworks. Please explore: <br><a href="https://www.testrigtechnologies.com/case-study/" target="_blank">Testrig Technologies Case Studies</a>`);
        }, 1000);
        handled = true;
    }
    // Testimonials check
    else if (checkTestimonials(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`We have numerous success stories,Please explore:<br><a href="https://www.testrigtechnologies.com/testimonials/" target="_blank">Testrig Technologies Testimonials</a>`);
        }, 1000);
        handled = true;
    }
    // Techbot identity
    else if (isTechbotQuery(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`We are Testrig Technologies providing all types Software Testing Solutions.<br>
                Please visit:<br>
                <a href="https://www.testrigtechnologies.com/blogs/" target="_blank">Blogs</a><br>
                <a href="https://www.testrigtechnologies.com/case-study/" target="_blank">Case Studies</a><br>
                <a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>`);
        }, 1000);
        handled = true;
    }
    // HTML/Code content
    else if (!handled && containsHtmlOrCode(lower)) {
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`
                Please query about Testrig Technologies.<br>We are happy to assist.<br>
                Please visit:<br>
                <a href="https://www.testrigtechnologies.com/blogs/" target="_blank">Blogs</a><br>
                <a href="https://www.testrigtechnologies.com/contact-us/" target="_blank">Contact Us</a>
            `);
        }, 1000);
        handled = true;
    }
    // Out-of-context filter
    // else if (isOutofContext(lower)) {
    //     setTimeout(() => {
    //         hideTypingIndicator();
    //         addBotMessage(`We are happy to assist.<br>
    //             Please query related to Testrig Technologies.<br>
    //             <a href="https://www.testrigtechnologies.com/blogs/" target="_blank">Visit Blogs</a><br>
    //             <a href="https://www.testrigtechnologies.com/case-study/" target="_blank">Case Studies</a><br>
    //             <a href='mailto:info@testrigtechnologies.com'>info@testrigtechnologies.com</a><br>`);
    //     }, 1000);
    //     handled = true;
    // }

    if (!handled) {
        try {
            console.log('Sending unhandled message to API:', message); 
            
            const apiEndpoint = "https://chatbot-testrigs-61875479783.us-central1.run.app/ask";
            const response = await fetch(apiEndpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: message,
                    userName: userName || "Anonymous",
                    userEmail: userEmail || "No email provided",
                    sessionID: sessionId
                })
            });

            if (response.ok) {
                const data = await response.json();
                hideTypingIndicator();
                addBotMessage(data.response);

                // Log user details for API calls
                logUserDetails();

                if (data.response.includes("please share your Email Id")) {
                    expectingEmail = true;
                }
            } else {
                throw new Error(`API request failed with status: ${response.status}`);
            }
        } catch (error) {
            console.error('Server is busy:', error);
            hideTypingIndicator();
            addBotMessage('Server is busy. Please try again later.');
        }
    }
}

function addUserMessage(message) {
    const chatWindow = document.getElementById('abchat-window');
    const messageContainer = document.createElement('div');
    messageContainer.className = 'user-message-container';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'user-message';
    messageDiv.innerHTML = message;
    
    messageContainer.appendChild(messageDiv);
    chatWindow.appendChild(messageContainer);
    scrollToBottom();
}

function addBotMessage(message) {
    const chatWindow = document.getElementById('abchat-window');
    const messageContainer = document.createElement('div');
    messageContainer.className = 'bot-message-container';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'bot-response';
    messageDiv.innerHTML = message;
    
    messageContainer.appendChild(messageDiv);
    chatWindow.appendChild(messageContainer);
    scrollToBottom();
}

function showTypingIndicator() {
    const chatWindow = document.getElementById('abchat-window');
    const typingContainer = document.createElement('div');
    typingContainer.className = 'typing-indicator';
    typingContainer.id = 'typing-indicator';
    
    const typingDots = document.createElement('div');
    typingDots.className = 'typing-dots';
    typingDots.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    `;
    
    typingContainer.appendChild(typingDots);
    chatWindow.appendChild(typingContainer);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    const chatWindow = document.getElementById('abchat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Utility functions
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function isValidName(name) {
    const nameParts = name.trim().split(/\s+/);
    return nameParts.every(part => /^[A-Za-z]{2,}$/.test(part));
}

function formatName(name) {
    return name
        .trim()
        .split(/\s+/)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}


// Function to check for out-of-context (non-Testrig) queries


// Log user details array to console
function logUserDetails() {
    console.log("======= User Details =======");
    console.log("Current sessionId:", sessionId);
    console.log("User Email:", userEmail || "No email provided");
    console.log("User Name:", userName || "No name provided");
    console.log("Session Timestamp:", sessionTimestamp);
    console.log("============================");
    
    // Add to userDetails array if not already present
    const existingEntry = userDetails.find(item => item.sessionId === sessionId);
    if (!existingEntry) {
        userDetails.push({
            sessionId: sessionId,
            userEmail: userEmail,
            userName: userName,
            timestamp: sessionTimestamp
        });
    }
    
    console.log("Updated user details array:", userDetails);
}

// Save user details to Firestore
async function saveUserInputToFirestore(service, email, name) {
    const data = {
        name: name,
        email: email,
        service_clicked_by_user: service,
        sessionId: sessionId,
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch("https://chatbot-testrigs-61875479783.us-central1.run.app/save_session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok) {
            console.log("Session saved to Firestore:", result);
            if (result.session_id) {
                sessionId = result.session_id;
            }
            
            // Log user details after successful save
            logUserDetails();
        } else {
            console.error("Error saving session to Firestore:", result.error);
        }
    } catch (err) {
        console.error("Firestore save error:", err);
    }
}


function checkTestimonials(input) {
    const lower = input.toLowerCase();
    return lower.includes("testimonials") || lower.includes("testimonial") || lower.includes("testrig success stories") ||
        lower.includes("success stories") || lower.includes("success story") ||
        lower.includes("successstories") || lower.includes("client speaks") ||
        lower.includes("client testimonials") || lower.includes("clients testimonial");
}


function isOutofContext(message) {
    const outContextKeywords = [
        "travel", "match", "dance", "games", "country", "weather", "decorations", "home", "offices",
        "feelings", "hacking", "any sports activities", "colleges", "politician", "rain", "car", "bus",
        "swimming", "transport", "any vehicles", "painting", "profession", "driving", "riding",
        "dresses", "shoes", "beauty products", "stationery", "schools", "ploitics", "celebrity"
    ];
    return outContextKeywords.some(keyword => message.toLowerCase().includes(keyword));
}

function containsHtmlOrCode(message) {
    const htmlTagRegex = /<[^>]*>/g;
    const codePatterns = [
        /<script.*?>.*?<\/script>/gis,
        /<template.*?>.*?<\/template>/gis,
        /{\{.*?\}}/g,
        /def\s+\w+\(.*?\):/g,
        /class\s+\w+\s*\{/g,
        /function\s*\w*\s*\(.*?\)\s*\{/g,
        /import\s+.*?\s+from\s+['"].+['"]/g,
    ];

    const languages = ["codes","code","programming","coding","decoding","codings","decodings"];
    const lower = message.toLowerCase();
    const mentionsProgramming = languages.some(lang =>
        lower.includes(`write ${lang}`) ||
        lower.includes(`code in ${lang}`) ||
        lower.includes(lang)
    );

    return htmlTagRegex.test(message) || codePatterns.some(pattern => pattern.test(message)) || mentionsProgramming;
}


function isGreeting(message) {
    const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'hii','whatsapp','hola','hiii','hii'];
    return greetings.includes(message.trim().toLowerCase());
}


// function iscontact(message) {
//     const greetings = ['connect', 'contact', 'contact', 'meet'];
//     return greetings.includes(message.trim().toLowerCase());
// }

// function iscareer(message) {
//     const greetings = ['Job', 'jobs', 'career', 'careers', 'openings','opening','walk-in-drive','walk-in'];
//     return greetings.includes(message.trim().toLowerCase());
// }

function isContact(message) {
    const keywords = ['connect', 'contact', 'meet'];
    const lowerMessage = message.toLowerCase();
    return keywords.some(keyword => lowerMessage.includes(keyword));
}

function isCareer(message) {
    const keywords = ['job', 'jobs', 'career', 'careers', 'openings', 'opening', 'walk-in-drive', 'walk-in','open positions'];
    const lowerMessage = message.toLowerCase();
    return keywords.some(keyword => lowerMessage.includes(keyword));
}

function isbusiness(message) {
    const buss = ['What is your business profile', 'What is ur business profile','what is business profile of urs','what is testrig technologies', 'how is testrig ', 'testrig tech', 'testrig technology profile', 'testrig technology','testrig technology is famous for'];
    return buss.includes(message.trim().toLowerCase());
}

function isservices(message) {
    const buss = ['What are your services', 'What are ur services','what services u offer','what services you offer', 'what services you offer ', 'what services testrig has', 'which services testrig do', 'what services are available','which services testrig provides'];
    return buss.includes(message.trim().toLowerCase());
}

function checkPartnershipOrOutsourcing(message) {
    const lower = message.trim().toLowerCase();
    return lower === 'partnership' || lower === 'partnerships' || lower === 'outsourcing' || lower === 'freelance'|| lower === 'freelancing' || lower === 'freelancer';
}

function isThankful(message) {
    const thanks = [
        "nice", "sweet", "wow", "you are awesome", "you made my day", "thanks",
        "thank you", "thank u", "i'm happy", "i am happy","i am happy",
        "i'm satisfied", "i am satisfied","obliged"
    ];
    return thanks.includes(message.trim().toLowerCase());
}

function iswords(message) {
    const words = [
        "ok", "sure", "certainly", "definetly","okk",
        "welcome", "sure"
    ];
    return words.includes(message.trim().toLowerCase());
}

function isExitOrInfoRequest(message) {
    const exitKeywords = [
        "bye", "thank you bye", "need more info", "need extra info", "goodbye","good bye","more info","detail info",
        "need more details", "more information", "extra info", "more details", "more info","ok"
    ];
    return exitKeywords.includes(message.trim().toLowerCase());
}

function checkCaseStudyQuery(message) {
    const exact = ["case study", "case studies", "casestudy", "casestudies"];
    return exact.includes(message.trim().toLowerCase());
}

function isTechbotQuery(message) {
    const exact = ["who are you", "who are u","who is this", "what is your name", "are you a bot","what is your work","what do you have","what do you do"];
    return exact.includes(message.trim().toLowerCase());
}


// Updated name validation
function isValidName(name) {
    const words = name.trim().split(/\s+/);
    if (words.length > 2) return false;
    return words.every(word => /^[A-Za-z]{2,20}$/.test(word));
}

function handleNameInput(name) {
    clearTimeout(nameTimeoutTimer);

    if (isValidName(name)) {
        userName = formatName(name);
        expectingName = false;
        invalidNameAttempts = 0;

        showTypingIndicator();
        setTimeout(() => {
            hideTypingIndicator();
            addBotMessage(`Hello ${userName}, Feel free to chat with us.`);

            if (userName && userEmail && !sessionDataSaved) {
                const service = selectedService || "General Inquiry";
                saveUserInputToFirestore(service, userEmail, userName);
                sessionDataSaved = true;
            }
        }, 200);
    } else {
        invalidNameAttempts++;

        showTypingIndicator();
        setTimeout(() => {
            hideTypingIndicator();
            if (invalidNameAttempts >= 3) {
                addBotMessage('You did not shared a valid name.');
                addBotMessage('Hi, Please Feel free to chat with us.');
                expectingName = false;
            } else {
                addBotMessage('Your details are secured with usüîí<br>Please enter a valid name.');
                expectingName = true;

                nameTimeoutTimer = setTimeout(() => {
                    if (expectingName && !userName) {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addBotMessage('Hi, Please Feel free to chat with us.');
                            expectingName = false;
                        }, 200);
                    }
                }, 120000); 
            }
        }, 200);
    }
}



// function handleEmailInput(email) {
//     if (validateEmail(email)) {
//         userEmail = email;
//         expectingEmail = false;

//         showTypingIndicator();
//         setTimeout(() => {
//             hideTypingIndicator();
//             addBotMessage('Welcome to Testrig Technologies.');

//             setTimeout(() => {
//                 showTypingIndicator();
//                 setTimeout(() => {
//                     hideTypingIndicator();
//                     addBotMessage('May I know your name?');
//                     expectingName = true;

//                     // Start timer for final greeting if no name is entered (60 seconds)
//                     finalGreetingTimer = setTimeout(() => {
//                         if (expectingName && !userName) {
//                             showTypingIndicator();
//                             setTimeout(() => {
//                                 hideTypingIndicator();
//                                 addBotMessage('Hi,Please Feel free to chat with us');
//                                 expectingName = false;
//                             }, 500);
//                         }
//                     }, 60000);
//                 }, 500);
//             }, 1000);
//         }, 500);
//     } else {
//         showTypingIndicator();
//         setTimeout(() => {
//             hideTypingIndicator();
//             addBotMessage('Your details are secured with usüîí<br>Please share a valid Email Id');
//             expectingEmail = true;
//         }, 1000);
//     }
// }
===========================


:root {
    --chat-width: 304px; 
    --chat-height: 304px; 
}

* {
    box-sizing: border-box;
}

*::-webkit-scrollbar {
    width: 6px;
    display: none;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: white;
    min-height: 100vh;
}

/* Chat Toggle Button */
.abchat-toggle-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
}

.abchat-toggle-btn:hover {
    transform: scale(1.1);
}

.abchat-toggle-btn img {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
}

/* Chat Container - Now fully responsive */
.abchat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: var(--chat-width);
    height: auto;
    max-height: calc(100vh - 40px);
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    z-index: 1001;
    animation: slideUp 0.3s ease;
    display: flex;
    flex-direction: column;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Header */
.abchat-header {
    background: linear-gradient(to bottom right, #20bc75, #2d9782);
    color: white;
    padding: 10px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.abchat-header img {
    width: 7.4rem;
    height: 1.3rem;
    margin-right: 10px;
}

.header-buttons {
    display: flex;
    gap: 10px;
}

.refresh-btn, .close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.refresh-btn:hover, .close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.refresh-btn img {
    width: 16px;
    height: 16px;
}

.close-btn {
    color: white;
    font-size: 18px;
    font-weight: bold;
}

/* Chat Window */
.abchat-window {
    height: var(--chat-height);
    overflow-y: auto;
    padding: 2px;
    background: #f8f9fa;
    flex-grow: 1;
}

.abchat-window::-webkit-scrollbar {
    width: 6px;
}

.abchat-window::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.abchat-window::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

/* Bot Messages */
.bot-message-container {
    padding: 2px;
    animation: fadeInLeft 0.5s ease;
}

.bot-greeting {
    background: #E0E0E0;
    color: black;
    padding: 7px 12px;
    border-radius: 18px;
    display: inline-block;
    margin-bottom: 8px;
    font-weight: 500;
    margin: 3px;
}

.bot-response {
    background: #E0E0E0;
    color: black;
    padding: 6px 12px;
    border-radius: 18px;
    display: inline-block;
    max-width: 85%;
    line-height: 1.2;
    margin: 4px;
    margin-left: 0.3rem;
}

@keyframes fadeInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Services Container */
.services-container {
    margin: 2px 0;
    animation: fadeInUp 0.6s ease;
}

.services-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
}

.service-btn {
    background: #E0E0E0;
    color: black;
    display: inline-block;
    border: none;
    padding: 6px 10px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    text-align: center;
    margin-left: 0.3rem;
    margin-right: 0.3rem;
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.3;
}

.service-btn:hover {
    background: #bbb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* User Messages */
.user-message-container {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 15px;
    animation: fadeInRight 0.5s ease;
    margin: 6px;
}

.user-message {
    background: #20bc75;
    color: white;
    padding: 6px 12px;
    border-radius: 18px;
    max-width: 80%;
    margin: 1px;
}

@keyframes fadeInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Typing Animation */
.typing-indicator {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    animation: fadeInLeft 0.5s ease;
}

.typing-dots {
    background: #E0E0E0;
    padding: 12px 18px;
    border-radius: 18px;
    display: flex;
    gap: 4px;
    align-items: center;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

/* Input Container */
.chat-input-container {
    padding: 5px 10px;
    background: white;
    border-top: 1px solid #eee;
    flex-shrink: 0;
}

.abinput-wrapper {
    display: flex;
    gap: 4px;
    align-items: flex-end;
}

#abuser-input {
    flex: 1;
    border: 2px solid #e1e5e9;
    border-radius: 15px;
    padding: 4px 5px;
    font-size: 14px;
    resize: none;
    outline: none;
    transition: border-color 0.3s ease;
    min-height: 40px;
    max-height: 100px;
}

#abuser-input:focus {
    border-color: #20bc75;
}

#absend-btn {
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

#absend-btn:hover {
    transform: scale(1.1);
}

#absend-btn img {
    width: 30px;
    height: 30px;
}

.refresh-btn {
    border: none;
    color: white;
    padding: 5px 10px;
    font-size: 0.8rem;
    border-radius: 50px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.3s ease;
}

/* RESPONSIVE DESIGN MEDIA QUERIES */

/* 4K and Ultra-wide Displays (2560px and above) */
@media (min-width: 2560px) {
    :root {
        --chat-width: 342px; 
        --chat-height: 361px; 
    }
    
    .abchat-header img {
        width: 8.5rem;
        height: 1.5rem;
    }
    
    .service-btn {
        font-size: 15px;
        padding: 14px 16px;
    }
    
    .bot-response, .user-message {
        font-size: 15px;
    }
}

/* Large Desktops (1440px - 2559px) */
@media (max-width: 2559px) and (min-width: 1440px) {
    :root {
        --chat-width: 342px; 
        --chat-height: 361px; 
    }
    
    .abchat-header img {
        width: 8rem;
        height: 1.4rem;
    }
    
    .service-btn {
        font-size: 14px;
        padding: 12px 14px;
    }
    
    .bot-response, .user-message {
        font-size: 14px;
    }
}

/* Standard Desktops (1200px - 1439px) */
@media (max-width: 1439px) and (min-width: 1200px) {
    :root {
        --chat-width: 333px; 
        --chat-height: 342px; 
    }
}

/* Small Desktops and Large Laptops (1025px - 1199px) */
@media (max-width: 1199px) and (min-width: 1025px) {
    :root {
        --chat-width: 337px; 
        --chat-height: 337px; 
    }
}

/* Small Laptops (769px - 1024px) */
@media (max-width: 1024px) and (min-width: 769px) {
    
    :root {
        --chat-width: 350px; 
        --chat-height: 370px; 
    }
    
    .service-btn {
        font-size: 12px;
        padding: 9px 11px;
    }
}

/* Tablets (481px - 768px) */
@media (max-width: 768px) and (min-width: 481px) {
    :root {
        --chat-width: 320px; 
        --chat-height: 340px; 
    }
    
    body {
        padding: 15px;
    }
    
    .abchat-toggle-btn {
        bottom: 15px;
        right: 15px;
        width: 55px;
        height: 55px;
    }
    
    .abchat-toggle-btn img {
        width: 3.2rem;
        height: 3.2rem;
    }
    
    .abchat-container {
        bottom: 15px;
        right: 15px;
    }
    
    .abchat-header img {
        width: 6.8rem;
        height: 1.2rem;
    }
    
    .service-btn {
        font-size: 12px;
        padding: 8px 10px;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.2;
    }
    
    .bot-response, .user-message {
        font-size: 13px;
    }
}

/* Mobile Devices (320px - 480px) */
@media (max-width: 480px) {
    :root {
        --chat-width: calc(95vw - 19px); 
        --chat-height: calc(95vh - 190px);
    }
    
    body {
        padding: 10px;
    }
    
    .abchat-toggle-btn {
        bottom: 10px;
        right: 10px;
        width: 50px;
        height: 50px;
    }
    
    .abchat-toggle-btn img {
        width: 2.8rem;
        height: 2.8rem;
    }
    
    .abchat-container {
        width: var(--chat-width);
        height: calc(95vh - 19px);
        bottom: 10px;
        right: 10px;
        left: 10px;
        border-radius: 15px;
        max-height: none;
    }
    
    .abchat-header {
        padding: 8px 10px;
    }
    
    .abchat-header img {
        width: 6rem;
        height: 1.1rem;
        margin-right: 8px;
    }
    
    .refresh-btn, .close-btn {
        width: 28px;
        height: 28px;
    }
    
    .refresh-btn img {
        width: 14px;
        height: 14px;
    }
    
    .close-btn {
        font-size: 16px;
    }
    
    .abchat-window {
        height: var(--chat-height);
        padding: 5px;
    }
    
    .services-grid {
        grid-template-columns: 1fr;
        gap: 6px;
        padding: 0 5px;
    }
    
    .service-btn {
        font-size: 14px;
        padding: 10px 12px;
        margin: 0;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.3;
        text-align: center;
        display: block;
        width: 100%;
    }

    .bot-greeting, .bot-response {
        padding: 6px 10px;
        font-size: 14px;
        margin-left: 5px;
    }
    
    .user-message {
        padding: 6px 10px;
        font-size: 13px;
        max-width: 85%;
    }
    
    .user-message-container {
        margin: 5px;
    }
    
    #abuser-input {
        font-size: 13px;
        min-height: 35px;
        padding: 6px 8px;
    }
    
    #absend-btn {
        width: 35px;
        height: 35px;
    }
    
    #absend-btn img {
        width: 25px;
        height: 25px;
    }
    
    .chat-input-container {
        padding: 8px;
    }
}

/* Very Small Mobile Devices (280px - 320px) */
@media (max-width: 320px) {
    :root {
        --chat-width: calc(95vw - 14px); 
        --chat-height: calc(95vh - 171px); 
    }
    
    .abchat-container {
        width: var(--chat-width);
        height: calc(95vh - 14px); 
        bottom: 8px;
        right: 8px;
        left: 8px;
        border-radius: 12px;
    }
    
    .abchat-toggle-btn {
        bottom: 8px;
        right: 8px;
        width: 45px;
        height: 45px;
    }
    
    .abchat-toggle-btn img {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    .abchat-header {
        padding: 6px 8px;
    }
    
    .abchat-header img {
        width: 5.5rem;
        height: 1rem;
        margin-right: 6px;
    }
    
    .refresh-btn, .close-btn {
        width: 25px;
        height: 25px;
    }
    
    .refresh-btn img {
        width: 12px;
        height: 12px;
    }
    
    .close-btn {
        font-size: 14px;
    }
    
    .services-grid {
        padding: 0 3px;
    }
    
    .service-btn {
        font-size: 11px;
        padding: 8px 10px;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.2;
        text-align: center;
        margin: 0;
        display: block;
        width: 100%;
    }
    
    .bot-greeting, .bot-response, .user-message {
        font-size: 12px;
        padding: 5px 8px;
    }
    
    #abuser-input {
        font-size: 12px;
        min-height: 32px;
        padding: 5px 6px;
    }
    
    #absend-btn {
        width: 32px;
        height: 32px;
    }
    
    #absend-btn img {
        width: 22px;
        height: 22px;
    }
}

/* Landscape Orientation for Mobile */
@media (max-width: 768px) and (orientation: landscape) {
    :root {
        --chat-width: min(333px, calc(95vw - 38px)); 
        --chat-height: calc(95vh - 152px);
    }
    
    .abchat-container {
        width: var(--chat-width);
        height: calc(95vh - 38px);
        max-height: 399px; 
    }
    
    .service-btn {
        padding: 6px 8px;
        font-size: 11px;
    }
}

/* Container Query Support (for modern browsers) */
@supports (container-type: inline-size) {
    .abchat-container {
        container-type: inline-size;
    }
    
    @container (max-width: 300px) {
        .services-grid {
            grid-template-columns: 1fr;
        }
        
        .service-btn {
            font-size: 12px;
            padding: 8px 10px;
        }
    }
}

/* High DPI Displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .abchat-toggle-btn {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .abchat-container {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .service-btn:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
}

/* Print Styles */
@media print {
    .abchat-container {
        position: static;
        width: 100%;
        height: auto;
        box-shadow: none;
        border: 1px solid #ccc;
    }
    
    .abchat-toggle-btn {
        display: none;
    }
}

/* Prefers Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    .abchat-container,
    .bot-message-container,
    .user-message-container,
    .services-container,
    .typing-indicator {
        animation: none;
    }
    
    .abchat-toggle-btn:hover,
    .refresh-btn:hover,
    .close-btn:hover,
    .service-btn:hover,
    #absend-btn:hover {
        transform: none;
    }
}
==================
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Alloy Dashboard</title>
  <link rel="stylesheet" href="dash.css"/>
<!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
  <div class="main-container">
    <!-- LEFT PANEL -->
    <div class="left-panel">
        <div class="downloads-section">
            <h3>Downloads</h3>
          
            <div class="download-item">
              <button id="downloadUserInfo">Users Information</button>
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icon" class="download-icon">
            </div>
          
            <div class="download-item">
              <button id="downloadUserDetails">User Details</button>
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icons" class="download-icons"> 
            </div>
          </div>
          <!-- <div class="download-item">
            <button id="downloadUserDetails">
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icon" class="download-icons">
              User Details
            </button>
          </div> -->
          
          
          <div class="filter-container">
            <h3>Filters</h3>
            <div class="filter-group">
              <label>Start Date:</label>
              <input type="date" id="startDate">
              <label>End Date</label>
              <input type="date" id="endDate">
            </div>
          
            <div class="filter-group">
              <label for="serviceFilter">Service:</label>
              <select id="serviceFilter">
                <option value="">All Services</option>
              </select>
            </div>
          
            <div class="filter-group">
              <button id="applyFilters">Apply</button>
              <button id="resetFilters">Reset</button>
              <!-- <button id="showFilteredData">Filtered Visitors Details</button> -->
            </div>
          </div>
          
          <!-- <button id="toggleTableBtn">User Info</button> -->
          <div id="tableContainer">
            <div class="loader" id="tableLoader"></div>
            <button id="downloadCsv">Download CSV</button>
            <button id="downloadExcel">Download Excel</button>
            <table id="data-table">
              <thead>
                <tr>
                  <th>Username</th><th>Email</th><th>Service</th>
                  <th>Session ID</th><th>Date</th><th>Time</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
    
          

    </div>
    <!-- RIGHT PANEL -->
    <div class="right-panel">
        <div class="top-bar">
            <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
          
            <div class="top-right-controls">
              <div class="search-box">
                <!-- <input type="text" id="searchInput" placeholder="Search for anything..." /> -->
                <button id="searchBtn"></button>
                <button id="clearSearch"></button>
                <img 
            src="https://storage.googleapis.com/testrig-bot-static-files/refresh.JPG" 
            style="width: 23px; height: 23px; border-radius: 50%; object-fit: cover; cursor: pointer;transform: translateY(30%);" 
            alt="Refresh" 
            id="refreshBtn"
            />
              </div>
            </div>
            
          </div>
        
      <div class="charts">
        <div class="chart-box">
          <h3>Sessions per Service</h3>
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Sessions per Day</h3>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Unique Emails per Day</h3>
          <canvas id="emailChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Service Distribution</h3>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>
  <div class="expanded-content" id="expanded-content">
    <span class="close-expanded" id="close-expanded">&times;</span>
    <div id="expanded-text"></div>
  </div>
  


<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDutX02xinG0RmqoXx6k8eWznlzaHwAgsE",
        authDomain: "chat-bot-project-452312.firebaseapp.com",
        projectId: "chat-bot-project-452312",
        storageBucket: "chat-bot-project-452312.firebasestorage.app",
        messagingSenderId: "61875479783",
        appId: "1:61875479783:web:4dc5ce48b44aa43ec22e42"
    };



  // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  // Global variables to store data
  let allUserData = [];
  let allQueryData = [];
  let combinedData = [];
  let filteredData = [];

 // Improved applyFilters function to filter data and update charts
function applyFilters() {
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;
  const serviceFilter = document.getElementById("serviceFilter").value;
  
  console.log("Applying filters:", startDateStr, endDateStr, serviceFilter);
  
  // Create Date objects for comparison (set to start/end of day)
  let startDate = null;
  let endDate = null;
  
  if (startDateStr) {
    startDate = new Date(startDateStr);
    startDate.setHours(0, 0, 0, 0);
  }
  
  if (endDateStr) {
    endDate = new Date(endDateStr);
    endDate.setHours(23, 59, 59, 999);
  }
  
  // Filter the data based on selected criteria
  filteredData = allUserData.filter(item => {
    // Parse the timestamp from the item
    let itemDate = null;
    
    // Handle different date formats
    if (item.time && typeof item.time === 'string') {
      if (item.time.includes(' ')) {
        // Format: "2025-04-17 10:36:57"
        const [dateStr, timeStr] = item.time.split(' ');
        itemDate = new Date(dateStr);
      } else if (item.time.includes('T')) {
        // ISO format
        itemDate = new Date(item.time);
      }
    } else if (item.date) {
      // Just date field
      itemDate = new Date(item.date);
    }
    
    // Check if date is in range
    let passesDateFilter = true;
    if (startDate && itemDate && itemDate < startDate) {
      passesDateFilter = false;
    }
    if (endDate && itemDate && itemDate > endDate) {
      passesDateFilter = false;
    }
    
    // Check if service matches
    let passesServiceFilter = true;
    if (serviceFilter && item.service !== serviceFilter) {
      passesServiceFilter = false;
    }
    
    return passesDateFilter && passesServiceFilter;
  });
  
  console.log(`Data filtered: ${filteredData.length} records match criteria`);
  
  // Update the table with filtered data
  updateTableWithFilteredData(filteredData);
  
  // Update charts with filtered data
  updateCharts(filteredData);
}

    // Function to update the table with filtered data
    function updateTableWithFilteredData(data) {
      const tableBody = document.getElementById("table-body");
      tableBody.innerHTML = "";
      
      if (data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='6'>No data matches the selected filters</td></tr>";
        return;
      }
      
      data.forEach(item => {
        // Split datetime into date and time parts if needed
        let date = "";
        let time = "";
        
        if (item.time && item.time.includes(" ")) {
          const timeParts = item.time.split(" ");
          date = timeParts[0];
          time = timeParts[1];
        } else {
          date = item.date || "";
          time = item.time || "";
        }
        
        const row = `
          <tr>
            <td>${item.username || ""}</td>
            <td>${item.email || ""}</td>
            <td>${item.service || ""}</td>
            <td>${item.session_id || item.sessionid || ""}</td>
            <td>${date}</td>
            <td>${time}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    // Update the event listener for the Apply button
    document.getElementById("applyFilters").addEventListener("click", function() {
      applyFilters();
    });

    // Update the event listener for the Reset button
    document.getElementById("resetFilters").addEventListener("click", function() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("serviceFilter").value = "";
      
      // Reset to show all data
      filteredData = allUserData;
      updateTableWithFilteredData(allUserData);
      updateCharts(allUserData);
    });


  // Helper function to parse timestamp
  function parseTimestamp(timeStr) {
    if (!timeStr) return null;
    
    // Handle format "2025-04-17 10:36:57"
    const dateParts = timeStr.split(' ');
    if (dateParts.length === 2) {
      const [dateStr, timeStr] = dateParts;
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes, seconds);
    }
    
    // Try to parse as ISO string
    try {
      return new Date(timeStr);
    } catch (e) {
      console.error("Error parsing timestamp:", e);
      return null;
    }
  }



  
  // Load user data from Firestore
  async function loadUserData() {
    try {
      document.getElementById("tableLoader").style.display = "block";
      const snapshot = await db.collection("testrig_UserDetails").get();
      const tableBody = document.getElementById("table-body");
      tableBody.innerHTML = "";
      allUserData = [];

      if (snapshot.empty) {
        tableBody.innerHTML = "<tr><td colspan='6'>No data available</td></tr>";
        document.getElementById("tableLoader").style.display = "none";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        // Store data for filtering
        allUserData.push(data);
        
        // Check if time field contains both date and time
        let date = "";
        let time = "";
        
        if (data.time && data.time.includes(" ")) {
          // Split datetime into date and time parts
          const timeParts = data.time.split(" ");
          date = timeParts[0];
          time = timeParts[1];
        } else {
          // If separate fields exist, use them
          date = data.date || "";
          time = data.time || "";
        }
        
        const row = `
          <tr>
            <td>${data.username || ""}</td>
            <td>${data.email || ""}</td>
            <td>${data.service || ""}</td>
            <td>${data.session_id || data.sessionid || ""}</td>
            <td>${date}</td>
            <td>${time}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
      
      // Populate service dropdown with unique services
      populateServiceDropdown();
      
      // Update charts
      updateCharts(allUserData);
      
      document.getElementById("tableLoader").style.display = "none";
    } catch (error) {
      console.error("Error loading user data: ", error);
      document.getElementById("table-body").innerHTML = 
        "<tr><td colspan='6'>Error loading data. Please try again.</td></tr>";
      document.getElementById("tableLoader").style.display = "none";
    }
  }

  // Function to initialize charts
 function initializeCharts() {
   console.log("Initializing charts");
  
  // Check if Chart.js is loaded
   if (typeof Chart === 'undefined') {
     console.error("Chart.js not loaded! Adding it now...");
    
    // Load Chart.js dynamically if not already loaded
     const script = document.createElement('script');
     script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
     script.onload = function() {
      console.log("Chart.js loaded successfully!");
      // Create chart containers if they don't exist
      createChartContainers();
    };
    document.head.appendChild(script);
  } else {
    console.log("Chart.js already loaded!");
    // Create chart containers if they don't exist
    createChartContainers();
  }
 }
  
  // Load query data from Firestore
  async function loadQueryData() {
    try {
      document.getElementById("chatLoader").style.display = "block";
      const snapshot = await db.collection("testrig_queries").get();
      const chatBody = document.getElementById("chat-body");
      chatBody.innerHTML = "";
      allQueryData = [];

      if (snapshot.empty) {
        chatBody.innerHTML = "<tr><td colspan='5'>No chat data available</td></tr>";
        document.getElementById("chatLoader").style.display = "none";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        // Store data for combining
        allQueryData.push(data);
        
        // Format timestamp
        let formattedTime = "";
        if (data.timestamp) {
          const timestamp = typeof data.timestamp === 'object' && data.timestamp.toDate ? 
                            data.timestamp.toDate() : 
                            new Date(data.timestamp);
          formattedTime = timestamp.toLocaleString();
        }
        
        const row = `
          <tr>
            <td>${data.session_id || ""}</td>
            <td class="expandable-cell" data-content="${encodeURIComponent(data.query || "")}">
              <span class="truncate">${data.query || ""}</span>
            </td>
            <td class="expandable-cell" data-content="${encodeURIComponent(data.response || "")}">
              <span class="truncate">${data.response || ""}</span>
            </td>
            <td>${data.bot || ""}</td>
            <td>${formattedTime}</td>
          </tr>
        `;
        chatBody.innerHTML += row;
      });
      
      // Add click handlers for expandable cells
      setupExpandableCells();
      
      document.getElementById("chatLoader").style.display = "none";
    } catch (error) {
      console.error("Error loading query data: ", error);
      document.getElementById("chat-body").innerHTML = 
        "<tr><td colspan='5'>Error loading chat data. Please try again.</td></tr>";
      document.getElementById("chatLoader").style.display = "none";
    }
  }

  // Setup handlers for expandable cells
  function setupExpandableCells() {
    const expandableCells = document.querySelectorAll('.expandable-cell');
    const overlay = document.getElementById('overlay');
    const expandedContent = document.getElementById('expanded-content');
    const expandedText = document.getElementById('expanded-text');
    const closeBtn = document.getElementById('close-expanded');
    
    expandableCells.forEach(cell => {
      cell.addEventListener('click', function() {
        const content = decodeURIComponent(this.getAttribute('data-content'));
        expandedText.textContent = content;
        overlay.style.display = 'block';
        expandedContent.style.display = 'block';
      });
    });
    
    closeBtn.addEventListener('click', function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    });
    
    overlay.addEventListener('click', function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    });
  }

  // Populate service dropdown from the data
  function populateServiceDropdown() {
    const serviceFilter = document.getElementById("serviceFilter");
    // Keep the first option "All Services"
    serviceFilter.innerHTML = '<option value="">All Services</option>';
    
    // Get unique services
    const uniqueServices = [...new Set(allUserData.map(item => item.service))];
    
    // Add each unique service to the dropdown
    uniqueServices.forEach(service => {
      if (service) { // Only add non-empty services
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        serviceFilter.appendChild(option);
      }
    });
  }
  
  // Function to update charts based on data
  function updateCharts(data) {
    // Implementation of chart updates will go here
    // This is a placeholder for now
    console.log("Chart data updated with", data.length, "records");
  }

  // Apply filters
  document.getElementById("applyFilters").addEventListener("click", function() {
    applyFilters();
  });
  
  // Reset filters
  document.getElementById("resetFilters").addEventListener("click", function() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("serviceFilter").value = "";
    document.getElementById("searchInput").value = "";
    
    // Reset to original data
    if (document.getElementById("tableContainer").style.display === "block") {
      loadUserData();
    } else if (document.getElementById("combinedContainer").style.display === "block") {
      updateCombinedTable(combinedData);
    }
  });
  

  
  // Search button
  document.getElementById("searchBtn").addEventListener("click", function() {
    applyFilters();
  });
  
  // Clear search
  document.getElementById("clearSearch").addEventListener("click", function() {
    document.getElementById("searchInput").value = "";
    applyFilters();
  });


// Function to load and combine data from both collections
async function loadCombinedData() {
  try {
    document.getElementById("combinedLoader").style.display = "block";
    combinedData = [];
    
    // Make sure we have both data sets
    if (allUserData.length === 0) {
      const userSnapshot = await db.collection("testrig_UserDetails").get();
      userSnapshot.forEach(doc => {
        allUserData.push(doc.data());
      });
    }
    
    // Load query data with the actual field structure
    const querySnapshot = await db.collection("testrig_queries").get();
    allQueryData = [];
    querySnapshot.forEach(doc => {
      allQueryData.push(doc.data());
    });
    
    // Create a map to store queries by session_id
    const queryMap = {};
    
    allQueryData.forEach(query => {
      const sessionId = query.sessionId || "";
      if (!sessionId) return;
      
      // Store the query by session ID
      queryMap[sessionId] = {
        query_by_bot1: query.query_by_bot1 || "",
        response_by_bot1: query.response_by_bot1 || "",
        query_by_bot2: query.query_by_bot2 || "",
        response_by_bot2: query.response_by_bot2 || "",
        timestamp: query.timestamp || query.time
      };
    });
    
    // Combine user data with query data
    allUserData.forEach(userData => {
      const sessionId = userData.session_id || userData.sessionid || "";
      if (!sessionId) return;
      
      // Create a combined record
      const combined = {
        username: userData.username || "",
        email: userData.email || "",
        service: userData.service || "",
        sessionid_details: sessionId,
        date: "",
        time: "",
        query_by_bot1: "",
        response_by_bot1: "",
        query_by_bot2: "",
        response_by_bot2: "",
        sessionid_queries: ""
      };
      
      // Format the date and time
      if (userData.time && userData.time.includes(" ")) {
        const parts = userData.time.split(" ");
        combined.date = parts[0];
        combined.time = parts[1];
      } else {
        combined.date = userData.date || "";
        combined.time = userData.time || "";
      }
      
      // Parse user timestamp
      let userTime = parseTimestamp(userData.time);
      
      // If we have corresponding query data by session ID, add it
      if (queryMap[sessionId]) {
        combined.query_by_bot1 = queryMap[sessionId].query_by_bot1 || "";
        combined.response_by_bot1 = queryMap[sessionId].response_by_bot1 || "";
        combined.query_by_bot2 = queryMap[sessionId].query_by_bot2 || "";
        combined.response_by_bot2 = queryMap[sessionId].response_by_bot2 || "";
        combined.sessionid_queries = sessionId;
      } else {
        // Try to find query data based on timestamp matching
        // within a 3-minute window (180 seconds)
        allQueryData.forEach(query => {
          if (!query.timestamp && !query.time) return;
          
          let queryTime;
          if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
            queryTime = query.timestamp.toDate();
          } else {
            queryTime = parseTimestamp(query.timestamp || query.time);
          }
          
          if (!queryTime || !userTime) return;
          
          // Compare timestamps with 180-second window
          const timeDiff = Math.abs(userTime - queryTime) / 1000; // difference in seconds
          if (timeDiff <= 180) { // 3 minutes
            combined.query_by_bot1 = query.query_by_bot1 || "";
            combined.response_by_bot1 = query.response_by_bot1 || "";
            combined.query_by_bot2 = query.query_by_bot2 || "";
            combined.response_by_bot2 = query.response_by_bot2 || "";
            combined.sessionid_queries = query.sessionId || "";
          }
        });
      }
      
      combinedData.push(combined);
    });
    
    // Update the combined table
    updateCombinedTable(combinedData);
    
    document.getElementById("combinedLoader").style.display = "none";
  } catch (error) {
    console.error("Error loading combined data: ", error);
    document.getElementById("combined-body").innerHTML = 
      "<tr><td colspan='12'>Error loading combined data. Please try again.</td></tr>";
    document.getElementById("combinedLoader").style.display = "none";
  }
}

// Update the combined data table with the new structure
function updateCombinedTable(data) {
  const tableBody = document.getElementById("combined-body");
  tableBody.innerHTML = "";
  
  if (data.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='12'>No combined data available</td></tr>";
    return;
  }
  
  // Update table headers to match the new structure
  const tableHeaders = document.querySelector("#combined-table thead tr");
  tableHeaders.innerHTML = `
    <th>Username</th>
    <th>Email</th>
    <th>Service</th>
    <th>SessionID Details</th>
    <th>SessionID Queries</th>
    <th>Date</th>
    <th>Time</th>
    <th>Query Bot 1</th>
    <th>Response Bot 1</th>
    <th>Query Bot 2</th>
    <th>Response Bot 2</th>
  `;
  
  data.forEach(item => {
    const row = `
      <tr>
        <td>${item.username}</td>
        <td>${item.email}</td>
        <td>${item.service}</td>
        <td>${item.sessionid_details}</td>
        <td>${item.sessionid_queries}</td>
        <td>${item.date}</td>
        <td>${item.time}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">
          <span class="truncate">${item.query_by_bot1}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">
          <span class="truncate">${item.response_by_bot1}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">
          <span class="truncate">${item.query_by_bot2}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">
          <span class="truncate">${item.response_by_bot2}</span>
        </td>
      </tr>
    `;
    tableBody.innerHTML += row;
  });
  
  // Setup expandable cells
  setupExpandableCells();
}

// Improved timestamp parsing function to handle different formats
function parseTimestamp(timeStr) {
  if (!timeStr) return null;
  
  // Handle format "2025-04-17 10:36:57"
  if (typeof timeStr === 'string' && timeStr.includes(' ')) {
    const dateParts = timeStr.split(' ');
    if (dateParts.length === 2) {
      const [dateStr, timeStr] = dateParts;
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes, seconds);
    }
  }
  
  // Handle ISO format "2025-04-15T12:46:23.657471"
  if (typeof timeStr === 'string' && timeStr.includes('T')) {
    return new Date(timeStr);
  }
  
  // Handle Firebase timestamp objects
  if (typeof timeStr === 'object' && timeStr.toDate) {
    return timeStr.toDate();
  }
  
  // Handle string like "15 April 2025 at 18:16:23.6"
  if (typeof timeStr === 'string' && timeStr.includes('at')) {
    const dateRegex = /(\d+)\s+(\w+)\s+(\d+)\s+at\s+(\d+):(\d+):(\d+)/;
    const match = timeStr.match(dateRegex);
    if (match) {
      const [_, day, month, year, hours, minutes, seconds] = match;
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const monthIndex = monthNames.findIndex(m => m === month);
      if (monthIndex !== -1) {
        return new Date(parseInt(year), monthIndex, parseInt(day), parseInt(hours), parseInt(minutes), parseInt(seconds));
      }
    }
  }
  
  // Try to parse as generic date string
  try {
    return new Date(timeStr);
  } catch (e) {
    console.error("Error parsing timestamp:", e);
    return null;
  }
}

function addDashboardSummary() {
  // Create a summary section above the charts
  const rightPanel = document.querySelector('.right-panel');
  const chartsContainer = document.querySelector('.charts');
  
  // Create summary section element
  const summarySection = document.createElement('div');
  summarySection.className = 'dashboard-summary';
  summarySection.innerHTML = `
    <div class="dashboard-header">
    </div>
    <div class="summary-cards">
    <div class="summary-card" id="total-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Total Users</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="users-today">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Users Today</h3>
        <p class="card-value">-</p>
        </div>    
    </div>
    <div class="summary-card" id="returning-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Returning Users</h3>
        <p class="card-value">-</p>
        </div>

    </div>
    <div class="summary-card" id="online-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Online Users</h3>
        <p class="card-value">-</p>
        </div>
    </div>
    <div class="summary-card" id="total-sessions">
        <div class="card-icon">üîÑ</div>
        <div class="card-content">
        <h3>Total Sessions</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="active-services">
        <div class="card-icon">üß©</div>
        <div class="card-content">
        <h3>Number of Services</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="top-service">
        <div class="card-icon">üî•</div>
        <div class="card-content">
        <h3>Top Service</h3>
        <p class="card-value">-</p>
        </div>
    </div>
    <div class="summary-card" id="avg-sessions">
        <div class="card-icon">üìä</div>
        <div class="card-content">
        <h3>Avg Sessions per User</h3>
        <p class="card-value">0</p>
        </div>
    </div>
  `;
  
  // Insert the summary section before the charts
  rightPanel.insertBefore(summarySection, chartsContainer);
  
  // Add CSS for the summary section
  const style = document.createElement('style');
  style.textContent = `
    .dashboard-summary {
      margin-bottom: 30px;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .card-icon {
      font-size: 24px;
      margin-right: 15px;
    }
    
    .card-content h3 {
      margin: 0 0 5px 0;
      font-size: 14px;
      color: #666;
    }
    
    .card-value {
      margin: 0;
      
      font-weight: bold;
      color: #333;
    }

    /* Unified style for all view icons */
    .view-online-users,
    .view-users-today,
    .view-returning-users {
      cursor: pointer;
      margin-left: 5px;
      color: #088F8F;
      transition: color 0.2s;
    }
    
    .view-online-users:hover {
      // color: #2a6fc6;
       color: #4a90e2;
    }

    .view-users-today:hover {color: #4a90e2;}
    .view-returning-users:hover {color:#4a90e2;}

    .online-users-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    
    .online-users-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .online-users-list li:last-child {
      border-bottom: none;
    }
    
    @media (max-width: 1024px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Modal styles */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    #expanded-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      min-width: 300px;
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    }
  
    
    @media (max-width: 576px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }
  `;
  document.head.appendChild(style);

  // Add Font Awesome for the eye icon
  const fontAwesome = document.createElement('link');
  fontAwesome.rel = 'stylesheet';
  fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
  document.head.appendChild(fontAwesome);

  // Create modal structure
  ensureModalStructureExists();
  
  // Update the summary cards with data
  updateDashboardSummary(allUserData);
}

function parseTimestamping(timestamp) {
  if (!timestamp) return null;
  const dateObj = new Date(timestamp);
  return isNaN(dateObj) ? null : dateObj;
}

function formatDateToISOString(dateObj) {
  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const dd = String(dateObj.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}






// ==================
function updateDashboardSummary(data) {
  const uniqueEmails = new Set();
  const emailCount = {};
  const serviceCount = {};

  // Get today's date in Indian Standard Time (IST)
  const now = new Date();
  const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
  // Format today's date as YYYY-MM-DD for comparison with database dates
  const todayFormatted = todayIST.getFullYear() + '-' + 
                         String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(todayIST.getDate()).padStart(2, '0');

  let usersToday = 0;
  let onlineUsers = 0;
  
  // Set to track unique users today (to avoid counting the same user multiple times)
  const uniqueUsersToday = new Set();

  // Online users tracking - store emails of users active in last 30 minutes
  const onlineUserEmails = new Set();
  const thirtyMinutesInMs = 30 * 60 * 1000; // 30 minutes in milliseconds

  // Track returning users' emails
  const returningUsersEmails = new Set();

  data.forEach(item => {
    // Unique emails
    if (item.email) {
      uniqueEmails.add(item.email);
      emailCount[item.email] = (emailCount[item.email] || 0) + 1;
    }

    // Count services
    if (item.service) {
      serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
    }

    if (item.time) {
      const itemDate = item.time.split(" ")[0]; // Extract '2025-04-22' from '2025-04-22 11:16:18'
      if (itemDate === todayFormatted && item.email) {
        uniqueUsersToday.add(item.email);
      }
    }


    // Online users: unique email IDs within last 30 minutes
    if (item.email && item.time) {
      let sessionTime;
      if (item.time.includes(" ")) {
        // Format: "2025-04-17 10:36:57"
        sessionTime = parseTimestamping(item.time);
      } else if (item.date && item.time) {
        // Separate date and time fields
        sessionTime = parseTimestamping(`${item.date} ${item.time}`);
      }
      
      if (sessionTime && (now - sessionTime) <= thirtyMinutesInMs) {
        onlineUserEmails.add(item.email);
      }
    }
  });

  // Set usersToday to the count of unique users who interacted today
  usersToday = uniqueUsersToday.size;

  // Total sessions
  const totalSessions = data.length;

  // Active unique services
  const uniqueServices = new Set(Object.keys(serviceCount));

  // Returning users: email seen more than once
  // const returningUsers = Object.values(emailCount).filter(count => count > 1).length;

  // Convert Set to Array for the online users list
  const onlineUsersList = Array.from(onlineUserEmails);
  const todayUsersList = Array.from(uniqueUsersToday);

  // Avg sessions per user
  const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;

  // Top engaged service
  let topService = "-";
  let maxServiceCount = 0;
  for (const [service, count] of Object.entries(serviceCount)) {
    if (count > maxServiceCount) {
      topService = service;
      maxServiceCount = count;
    }
  }

  // Returning users: email seen more than once
  const returningUsers = Object.entries(emailCount).filter(([email, count]) => count > 1);
  const returningUsersCount = returningUsers.length;
  const returningUsersList = returningUsers.map(item => item[0]); // Extract just the emails

  // Returning users: email seen more than once
  // const returningUsers = Object.values(emailCount).filter(count => count > 1).length;

  document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
  document.querySelector('#total-users .card-value').setAttribute('title', `Unique users: ${uniqueEmails.size}`);

  document.querySelector('#total-sessions .card-value').textContent = totalSessions;
  document.querySelector('#total-sessions .card-value').setAttribute('title', `Total sessions: ${totalSessions}`);

  document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
  document.querySelector('#active-services .card-value').setAttribute('title', `Unique services used: ${uniqueServices.size}`);

  document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
  document.querySelector('#avg-sessions .card-value').setAttribute('title', `Avg sessions per user: ${avgSessions}`);

  // document.querySelector('#top-service .card-value').innerHTML = `<h6>${topService}</small>`;
  // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  // document.querySelector('#top-service .card-value').textContent = topService;
  // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);

  document.querySelector('#users-today .card-value').textContent = usersToday;
  document.querySelector('#users-today .card-value').setAttribute('title', `Users Today: ${usersToday}`);
  
  document.querySelector('#online-users .card-value').textContent = onlineUsers;
  document.querySelector('#online-users .card-value').setAttribute('title', `Active within 5 mins: ${onlineUsers}`);

  document.querySelector('#returning-users .card-value').textContent = returningUsers;
  document.querySelector('#returning-users .card-value').setAttribute('title', `Users with multiple visits: ${returningUsers}`);
  
  const topServiceElem = document.querySelector('#top-service .card-value');
  topServiceElem.textContent = topService;
  topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  topServiceElem.classList.add('h6-style'); 

   // Update online users count with view icon
  const onlineUsersElement = document.querySelector('#online-users .card-value');
  onlineUsersElement.innerHTML = `${onlineUserEmails.size} <i class="view-online-users fas fa-eye" title="View online users"></i>`;
  onlineUsersElement.setAttribute('title', `Active within 30 mins: ${onlineUserEmails.size}`);
  onlineUsersElement.setAttribute('data-emails', JSON.stringify(onlineUsersList));

  
  // Update users today count with view icon
  const usersTodayElement = document.querySelector('#users-today .card-value');
  usersTodayElement.innerHTML = `${usersToday} <i class="view-users-today fas fa-eye" title="View users active today"></i>`;
  usersTodayElement.setAttribute('title', `Users active today: ${usersToday}`);
  usersTodayElement.setAttribute('data-emails', JSON.stringify(todayUsersList));
  
  // Add click handler for the view icon
  // const viewIcon = document.querySelector('.view-online-users');
  // if (viewIcon) {
  //   viewIcon.addEventListener('click', function(e) {
  //     e.stopPropagation(); // Prevent triggering parent element click events
  //     showOnlineUsersList(onlineUsersList);
  //   });
  // }

  // Update returning users count with view icon
  const returningUsersElement = document.querySelector('#returning-users .card-value');
  returningUsersElement.innerHTML = `${returningUsersCount} <i class="view-returning-users fas fa-eye" title="View returning users"></i>`;
  returningUsersElement.setAttribute('title', `Users with multiple visits: ${returningUsersCount}`);
  returningUsersElement.setAttribute('data-emails', JSON.stringify(returningUsersList));
  
  // Add click handlers for each view icon
  setupViewIconHandlers();
  
  // Ensure the close handlers are properly set up
  setupModalCloseHandlers();
  
  
  console.log({ todayFormatted, usersToday, topService });
}


// Setup modal close handlers
function setupModalCloseHandlers() {
  ensureModalStructureExists();
  
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const closeBtn = document.getElementById('close-expanded');
  
  if (closeBtn) {
    closeBtn.onclick = function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    };
  }
  
  if (overlay) {
    overlay.onclick = function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    };
  }
}


function setupViewIconHandlers() {
  // Online users view icon
  const onlineViewIcon = document.querySelector('.view-online-users');
  if (onlineViewIcon) {
    onlineViewIcon.addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent triggering parent element click events
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Online Users');
      }
    });
  }
  
  // Users today view icon
  const todayViewIcon = document.querySelector('.view-users-today');
  if (todayViewIcon) {
    todayViewIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Users Active Today');
      }
    });
  }
  
  // Returning users view icon
  const returningViewIcon = document.querySelector('.view-returning-users');
  if (returningViewIcon) {
    returningViewIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Returning Users');
      }
    });
  }
}

// Unified function to show user lists (replaces showOnlineUsersList)
function showUsersList(emails, title) {
  ensureModalStructureExists();
  
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const expandedText = document.getElementById('expanded-text');
  const modalTitle = document.getElementById('modal-title');
  
  // Set the modal title
  //modalTitle.textContent = title;

  
  // Clear previous content
  expandedText.innerHTML = '';
  
  if (emails.length === 0) {
    const noUsers = document.createElement('p');
    noUsers.textContent = 'No Users Today';
    expandedText.appendChild(noUsers);
  } else {
    // Create list of emails
    const list = document.createElement('ul');
    list.className = 'online-users-list';
    
    emails.forEach(email => {
      const item = document.createElement('li');
      item.textContent = email;
      list.appendChild(item);
    });
    
    expandedText.appendChild(list);
  }
  
  // Show the overlay and expanded content
  overlay.style.display = 'block';
  expandedContent.style.display = 'block';
}


function ensureModalStructureExists() {
  // Check if the overlay and expanded content elements already exist
  if (!document.getElementById('overlay')) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    `;
    document.body.appendChild(overlay);
    
    // Create expanded content
    const expandedContent = document.createElement('div');
    expandedContent.id = 'expanded-content';
    expandedContent.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      min-width: 300px;
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    `;
    
    // Add content and close button to expanded content
    expandedContent.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 id="modal-title" style="margin: 0;">User List</h3>
        <button id="close-expanded" style="background: none; border: none; cursor: pointer; font-size: 18px;">√ó</button>
      </div>
      <div id="expanded-text"></div>
    `;
    
    document.body.appendChild(expandedContent);
  }
}


// Function to display the list of online users
function showOnlineUsersList(emails) {
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const expandedText = document.getElementById('expanded-text');
  const closeBtn = document.getElementById('close-expanded');
  
  // Clear previous content
  expandedText.innerHTML = '';
  
  // Create title
  const title = document.createElement('h3');
  title.textContent = 'Online Users';
  expandedText.appendChild(title);
  
  if (emails.length === 0) {
    const noUsers = document.createElement('p');
    noUsers.textContent = 'No users currently online';
    expandedText.appendChild(noUsers);
  } else {
    // Create list of emails
    const list = document.createElement('ul');
    list.className = 'online-users-list';
    
    emails.forEach(email => {
      const item = document.createElement('li');
      item.textContent = email;
      list.appendChild(item);
    });
    
    expandedText.appendChild(list);
  }
  
  // Show the overlay and expanded content
  overlay.style.display = 'block';
  expandedContent.style.display = 'block';
  
  // Ensure close button works
  closeBtn.onclick = function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  };
  
  // Ensure clicking on overlay also closes the modal
  overlay.onclick = function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  };
}


// Update the updateCharts function to include the summary
const originalUpdateCharts = updateCharts;
updateCharts = function(data) {
  originalUpdateCharts(data);
  updateDashboardSummary(data);
};

// Call this function when the page loads
window.addEventListener('load', function() {
  // Add the dashboard summary section
  addDashboardSummary();
});


// Function to create chart containers if they don't exist
function createChartContainers() {
  console.log("Setting up chart containers...");
  
  // Check if the charts container exists
  let chartsContainer = document.querySelector('.charts');
  
  // If it doesn't exist, create it
  if (!chartsContainer) {
    console.log("Creating charts container...");
    const rightPanel = document.querySelector('.right-panel');
    
    if (!rightPanel) {
      console.error("Right panel not found! Creating one...");
      const mainContainer = document.querySelector('.main-container');
      if (!mainContainer) {
        console.error("Main container not found! Creating the entire structure...");
        const body = document.body;
        
        // Create main container
        const newMainContainer = document.createElement('div');
        newMainContainer.className = 'main-container';
        
        // Create left panel
        const leftPanel = document.createElement('div');
        leftPanel.className = 'left-panel';
        
        // Create right panel
        const newRightPanel = document.createElement('div');
        newRightPanel.className = 'right-panel';
        
        // Create charts container
        chartsContainer = document.createElement('div');
        chartsContainer.className = 'charts';
        
        // Assemble structure
        newRightPanel.appendChild(chartsContainer);
        newMainContainer.appendChild(leftPanel);
        newMainContainer.appendChild(newRightPanel);
        
        // Add to body before any other content
        body.insertBefore(newMainContainer, body.firstChild);
      } else {
        const newRightPanel = document.createElement('div');
        newRightPanel.className = 'right-panel';
        chartsContainer = document.createElement('div');
        chartsContainer.className = 'charts';
        newRightPanel.appendChild(chartsContainer);
        mainContainer.appendChild(newRightPanel);
      }
    } else {
      chartsContainer = document.createElement('div');
      chartsContainer.className = 'charts';
      rightPanel.appendChild(chartsContainer);
    }
  }
  
  // Create/check individual chart containers
  const chartIds = ['barChart', 'lineChart', 'emailChart', 'pieChart'];
  const chartTitles = ['Sessions per Service', 'Sessions per Day', 'Unique Emails per Day', 'Service Distribution'];
  
  chartIds.forEach((id, index) => {
    if (!document.getElementById(id)) {
      console.log(`Creating chart container for ${id}...`);
      const chartBox = document.createElement('div');
      chartBox.className = 'chart-box';
      chartBox.innerHTML = `
        <h3>${chartTitles[index]}</h3>
        <canvas id="${id}"></canvas>
      `;
      chartsContainer.appendChild(chartBox);
    }
  });
  
 
  
  // Apply basic styling if needed
  if (!document.querySelector('style#chart-styles')) {
    const style = document.createElement('style');
    style.id = 'chart-styles';
    style.textContent = `
      .charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 30px;
        margin-bottom: 30px;
      }
      
      .chart-box {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      .chart-box h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
        text-align: center;
      }
      
      canvas {
        width: 100% !important;
        height: 300px !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  console.log("Chart containers setup complete!");
}



// Function to update charts based on data with detailed logging
function updateCharts(data) {
  console.log(`Updating charts with ${data.length} records...`);
  
  try {
    // Ensure Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error("Chart.js is not loaded! Charts cannot be rendered.");
      return;
    }
    
    // Clean up any existing charts to prevent memory leaks
    try {
      Chart.helpers.each(Chart.instances, function(instance) {
        instance.destroy();
      });
    } catch (e) {
      console.warn("Could not clean up existing charts", e);
    }
    
    // Update the individual charts
    try {
      updateSessionsPerServiceChart(data);
      console.log("Sessions per Service chart updated");
    } catch (e) {
      console.error("Error updating Sessions per Service chart:", e);
    }
    
    try {
      updateSessionsPerDayChart(data);
      console.log("Sessions per Day chart updated");
    } catch (e) {
      console.error("Error updating Sessions per Day chart:", e);
    }
    
    try {
      updateUniqueEmailsPerDayChart(data);
      console.log("Unique Emails per Day chart updated");
    } catch (e) {
      console.error("Error updating Unique Emails per Day chart:", e);
    }
    
    try {
      updateServiceDistributionChart(data);
      console.log("Service Distribution chart updated");
    } catch (e) {
      console.error("Error updating Service Distribution chart:", e);
    }
    
    try {
    //   updateUserActivityChart(data);
      console.log("User Activity chart updated");
    } catch (e) {
      console.error("Error updating User Activity chart:", e);
    }
    
    console.log("All charts updated successfully!");
  } catch (error) {
    console.error("Error in updateCharts function:", error);
  }
}

// 1. Bar Chart - Sessions per Service
function updateSessionsPerServiceChart(data) {
  const canvas = document.getElementById('barChart');
  if (!canvas) {
    console.error("Bar chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Count sessions per service
  const serviceCounts = {};
  data.forEach(item => {
    const service = item.service || 'Unknown';
    if (!serviceCounts[service]) {
      serviceCounts[service] = 0;
    }
    serviceCounts[service]++;
  });
  
  // Prepare chart data
  const labels = Object.keys(serviceCounts);
  const values = Object.values(serviceCounts);
  
  // Create color array
  const backgroundColors = labels.map((_, index) => {
    return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
  });
  
  // Create the chart
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Number of Sessions',
        data: values,
        backgroundColor: backgroundColors,
        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Sessions: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 2. Line Chart - Sessions per Day
function updateSessionsPerDayChart(data) {
  const canvas = document.getElementById('lineChart');
  if (!canvas) {
    console.error("Line chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Group sessions by day
  const sessionsPerDay = {};
  
  // Group sessions by day
  data.forEach(item => {
    // Extract date from the time field
    let dateStr = "";
    
    if (item.time && item.time.includes(" ")) {
      dateStr = item.time.split(" ")[0]; 
    } else if (item.date) {
      dateStr = item.date;
    }
    
    if (!dateStr) return;
    
    // Initialize counter for this date if not exists
    if (!sessionsPerDay[dateStr]) {
      sessionsPerDay[dateStr] = 0;
    }
    
    sessionsPerDay[dateStr]++;
  });
  
  // Sort dates chronologically
  const sortedDates = Object.keys(sessionsPerDay).sort((a, b) => new Date(a) - new Date(b));
  
  // Prepare chart data
  const chartData = {
    labels: sortedDates,
    datasets: [{
      label: 'Number of Sessions',
      data: sortedDates.map(date => sessionsPerDay[date]),
      fill: false,
      borderColor: 'rgba(75, 192, 192, 1)',
      tension: 0.1,
      pointBackgroundColor: 'rgba(75, 192, 192, 1)',
      pointRadius: 4
    }]
  };
  
  // Create the chart
  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Sessions: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 3. Line Chart - Unique Emails per Day
function updateUniqueEmailsPerDayChart(data) {
  const canvas = document.getElementById('emailChart');
  if (!canvas) {
    console.error("Email chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Group emails by day
  const emailsByDay = {};
  
  // Group emails by day
  data.forEach(item => {
    // Extract date from the time field
    let dateStr = "";
    
    if (item.time && item.time.includes(" ")) {
      dateStr = item.time.split(" ")[0]; 
    } else if (item.date) {
      dateStr = item.date;
    }
    
    if (!dateStr || !item.email) return;
    
    // Initialize set for this date if not exists
    if (!emailsByDay[dateStr]) {
      emailsByDay[dateStr] = new Set();
    }
    
    // Add email to the set (sets only keep unique values)
    emailsByDay[dateStr].add(item.email);
  });
  
  // Sort dates chronologically
  const sortedDates = Object.keys(emailsByDay).sort((a, b) => new Date(a) - new Date(b));
  
  // Prepare chart data
  const chartData = {
    labels: sortedDates,
    datasets: [{
      label: 'Unique Emails',
      data: sortedDates.map(date => emailsByDay[date].size),
      fill: false,
      borderColor: '#87CEEB',
      tension: 0.1,
      pointBackgroundColor: '#87CEEB',
      pointRadius: 4
    }]
  };
  
  // Create the chart
  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Unique Emails: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 4. Pie Chart - Service Distribution
function updateServiceDistributionChart(data) {
  const canvas = document.getElementById('pieChart');
  if (!canvas) {
    console.error("Pie chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Count users per service
  const serviceCounts = {};
  
  // Count users per service
  data.forEach(item => {
    const service = item.service || 'Unknown';
    if (!serviceCounts[service]) {
      serviceCounts[service] = 0;
    }
    serviceCounts[service]++;
  });
  
  // Prepare chart data
  const labels = Object.keys(serviceCounts);
  const values = Object.values(serviceCounts);
  
  // Create color array
  const backgroundColors = labels.map((_, index) => {
    return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
  });
  
  // Create the chart
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: backgroundColors,
        borderColor: '#ffffff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            boxWidth: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}



// // 5. User Activity Chart - User Activity Timeline
// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }
  
//   const ctx = canvas.getContext('2d');
  
//   // Process the data to create a timeline of activity
//   const activityByHour = {};
  
//   // Initialize hours (0-23) with zero count
//   for (let i = 0; i < 24; i++) {
//     activityByHour[i] = 0;
//   }
  
//   // Count activities by hour
//   data.forEach(item => {
//     let hourOfDay = 0;
    
//     if (item.time) {
//       let timeStr = item.time;
//       if (item.time.includes(" ")) {
//         timeStr = item.time.split(" ")[1]; // Get the time part
//       }
      
//       // Extract hour from the time string (assuming format HH:MM:SS)
//       const hourMatch = timeStr.match(/^(\d{1,2}):/);
//       if (hourMatch) {
//         hourOfDay = parseInt(hourMatch[1]);
//       }
//     }
    
//     // Increment counter for this hour
//     activityByHour[hourOfDay]++;
//   });
  
//   // Prepare chart data
//   const hours = Object.keys(activityByHour).map(Number).sort((a, b) => a - b);
//   const activityCounts = hours.map(hour => activityByHour[hour]);
  
//   // Format hour labels (00:00, 01:00, etc.)
//   const hourLabels = hours.map(hour => {
//     const formattedHour = hour.toString().padStart(2, '0');
//     return `${formattedHour}:00`;
//   });
  
//   // Create the chart
//   new Chart(ctx, {
//     type: 'bar',
//     data: {
//       labels: hourLabels,
//       datasets: [{
//         label: 'User Activity',
//         data: activityCounts,
//         backgroundColor: 'rgba(153, 102, 255, 0.6)',
//         borderColor: 'rgba(153, 102, 255, 1)',
//         borderWidth: 1
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       scales: {
//         y: {
//           beginAtZero: true,
//           ticks: {
//             precision: 0
//           },
//           title: {
//             display: true,
//             text: 'Number of Sessions'
//           }
//         },
//         x: {
//           title: {
//             display: true,
//             text: 'Hour of Day'
//           }
//         }
//       },
//       plugins: {
//         title: {
//           display: true,
//           text: 'User Activity Distribution by Hour'
//         },
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               return `Sessions: ${context.raw}`;
//             }
//           }
//         }
//       }
//     }
//   });
// }

// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }

//   const ctx = canvas.getContext('2d');

//   const serviceStats = {};

//   data.forEach(item => {
//     const service = item.service || "Unknown";
//     if (!serviceStats[service]) {
//       serviceStats[service] = { sessions: 0, users: new Set() };
//     }
//     serviceStats[service].sessions += 1;
//     if (item.email) {
//       serviceStats[service].users.add(item.email);
//     }
//   });

//   const bubbleData = Object.entries(serviceStats).map(([service, stats]) => ({
//     x: stats.sessions,
//     y: stats.users.size,
//     r: Math.sqrt(stats.sessions) + 5, // Bubble radius (scaled)
//     serviceName: service
//   }));

//   new Chart(ctx, {
//     type: 'bubble',
//     data: {
//       datasets: [{
//         label: 'Service Engagement',
//         data: bubbleData,
//         backgroundColor: 'rgba(54, 162, 235, 0.5)',
//         borderColor: 'rgba(54, 162, 235, 1)',
//         borderWidth: 1,
//         parsing: false
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       plugins: {
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               const { x, y, r, serviceName } = context.raw;
//               return [
//                 `Service: ${serviceName}`,
//                 `Sessions: ${x}`,
//                 `Users: ${y}`,
//                 `Bubble Size: ${r.toFixed(1)}`
//               ];
//             }
//           }
//         },
//         title: {
//           display: true,
//           text: 'Service vs Sessions vs Users (Bubble Chart)'
//         }
//       },
//       scales: {
//         x: {
//           title: {
//             display: true,
//             text: 'Sessions'
//           },
//           beginAtZero: true
//         },
//         y: {
//           title: {
//             display: true,
//             text: 'Unique Users'
//           },
//           beginAtZero: true
//         }
//       }
//     }
//   });
// }


// Call initialization
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeCharts);
} else {
  initializeCharts();
}


// Call loadUserData when the page loads
window.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, initializing dashboard...");
  loadUserData();
//   addDashboardSummary();
});


    // Add these event listeners after existing event listeners in your JS code
    document.getElementById("downloadUserInfo").addEventListener("click", function() {
    openUserInfoPage();
    });

    document.getElementById("downloadUserDetails").addEventListener("click", function() {
    openUserDetailsPages();
    });

    // Function to open a new page with user information
    async function openUserInfoPage() {
    try {
        // Load data from Firestore
        const snapshot = await db.collection("testrig_UserDetails").get();
        let userData = [];
        
        snapshot.forEach(doc => {
        userData.push(doc.data());
        });
        
        // Generate HTML content
        const htmlContent = generateUserInfoHTML(userData);
        
        // Open new window with the content
        const newWindow = window.open('', '_blank');
        newWindow.document.write(htmlContent);
        newWindow.document.close();
    } catch (error) {
        console.error("Error opening user info page:", error);
        alert("Error loading user information. Please try again.");
    }
    }

    // Function to open a new page with user details (queries)
    async function openUserDetailsPage() {
    try {
        // Load data from Firestore
        const snapshot = await db.collection("testrig_queries").get();
        let queryData = [];
        
        snapshot.forEach(doc => {
        queryData.push(doc.data());
        });
        
        // Generate HTML content
        const htmlContent = generateUserDetailsHTML(queryData);
        
        // Open new window with the content
        const newWindow = window.open('', '_blank');
        newWindow.document.write(htmlContent);
        newWindow.document.close();
    } catch (error) {
        console.error("Error opening user details page:", error);
        alert("Error loading user details. Please try again.");
    }
    }



function generateUserInfoHTML(userData) {
    // Normalize and sort data by datetime (descending)
    const sortedData = userData.map(user => {
        let rawTime = user.time || user.date || "";
        let date = "";
        let time = "";
        let dateObj = null;

        if (rawTime.includes("T")) {
            // Format: 2025-04-14T18:54:10
            [date, time] = rawTime.split("T");
            dateObj = new Date(`${date}T${time}`);
        } else if (rawTime.includes(" ")) {
            // Format: 2025-04-22 11:16:18
            [date, time] = rawTime.split(" ");
            dateObj = new Date(`${date}T${time}`);
        } else {
            // Fallback (if no recognizable format)
            date = rawTime;
            time = "";
            dateObj = new Date(date);
        }

        return {
            ...user,
            formattedDate: date,
            formattedTime: time,
            dateObj: dateObj
        };
    }).sort((a, b) => b.dateObj - a.dateObj); // Descending sort

    // Generate table rows
    const tableRows = sortedData.map(user => `
        <tr>
            <td>${user.username || ""}</td>
            <td>${user.email || ""}</td>
            <td>${user.service || ""}</td>
            <td>${user.session_id || user.sessionid || ""}</td>
            <td>${user.formattedDate}</td>
            <td>${user.formattedTime}</td>
        </tr>
    `).join('');

    // Return full HTML with logo instead of title text and smaller font for table
    return `
        <html>
        <head>
            <title>User Info</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                .header {
                    display: flex;
                    align-items: center;
                    margin-bottom: 20px;
                }
                .logo-img {
                    height: 40px;
                    margin-right: 15px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.85em; /* Smaller font size for table */
                }
                th, td {
                    border: 1px solid #ccc;
                    padding: 6px; /* Reduced padding */
                    text-align: left;
                }
                th {
                    background-color: #f2f2f2;
                    font-weight: bold;
                }
                h2 {
                    margin: 0;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
                <h2>User Information</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Service</th>
                        <th>Session ID</th>
                        <th>Date</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </body>
        </html>
    `;
}
// Helper function to parse timestamp for comparison (ignoring seconds)
function parseTimestampForComparison(timeStr) {
  if (!timeStr) return null;
  
  let date;
  
  // Handle format "2025-04-17 10:36:57"
  if (typeof timeStr === 'string' && timeStr.includes(' ')) {
    const [dateStr, timeStrPart] = timeStr.split(' ');
    const [year, month, day] = dateStr.split('-').map(Number);
    const [hours, minutes] = timeStrPart.split(':').map(Number);
    date = new Date(year, month - 1, day, hours, minutes, 0);
    return date;
  }
  
  // Handle ISO format "2025-04-15T12:46:23.657471"
  if (typeof timeStr === 'string' && timeStr.includes('T')) {
    date = new Date(timeStr);
    // Zero out the seconds for comparison
    date.setSeconds(0, 0);
    return date;
  }
  
  // Try to parse as generic date string
  try {
    date = new Date(timeStr);
    date.setSeconds(0, 0);
    return date;
  } catch (e) {
    console.error("Error parsing timestamp:", e);
    return null;
  }
}

// Helper function to format timestamp for display
function formatTimestamp(date) {
  if (!date) return "";
  return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
}

// Helper to pad numbers with leading zero
function padZero(num) {
  return num.toString().padStart(2, '0');
}

// Helper to truncate text for display
function truncateText(text, maxLength) {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + "...";
}

// working
// function generateCombinedDetailsHTML(userData, queryData) {
//   // Normalize timestamp formats for both datasets
//   const normalizedUserData = userData.map(user => {
//     let timestamp = parseTimestampForComparison(user.time || user.date || "");
//     return {
//       ...user,
//       sessionId: user.session_id || user.sessionid || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });
  
//   const normalizedQueryData = queryData.map(query => {
//     let timestamp;
//     if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
//       timestamp = query.timestamp.toDate();
//     } else {
//       timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
//     }
//     return {
//       ...query,
//       sessionId: query.sessionId || query.session_id || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });
  
//   // Group queries by session ID for quicker lookup
//   const queryBySessionId = {};
//   normalizedQueryData.forEach(query => {
//     if (query.sessionId) {
//       queryBySessionId[query.sessionId] = query;
//     }
//   });
  
//   // Combine data with session ID matching first, then timestamp matching
//   const combinedData = [];
  
//   normalizedUserData.forEach(user => {
//     // First try to match by session ID
//     if (user.sessionId && queryBySessionId[user.sessionId]) {
//       const query = queryBySessionId[user.sessionId];
//       combinedData.push({
//         username: user.username || "",
//         email: user.email || "",
//         service: user.service || "",
//         sessionId_user: user.sessionId,
//         sessionId_query: query.sessionId,
//         userTime: user.timeString,
//         queryTime: query.timeString,
//         query_by_bot1: query.query_by_bot1 || "",
//         response_by_bot1: query.response_by_bot1 || "",
//         query_by_bot2: query.query_by_bot2 || "",
//         response_by_bot2: query.response_by_bot2 || "",
//         query_by_bot3: query.query_by_bot3 || "",
//         response_by_bot3: query.response_by_bot3 || ""
//       });
//     } else {
//       // If session ID doesn't match, try time-based matching
//       const userTime = user.normalizedTime;
//       if (!userTime) {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//         return;
//       }
      
//       // Find matching queries within 3-minute window
//       const matchingQueries = normalizedQueryData.filter(query => {
//         const queryTime = query.normalizedTime;
//         if (!queryTime) return false;
        
//         // Compare timestamps with 3-minute window (180000 ms)
//         const timeDiff = Math.abs(userTime - queryTime);
//         return timeDiff <= 180000; // 3 minutes in milliseconds
//       });
      
//       if (matchingQueries.length > 0) {
//         // Use the closest matching query by time
//         matchingQueries.sort((a, b) => {
//           const diffA = Math.abs(userTime - a.normalizedTime);
//           const diffB = Math.abs(userTime - b.normalizedTime);
//           return diffA - diffB;
//         });
        
//         const closestQuery = matchingQueries[0];
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: closestQuery.sessionId,
//           userTime: user.timeString,
//           queryTime: closestQuery.timeString,
//           query_by_bot1: closestQuery.query_by_bot1 || "",
//           response_by_bot1: closestQuery.response_by_bot1 || "",
//           query_by_bot2: closestQuery.query_by_bot2 || "",
//           response_by_bot2: closestQuery.response_by_bot2 || "",
//           query_by_bot3: closestQuery.query_by_bot3 || "",
//           response_by_bot3: closestQuery.response_by_bot3 || ""
//         });
//       } else {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//       }
//     }
//   });

//   const tableRows = combinedData.map(item => `
//     <tr>
//       <td>${escapeHtml(item.username)}</td>
//       <td>${escapeHtml(item.email)}</td>
//       <td>${escapeHtml(item.service)}</td>
//       <td>${escapeHtml(item.sessionId_user)}</td>
//       <td>${escapeHtml(item.sessionId_query)}</td>
//       <td>${escapeHtml(item.userTime)}</td>
//       <td>${escapeHtml(item.queryTime)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
//     </tr>
//   `).join('');
//   return `
//         <html>
//         <head>
//             <title>User Details</title>
//             <style>
//                 table { width: 100%; border-collapse: collapse; }
//                 .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
//                 .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
//                 .overlay { background: rgba(0,0,0,0.5); }
//                 .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
//                 .close-button { float: right; cursor: pointer; font-size: 20px; }
            

//                 body {
//                     font-family: Arial, sans-serif;
//                     margin: 20px;
//                 }
//                 .header {
//                     display: flex;
//                     align-items: center;
//                     margin-bottom: 20px;
//                 }
//                 .logo-img {
//                     height: 40px;
//                     margin-right: 15px;
//                 }
//                 table {
//                     width: 100%;
//                     border-collapse: collapse;
//                     font-size: 0.85em; /* Smaller font size for table */
//                 }
//                 th, td {
//                     border: 1px solid #ccc;
//                     padding: 6px;
//                     text-align: left;
//                 }
//                 th {
//                     background-color: #f2f2f2;
//                     font-weight: bold;
//                 }
//                 h2 {
//                     margin: 0;
//                 }
//             </style>
//         </head>
//         <body>
//             <div class="header">
//                 <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
//                 <h2>User Information</h2>
//             </div>
//             <table id="dataTable">
//         <thead>
//           <tr>
//             <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
//             <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
//             <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
//           </tr>
//         </thead>
//         <tbody>${tableRows}</tbody>
//       </table>
//       <div id="overlay" class="overlay"></div>
//       <div id="expanded-content" class="expanded-content">
//         <span id="close-expanded" class="close-button">&times;</span>
//         <div id="expanded-text"></div>
//       </div>
//         </body>
//         </html>
//     `;
//     document.addEventListener("DOMContentLoaded", function() {
//           const expandableCells = document.querySelectorAll('.expandable-cell');
//           const overlay = document.getElementById('overlay');
//           const expandedContent = document.getElementById('expanded-content');
//           const expandedText = document.getElementById('expanded-text');
//           const closeBtn = document.getElementById('close-expanded');

//           expandableCells.forEach(cell => {
//             cell.addEventListener('click', function() {
//               const content = decodeURIComponent(this.getAttribute('data-content'));
//               expandedText.innerHTML = content;
//               overlay.style.display = 'block';
//               expandedContent.style.display = 'block';
//             });
//           });

//           closeBtn.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           overlay.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           document.getElementById('exportExcel').addEventListener('click', function() {
//             const table = document.getElementById('dataTable');
//             const wb = XLSX.utils.table_to_book(table);
//             XLSX.writeFile(wb, 'UserDetails.xlsx');
//             });
//             });
//    }

    function generateCombinedDetailsHTML(userData, queryData) {
      // Normalize timestamp formats for both datasets
      const normalizedUserData = userData.map(user => {
        let timestamp = parseTimestampForComparison(user.time || user.date || "");
        return {
          ...user,
          sessionId: user.session_id || user.sessionid || "",
          normalizedTime: timestamp,
          timeString: formatTimestamp(timestamp)
        };
      });
      
      const normalizedQueryData = queryData.map(query => {
        let timestamp;
        if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
          timestamp = query.timestamp.toDate();
        } else {
          timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
        }
        return {
          ...query,
          sessionId: query.sessionId || query.session_id || "",
          normalizedTime: timestamp,
          timeString: formatTimestamp(timestamp)
        };
      });
      
      // Group queries by session ID
      const queryBySessionId = {};
      normalizedQueryData.forEach(query => {
        if (query.sessionId) {
          queryBySessionId[query.sessionId] = query;
        }
      });

      const combinedData = [];

      normalizedUserData.forEach(user => {
        if (user.sessionId && queryBySessionId[user.sessionId]) {
          const query = queryBySessionId[user.sessionId];
          combinedData.push({
            ...combineUserQuery(user, query)
          });
        } else {
          const userTime = user.normalizedTime;
          if (!userTime) {
            combinedData.push({
              ...combineUserQuery(user, null)
            });
            return;
          }

          const matchingQueries = normalizedQueryData.filter(query => {
            const queryTime = query.normalizedTime;
            if (!queryTime) return false;
            const timeDiff = Math.abs(userTime - queryTime);
            return timeDiff <= 180000;
          });

          if (matchingQueries.length > 0) {
            matchingQueries.sort((a, b) => {
              const diffA = Math.abs(userTime - a.normalizedTime);
              const diffB = Math.abs(userTime - b.normalizedTime);
              return diffA - diffB;
            });
            const closestQuery = matchingQueries[0];
            combinedData.push({
              ...combineUserQuery(user, closestQuery)
            });
          } else {
            combinedData.push({
              ...combineUserQuery(user, null)
            });
          }
        }
      });

      // Sort by the latest time (descending)
      combinedData.sort((a, b) => {
        const timeA = parseTimestampForComparison(a.userTime || a.queryTime);
        const timeB = parseTimestampForComparison(b.userTime || b.queryTime);
        return timeB - timeA;
      });

      const tableRows = combinedData.map(item => `
        <tr>
          <td>${escapeHtml(item.username)}</td>
          <td>${escapeHtml(item.email)}</td>
          <td>${escapeHtml(item.service)}</td>
          <td>${escapeHtml(item.sessionId_user)}</td>
          <td>${escapeHtml(item.sessionId_query)}</td>
          <td>${escapeHtml(item.userTime)}</td>
          <td>${escapeHtml(item.queryTime)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
        </tr>
      `).join('');

      return `
        <html>
        <head>
          <title>User Details</title>
          <style>
             table { width: 100%; border-collapse: collapse; }
                .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
                .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
                .overlay { background: rgba(0,0,0,0.5); }
                .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
                .close-button { float: right; cursor: pointer; font-size: 20px; }
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { display: flex; align-items: center; margin-bottom: 20px; }
            .logo-img { height: 60px; margin-right: 15px; }
            table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            h2 { margin: 0; }
          </style>
        </head>
        <body>
          <div class="header">
            <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
            <h2>User Information</h2>
          </div>
          <table id="dataTable">
            <thead>
              <tr>
                <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
                <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
                <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </body>
        </html>
      `;

      // Helper function to merge user and query into one object
      function combineUserQuery(user, query) {
        return {
          username: user.username || "",
          email: user.email || "",
          service: user.service || "",
          sessionId_user: user.sessionId,
          sessionId_query: query?.sessionId || "",
          userTime: user.timeString,
          queryTime: query?.timeString || "",
          query_by_bot1: query?.query_by_bot1 || "",
          response_by_bot1: query?.response_by_bot1 || "",
          query_by_bot2: query?.query_by_bot2 || "",
          response_by_bot2: query?.response_by_bot2 || "",
          query_by_bot3: query?.query_by_bot3 || "",
          response_by_bot3: query?.response_by_bot3 || ""
        };
      }
    }

  document.addEventListener('DOMContentLoaded', function () {
    const downloadIcon1 = document.querySelector('.download-icon');

    if (downloadIcon1) {
      downloadIcon1.addEventListener('click', function () {
        exportUserInfoAsExcel();
      });
    }
  });


  function exportUserInfoAsExcel() {
    const table = document.getElementById("data-table");
    if (!table) return;

    const clonedTable = table.cloneNode(true);

    const headers = Array.from(clonedTable.querySelectorAll("thead tr th"));
    const dateColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "date");
    const timeColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "time");

    if (dateColIndex === -1 || timeColIndex === -1) {
      alert("Date or Time column not found!");
      return;
    }

    const rows = Array.from(clonedTable.querySelectorAll("tbody tr"));

    const rowsWithDatetime = rows.map(row => {
      const cells = row.querySelectorAll("td");
      const timeVal = cells[timeColIndex].textContent.trim();
      const currentDateVal = cells[dateColIndex].textContent.trim();

      let date = "";
      let time = "";

      if (timeVal.includes("T")) {
        [date, time] = timeVal.split("T");
      } else if (timeVal.includes(" ")) {
        [date, time] = timeVal.split(" ");
      } else {
        time = timeVal;
      }

      // Only update Date column if it's empty
      if (!currentDateVal) {
        cells[dateColIndex].textContent = date;
      }

      // Always update the Time column to just time part
      cells[timeColIndex].textContent = time;

      // Use date from Time column if available, else fall back to existing Date column
      const fullDateStr = date || currentDateVal;
      const fullDateTime = new Date(`${fullDateStr}T${time}`);

      return { row, datetime: fullDateTime };
    });

    // Sort in descending order
    rowsWithDatetime.sort((a, b) => b.datetime - a.datetime);

    const tbody = clonedTable.querySelector("tbody");
    tbody.innerHTML = "";
    rowsWithDatetime.forEach(({ row }) => tbody.appendChild(row));

    const wb = XLSX.utils.table_to_book(clonedTable, { sheet: "User Info" });
    XLSX.writeFile(wb, "User_Information.xlsx");
  }

// Function to open a new page with combined user details
async function openUserDetailsPages() {
  try {
    document.body.style.cursor = 'wait'; // Show waiting cursor
    
    // Load data from both Firestore collections
    const userSnapshot = await db.collection("testrig_UserDetails").get();
    const querySnapshot = await db.collection("testrig_queries").get();
    
    let userData = [];
    let queryData = [];
    
    userSnapshot.forEach(doc => {
      userData.push(doc.data());
    });
    
    querySnapshot.forEach(doc => {
      queryData.push(doc.data());
    });
    
    // Generate HTML content with combined data
    const htmlContent = generateCombinedDetailsHTML(userData, queryData);
    
    // Open new window with the content
    const newWindow = window.open('', '_blank');
    newWindow.document.write(htmlContent);
    newWindow.document.close();
    document.body.style.cursor = 'default'; // Reset cursor
  } catch (error) {
    console.error("Error opening combined details page:", error);
    alert("Error loading combined user details. Please try again.");
    document.body.style.cursor = 'default'; // Reset cursor
  }
}
document.getElementById("refreshBtn").addEventListener("click", () => {
  location.reload();
});

function escapeHtml(str) {
  return str?.replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;',
    '"': '&quot;', "'": '&#039;'
  })[m]) || '';
}
</script>
</body>
</html>



==============


alloy

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Alloy Dashboard</title>
  <link rel="stylesheet" href="dash.css"/>
<!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
  <div class="main-container">
    <!-- LEFT PANEL -->
    <div class="left-panel">
        <div class="downloads-section">
            <h3>Downloads</h3>
          
            <div class="download-item">
              <button id="downloadUserInfo">Users Information</button>
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icon" class="download-icon">
            </div>
          
            <div class="download-item">
              <button id="downloadUserDetails">User Details</button>
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icons" class="download-icons"> 
            </div>
          </div>
          <!-- <div class="download-item">
            <button id="downloadUserDetails">
              <img src="https://storage.googleapis.com/testrig-bot-static-files/download-icon.png" alt="Download Icon" class="download-icons">
              User Details
            </button>
          </div> -->
          
          
          <div class="filter-container">
            <h3>Filters</h3>
            <div class="filter-group">
              <label>Start Date:</label>
              <input type="date" id="startDate">
              <label>End Date</label>
              <input type="date" id="endDate">
            </div>
          
            <div class="filter-group">
              <label for="serviceFilter">Service:</label>
              <select id="serviceFilter">
                <option value="">All Services</option>
              </select>
            </div>
          
            <div class="filter-group">
              <button id="applyFilters">Apply</button>
              <button id="resetFilters">Reset</button>
              <!-- <button id="showFilteredData">Filtered Visitors Details</button> -->
            </div>
          </div>
          
          <!-- <button id="toggleTableBtn">User Info</button> -->
          <div id="tableContainer">
            <div class="loader" id="tableLoader"></div>
            <button id="downloadCsv">Download CSV</button>
            <button id="downloadExcel">Download Excel</button>
            <table id="data-table">
              <thead>
                <tr>
                  <th>Username</th><th>Email</th><th>Service</th>
                  <th>Session ID</th><th>Date</th><th>Time</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
    
          

    </div>
    <!-- RIGHT PANEL -->
    <div class="right-panel">
        <div class="top-bar">
            <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
          
            <div class="top-right-controls">
              <div class="search-box">
                <!-- <input type="text" id="searchInput" placeholder="Search for anything..." /> -->
                <button id="searchBtn"></button>
                <button id="clearSearch"></button>
                <img 
            src="https://storage.googleapis.com/testrig-bot-static-files/refresh.JPG" 
            style="width: 23px; height: 23px; border-radius: 50%; object-fit: cover; cursor: pointer;transform: translateY(30%);" 
            alt="Refresh" 
            id="refreshBtn"
            />
              </div>
            </div>
            
          </div>
        
      <div class="charts">
        <div class="chart-box">
          <h3>Sessions per Service</h3>
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Sessions per Day</h3>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Unique Emails per Day</h3>
          <canvas id="emailChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Service Distribution</h3>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>
  <div class="expanded-content" id="expanded-content">
    <span class="close-expanded" id="close-expanded">&times;</span>
    <div id="expanded-text"></div>
  </div>
  


<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDutX02xinG0RmqoXx6k8eWznlzaHwAgsE",
        authDomain: "chat-bot-project-452312.firebaseapp.com",
        projectId: "chat-bot-project-452312",
        storageBucket: "chat-bot-project-452312.firebasestorage.app",
        messagingSenderId: "61875479783",
        appId: "1:61875479783:web:4dc5ce48b44aa43ec22e42"
    };



  // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  // Global variables to store data
  let allUserData = [];
  let allQueryData = [];
  let combinedData = [];
  let filteredData = [];

 // Improved applyFilters function to filter data and update charts
function applyFilters() {
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;
  const serviceFilter = document.getElementById("serviceFilter").value;
  
  console.log("Applying filters:", startDateStr, endDateStr, serviceFilter);
  
  // Create Date objects for comparison (set to start/end of day)
  let startDate = null;
  let endDate = null;
  
  if (startDateStr) {
    startDate = new Date(startDateStr);
    startDate.setHours(0, 0, 0, 0);
  }
  
  if (endDateStr) {
    endDate = new Date(endDateStr);
    endDate.setHours(23, 59, 59, 999);
  }
  
  // Filter the data based on selected criteria
  filteredData = allUserData.filter(item => {
    // Parse the timestamp from the item
    let itemDate = null;
    
    // Handle different date formats
    if (item.time && typeof item.time === 'string') {
      if (item.time.includes(' ')) {
        // Format: "2025-04-17 10:36:57"
        const [dateStr, timeStr] = item.time.split(' ');
        itemDate = new Date(dateStr);
      } else if (item.time.includes('T')) {
        // ISO format
        itemDate = new Date(item.time);
      }
    } else if (item.date) {
      // Just date field
      itemDate = new Date(item.date);
    }
    
    // Check if date is in range
    let passesDateFilter = true;
    if (startDate && itemDate && itemDate < startDate) {
      passesDateFilter = false;
    }
    if (endDate && itemDate && itemDate > endDate) {
      passesDateFilter = false;
    }
    
    // Check if service matches
    let passesServiceFilter = true;
    if (serviceFilter && item.service !== serviceFilter) {
      passesServiceFilter = false;
    }
    
    return passesDateFilter && passesServiceFilter;
  });
  
  console.log(`Data filtered: ${filteredData.length} records match criteria`);
  
  // Update the table with filtered data
  updateTableWithFilteredData(filteredData);
  
  // Update charts with filtered data
  updateCharts(filteredData);
}

    // Function to update the table with filtered data
    function updateTableWithFilteredData(data) {
      const tableBody = document.getElementById("table-body");
      tableBody.innerHTML = "";
      
      if (data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='6'>No data matches the selected filters</td></tr>";
        return;
      }
      
      data.forEach(item => {
        // Split datetime into date and time parts if needed
        let date = "";
        let time = "";
        
        if (item.time && item.time.includes(" ")) {
          const timeParts = item.time.split(" ");
          date = timeParts[0];
          time = timeParts[1];
        } else {
          date = item.date || "";
          time = item.time || "";
        }
        
        const row = `
          <tr>
            <td>${item.username || ""}</td>
            <td>${item.email || ""}</td>
            <td>${item.service || ""}</td>
            <td>${item.session_id || item.sessionid || ""}</td>
            <td>${date}</td>
            <td>${time}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    // Update the event listener for the Apply button
    document.getElementById("applyFilters").addEventListener("click", function() {
      applyFilters();
    });

    // Update the event listener for the Reset button
    document.getElementById("resetFilters").addEventListener("click", function() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("serviceFilter").value = "";
      
      // Reset to show all data
      filteredData = allUserData;
      updateTableWithFilteredData(allUserData);
      updateCharts(allUserData);
    });


  // Helper function to parse timestamp
  function parseTimestamp(timeStr) {
    if (!timeStr) return null;
    
    // Handle format "2025-04-17 10:36:57"
    const dateParts = timeStr.split(' ');
    if (dateParts.length === 2) {
      const [dateStr, timeStr] = dateParts;
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes, seconds);
    }
    
    // Try to parse as ISO string
    try {
      return new Date(timeStr);
    } catch (e) {
      console.error("Error parsing timestamp:", e);
      return null;
    }
  }



  
  // Load user data from Firestore
  async function loadUserData() {
    try {
      document.getElementById("tableLoader").style.display = "block";
      const snapshot = await db.collection("testAlloy_UserDetails").get();
      const tableBody = document.getElementById("table-body");
      tableBody.innerHTML = "";
      allUserData = [];

      if (snapshot.empty) {
        tableBody.innerHTML = "<tr><td colspan='6'>No data available</td></tr>";
        document.getElementById("tableLoader").style.display = "none";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        // Store data for filtering
        allUserData.push(data);
        
        // Check if time field contains both date and time
        let date = "";
        let time = "";
        
        if (data.time && data.time.includes(" ")) {
          // Split datetime into date and time parts
          const timeParts = data.time.split(" ");
          date = timeParts[0];
          time = timeParts[1];
        } else {
          // If separate fields exist, use them
          date = data.date || "";
          time = data.time || "";
        }
        
        const row = `
          <tr>
            <td>${data.username || ""}</td>
            <td>${data.email || ""}</td>
            <td>${data.service || ""}</td>
            <td>${data.session_id || data.sessionid || ""}</td>
            <td>${date}</td>
            <td>${time}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
      
      // Populate service dropdown with unique services
      populateServiceDropdown();
      
      // Update charts
      updateCharts(allUserData);
      
      document.getElementById("tableLoader").style.display = "none";
    } catch (error) {
      console.error("Error loading user data: ", error);
      document.getElementById("table-body").innerHTML = 
        "<tr><td colspan='6'>Error loading data. Please try again.</td></tr>";
      document.getElementById("tableLoader").style.display = "none";
    }
  }

  // Function to initialize charts
 function initializeCharts() {
   console.log("Initializing charts");
  
  // Check if Chart.js is loaded
   if (typeof Chart === 'undefined') {
     console.error("Chart.js not loaded! Adding it now...");
    
    // Load Chart.js dynamically if not already loaded
     const script = document.createElement('script');
     script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
     script.onload = function() {
      console.log("Chart.js loaded successfully!");
      // Create chart containers if they don't exist
      createChartContainers();
    };
    document.head.appendChild(script);
  } else {
    console.log("Chart.js already loaded!");
    // Create chart containers if they don't exist
    createChartContainers();
  }
 }
  
  // Load query data from Firestore
  async function loadQueryData() {
    try {
      document.getElementById("chatLoader").style.display = "block";
      const snapshot = await db.collection("testalloy_queries").get();
      const chatBody = document.getElementById("chat-body");
      chatBody.innerHTML = "";
      allQueryData = [];

      if (snapshot.empty) {
        chatBody.innerHTML = "<tr><td colspan='5'>No chat data available</td></tr>";
        document.getElementById("chatLoader").style.display = "none";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        // Store data for combining
        allQueryData.push(data);
        
        // Format timestamp
        let formattedTime = "";
        if (data.timestamp) {
          const timestamp = typeof data.timestamp === 'object' && data.timestamp.toDate ? 
                            data.timestamp.toDate() : 
                            new Date(data.timestamp);
          formattedTime = timestamp.toLocaleString();
        }
        
        const row = `
          <tr>
            <td>${data.session_id || ""}</td>
            <td class="expandable-cell" data-content="${encodeURIComponent(data.query || "")}">
              <span class="truncate">${data.query || ""}</span>
            </td>
            <td class="expandable-cell" data-content="${encodeURIComponent(data.response || "")}">
              <span class="truncate">${data.response || ""}</span>
            </td>
            <td>${data.bot || ""}</td>
            <td>${formattedTime}</td>
          </tr>
        `;
        chatBody.innerHTML += row;
      });
      
      // Add click handlers for expandable cells
      setupExpandableCells();
      
      document.getElementById("chatLoader").style.display = "none";
    } catch (error) {
      console.error("Error loading query data: ", error);
      document.getElementById("chat-body").innerHTML = 
        "<tr><td colspan='5'>Error loading chat data. Please try again.</td></tr>";
      document.getElementById("chatLoader").style.display = "none";
    }
  }

  // Setup handlers for expandable cells
  function setupExpandableCells() {
    const expandableCells = document.querySelectorAll('.expandable-cell');
    const overlay = document.getElementById('overlay');
    const expandedContent = document.getElementById('expanded-content');
    const expandedText = document.getElementById('expanded-text');
    const closeBtn = document.getElementById('close-expanded');
    
    expandableCells.forEach(cell => {
      cell.addEventListener('click', function() {
        const content = decodeURIComponent(this.getAttribute('data-content'));
        expandedText.textContent = content;
        overlay.style.display = 'block';
        expandedContent.style.display = 'block';
      });
    });
    
    closeBtn.addEventListener('click', function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    });
    
    overlay.addEventListener('click', function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    });
  }

  // Populate service dropdown from the data
  function populateServiceDropdown() {
    const serviceFilter = document.getElementById("serviceFilter");
    // Keep the first option "All Services"
    serviceFilter.innerHTML = '<option value="">All Services</option>';
    
    // Get unique services
    const uniqueServices = [...new Set(allUserData.map(item => item.service))];
    
    // Add each unique service to the dropdown
    uniqueServices.forEach(service => {
      if (service) { // Only add non-empty services
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        serviceFilter.appendChild(option);
      }
    });
  }
  
  // Function to update charts based on data
  function updateCharts(data) {
    // Implementation of chart updates will go here
    // This is a placeholder for now
    console.log("Chart data updated with", data.length, "records");
  }

  // Apply filters
  document.getElementById("applyFilters").addEventListener("click", function() {
    applyFilters();
  });
  
  // Reset filters
  document.getElementById("resetFilters").addEventListener("click", function() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("serviceFilter").value = "";
    document.getElementById("searchInput").value = "";
    
    // Reset to original data
    if (document.getElementById("tableContainer").style.display === "block") {
      loadUserData();
    } else if (document.getElementById("combinedContainer").style.display === "block") {
      updateCombinedTable(combinedData);
    }
  });
  

  
  // Search button
  document.getElementById("searchBtn").addEventListener("click", function() {
    applyFilters();
  });
  
  // Clear search
  document.getElementById("clearSearch").addEventListener("click", function() {
    document.getElementById("searchInput").value = "";
    applyFilters();
  });


// Function to load and combine data from both collections
async function loadCombinedData() {
  try {
    document.getElementById("combinedLoader").style.display = "block";
    combinedData = [];
    
    // Make sure we have both data sets
    if (allUserData.length === 0) {
      const userSnapshot = await db.collection("testAlloy_UserDetails").get();
      userSnapshot.forEach(doc => {
        allUserData.push(doc.data());
      });
    }
    
    // Load query data with the actual field structure
    const querySnapshot = await db.collection("testalloy_queries").get();
    allQueryData = [];
    querySnapshot.forEach(doc => {
      allQueryData.push(doc.data());
    });
    
    // Create a map to store queries by session_id
    const queryMap = {};
    
    allQueryData.forEach(query => {
      const sessionId = query.sessionId || "";
      if (!sessionId) return;
      
      // Store the query by session ID
      queryMap[sessionId] = {
        query_by_bot1: query.query_by_bot1 || "",
        response_by_bot1: query.response_by_bot1 || "",
        query_by_bot2: query.query_by_bot2 || "",
        response_by_bot2: query.response_by_bot2 || "",
        timestamp: query.timestamp || query.time
      };
    });
    
    // Combine user data with query data
    allUserData.forEach(userData => {
      const sessionId = userData.session_id || userData.sessionid || "";
      if (!sessionId) return;
      
      // Create a combined record
      const combined = {
        username: userData.username || "",
        email: userData.email || "",
        service: userData.service || "",
        sessionid_details: sessionId,
        date: "",
        time: "",
        query_by_bot1: "",
        response_by_bot1: "",
        query_by_bot2: "",
        response_by_bot2: "",
        sessionid_queries: ""
      };
      
      // Format the date and time
      if (userData.time && userData.time.includes(" ")) {
        const parts = userData.time.split(" ");
        combined.date = parts[0];
        combined.time = parts[1];
      } else {
        combined.date = userData.date || "";
        combined.time = userData.time || "";
      }
      
      // Parse user timestamp
      let userTime = parseTimestamp(userData.time);
      
      // If we have corresponding query data by session ID, add it
      if (queryMap[sessionId]) {
        combined.query_by_bot1 = queryMap[sessionId].query_by_bot1 || "";
        combined.response_by_bot1 = queryMap[sessionId].response_by_bot1 || "";
        combined.query_by_bot2 = queryMap[sessionId].query_by_bot2 || "";
        combined.response_by_bot2 = queryMap[sessionId].response_by_bot2 || "";
        combined.sessionid_queries = sessionId;
      } else {
        // Try to find query data based on timestamp matching
        // within a 3-minute window (180 seconds)
        allQueryData.forEach(query => {
          if (!query.timestamp && !query.time) return;
          
          let queryTime;
          if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
            queryTime = query.timestamp.toDate();
          } else {
            queryTime = parseTimestamp(query.timestamp || query.time);
          }
          
          if (!queryTime || !userTime) return;
          
          // Compare timestamps with 180-second window
          const timeDiff = Math.abs(userTime - queryTime) / 1000; // difference in seconds
          if (timeDiff <= 180) { // 3 minutes
            combined.query_by_bot1 = query.query_by_bot1 || "";
            combined.response_by_bot1 = query.response_by_bot1 || "";
            combined.query_by_bot2 = query.query_by_bot2 || "";
            combined.response_by_bot2 = query.response_by_bot2 || "";
            combined.sessionid_queries = query.sessionId || "";
          }
        });
      }
      
      combinedData.push(combined);
    });
    
    // Update the combined table
    updateCombinedTable(combinedData);
    
    document.getElementById("combinedLoader").style.display = "none";
  } catch (error) {
    console.error("Error loading combined data: ", error);
    document.getElementById("combined-body").innerHTML = 
      "<tr><td colspan='12'>Error loading combined data. Please try again.</td></tr>";
    document.getElementById("combinedLoader").style.display = "none";
  }
}

// Update the combined data table with the new structure
function updateCombinedTable(data) {
  const tableBody = document.getElementById("combined-body");
  tableBody.innerHTML = "";
  
  if (data.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='12'>No combined data available</td></tr>";
    return;
  }
  
  // Update table headers to match the new structure
  const tableHeaders = document.querySelector("#combined-table thead tr");
  tableHeaders.innerHTML = `
    <th>Username</th>
    <th>Email</th>
    <th>Service</th>
    <th>SessionID Details</th>
    <th>SessionID Queries</th>
    <th>Date</th>
    <th>Time</th>
    <th>Query Bot 1</th>
    <th>Response Bot 1</th>
    <th>Query Bot 2</th>
    <th>Response Bot 2</th>
  `;
  
  data.forEach(item => {
    const row = `
      <tr>
        <td>${item.username}</td>
        <td>${item.email}</td>
        <td>${item.service}</td>
        <td>${item.sessionid_details}</td>
        <td>${item.sessionid_queries}</td>
        <td>${item.date}</td>
        <td>${item.time}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">
          <span class="truncate">${item.query_by_bot1}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">
          <span class="truncate">${item.response_by_bot1}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">
          <span class="truncate">${item.query_by_bot2}</span>
        </td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">
          <span class="truncate">${item.response_by_bot2}</span>
        </td>
      </tr>
    `;
    tableBody.innerHTML += row;
  });
  
  // Setup expandable cells
  setupExpandableCells();
}

// Improved timestamp parsing function to handle different formats
function parseTimestamp(timeStr) {
  if (!timeStr) return null;
  
  // Handle format "2025-04-17 10:36:57"
  if (typeof timeStr === 'string' && timeStr.includes(' ')) {
    const dateParts = timeStr.split(' ');
    if (dateParts.length === 2) {
      const [dateStr, timeStr] = dateParts;
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes, seconds);
    }
  }
  
  // Handle ISO format "2025-04-15T12:46:23.657471"
  if (typeof timeStr === 'string' && timeStr.includes('T')) {
    return new Date(timeStr);
  }
  
  // Handle Firebase timestamp objects
  if (typeof timeStr === 'object' && timeStr.toDate) {
    return timeStr.toDate();
  }
  
  // Handle string like "15 April 2025 at 18:16:23.6"
  if (typeof timeStr === 'string' && timeStr.includes('at')) {
    const dateRegex = /(\d+)\s+(\w+)\s+(\d+)\s+at\s+(\d+):(\d+):(\d+)/;
    const match = timeStr.match(dateRegex);
    if (match) {
      const [_, day, month, year, hours, minutes, seconds] = match;
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const monthIndex = monthNames.findIndex(m => m === month);
      if (monthIndex !== -1) {
        return new Date(parseInt(year), monthIndex, parseInt(day), parseInt(hours), parseInt(minutes), parseInt(seconds));
      }
    }
  }
  
  // Try to parse as generic date string
  try {
    return new Date(timeStr);
  } catch (e) {
    console.error("Error parsing timestamp:", e);
    return null;
  }
}

function addDashboardSummary() {
  // Create a summary section above the charts
  const rightPanel = document.querySelector('.right-panel');
  const chartsContainer = document.querySelector('.charts');
  
  // Create summary section element
  const summarySection = document.createElement('div');
  summarySection.className = 'dashboard-summary';
  summarySection.innerHTML = `
    <div class="dashboard-header">
    </div>
    <div class="summary-cards">
    <div class="summary-card" id="total-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Total Users</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="users-today">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Users Today</h3>
        <p class="card-value">-</p>
        </div>    
    </div>
    <div class="summary-card" id="returning-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Returning Users</h3>
        <p class="card-value">-</p>
        </div>

    </div>
    <div class="summary-card" id="online-users">
        <div class="card-icon">üë§</div>
        <div class="card-content">
        <h3>Online Users</h3>
        <p class="card-value">-</p>
        </div>
    </div>
    <div class="summary-card" id="total-sessions">
        <div class="card-icon">üîÑ</div>
        <div class="card-content">
        <h3>Total Sessions</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="active-services">
        <div class="card-icon">üß©</div>
        <div class="card-content">
        <h3>Number of Services</h3>
        <p class="card-value">0</p>
        </div>
    </div>
    <div class="summary-card" id="top-service">
        <div class="card-icon">üî•</div>
        <div class="card-content">
        <h3>Top Service</h3>
        <p class="card-value">-</p>
        </div>
    </div>
    <div class="summary-card" id="avg-sessions">
        <div class="card-icon">üìä</div>
        <div class="card-content">
        <h3>Avg Sessions per User</h3>
        <p class="card-value">0</p>
        </div>
    </div>
  `;
  
  // Insert the summary section before the charts
  rightPanel.insertBefore(summarySection, chartsContainer);
  
  // Add CSS for the summary section
  const style = document.createElement('style');
  style.textContent = `
    .dashboard-summary {
      margin-bottom: 30px;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .card-icon {
      font-size: 24px;
      margin-right: 15px;
    }
    
    .card-content h3 {
      margin: 0 0 5px 0;
      font-size: 14px;
      color: #666;
    }
    
    .card-value {
      margin: 0;
      
      font-weight: bold;
      color: #333;
    }

    /* Unified style for all view icons */
    .view-online-users,
    .view-users-today,
    .view-returning-users {
      cursor: pointer;
      margin-left: 5px;
      color: #088F8F;
      transition: color 0.2s;
    }
    
    .view-online-users:hover {
      // color: #2a6fc6;
       color: #4a90e2;
    }

    .view-users-today:hover {color: #4a90e2;}
    .view-returning-users:hover {color:#4a90e2;}

    .online-users-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    
    .online-users-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .online-users-list li:last-child {
      border-bottom: none;
    }
    
    @media (max-width: 1024px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Modal styles */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    #expanded-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      min-width: 300px;
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    }
  
    
    @media (max-width: 576px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }
  `;
  document.head.appendChild(style);

  // Add Font Awesome for the eye icon
  const fontAwesome = document.createElement('link');
  fontAwesome.rel = 'stylesheet';
  fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
  document.head.appendChild(fontAwesome);

  // Create modal structure
  ensureModalStructureExists();
  
  // Update the summary cards with data
  updateDashboardSummary(allUserData);
}

function parseTimestamping(timestamp) {
  if (!timestamp) return null;
  const dateObj = new Date(timestamp);
  return isNaN(dateObj) ? null : dateObj;
}

function formatDateToISOString(dateObj) {
  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const dd = String(dateObj.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}






// ==================
function updateDashboardSummary(data) {
  const uniqueEmails = new Set();
  const emailCount = {};
  const serviceCount = {};

  // Get today's date in Indian Standard Time (IST)
  const now = new Date();
  const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
  // Format today's date as YYYY-MM-DD for comparison with database dates
  const todayFormatted = todayIST.getFullYear() + '-' + 
                         String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(todayIST.getDate()).padStart(2, '0');

  let usersToday = 0;
  let onlineUsers = 0;
  
  // Set to track unique users today (to avoid counting the same user multiple times)
  const uniqueUsersToday = new Set();

  // Online users tracking - store emails of users active in last 30 minutes
  const onlineUserEmails = new Set();
  const thirtyMinutesInMs = 30 * 60 * 1000; // 30 minutes in milliseconds

  // Track returning users' emails
  const returningUsersEmails = new Set();

  data.forEach(item => {
    // Unique emails
    if (item.email) {
      uniqueEmails.add(item.email);
      emailCount[item.email] = (emailCount[item.email] || 0) + 1;
    }

    // Count services
    if (item.service) {
      serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
    }

    if (item.time) {
      const itemDate = item.time.split(" ")[0]; // Extract '2025-04-22' from '2025-04-22 11:16:18'
      if (itemDate === todayFormatted && item.email) {
        uniqueUsersToday.add(item.email);
      }
    }


    // Online users: unique email IDs within last 30 minutes
    if (item.email && item.time) {
      let sessionTime;
      if (item.time.includes(" ")) {
        // Format: "2025-04-17 10:36:57"
        sessionTime = parseTimestamping(item.time);
      } else if (item.date && item.time) {
        // Separate date and time fields
        sessionTime = parseTimestamping(`${item.date} ${item.time}`);
      }
      
      if (sessionTime && (now - sessionTime) <= thirtyMinutesInMs) {
        onlineUserEmails.add(item.email);
      }
    }
  });

  // Set usersToday to the count of unique users who interacted today
  usersToday = uniqueUsersToday.size;

  // Total sessions
  const totalSessions = data.length;

  // Active unique services
  const uniqueServices = new Set(Object.keys(serviceCount));

  // Returning users: email seen more than once
  // const returningUsers = Object.values(emailCount).filter(count => count > 1).length;

  // Convert Set to Array for the online users list
  const onlineUsersList = Array.from(onlineUserEmails);
  const todayUsersList = Array.from(uniqueUsersToday);

  // Avg sessions per user
  const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;

  // Top engaged service
  let topService = "-";
  let maxServiceCount = 0;
  for (const [service, count] of Object.entries(serviceCount)) {
    if (count > maxServiceCount) {
      topService = service;
      maxServiceCount = count;
    }
  }

  // Returning users: email seen more than once
  const returningUsers = Object.entries(emailCount).filter(([email, count]) => count > 1);
  const returningUsersCount = returningUsers.length;
  const returningUsersList = returningUsers.map(item => item[0]); // Extract just the emails

  // Returning users: email seen more than once
  // const returningUsers = Object.values(emailCount).filter(count => count > 1).length;

  document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
  document.querySelector('#total-users .card-value').setAttribute('title', `Unique users: ${uniqueEmails.size}`);

  document.querySelector('#total-sessions .card-value').textContent = totalSessions;
  document.querySelector('#total-sessions .card-value').setAttribute('title', `Total sessions: ${totalSessions}`);

  document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
  document.querySelector('#active-services .card-value').setAttribute('title', `Unique services used: ${uniqueServices.size}`);

  document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
  document.querySelector('#avg-sessions .card-value').setAttribute('title', `Avg sessions per user: ${avgSessions}`);

  // document.querySelector('#top-service .card-value').innerHTML = `<h6>${topService}</small>`;
  // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  // document.querySelector('#top-service .card-value').textContent = topService;
  // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);

  document.querySelector('#users-today .card-value').textContent = usersToday;
  document.querySelector('#users-today .card-value').setAttribute('title', `Users Today: ${usersToday}`);
  
  document.querySelector('#online-users .card-value').textContent = onlineUsers;
  document.querySelector('#online-users .card-value').setAttribute('title', `Active within 5 mins: ${onlineUsers}`);

  document.querySelector('#returning-users .card-value').textContent = returningUsers;
  document.querySelector('#returning-users .card-value').setAttribute('title', `Users with multiple visits: ${returningUsers}`);
  
  const topServiceElem = document.querySelector('#top-service .card-value');
  topServiceElem.textContent = topService;
  topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  topServiceElem.classList.add('h6-style'); 

   // Update online users count with view icon
  const onlineUsersElement = document.querySelector('#online-users .card-value');
  onlineUsersElement.innerHTML = `${onlineUserEmails.size} <i class="view-online-users fas fa-eye" title="View online users"></i>`;
  onlineUsersElement.setAttribute('title', `Active within 30 mins: ${onlineUserEmails.size}`);
  onlineUsersElement.setAttribute('data-emails', JSON.stringify(onlineUsersList));

  
  // Update users today count with view icon
  const usersTodayElement = document.querySelector('#users-today .card-value');
  usersTodayElement.innerHTML = `${usersToday} <i class="view-users-today fas fa-eye" title="View users active today"></i>`;
  usersTodayElement.setAttribute('title', `Users active today: ${usersToday}`);
  usersTodayElement.setAttribute('data-emails', JSON.stringify(todayUsersList));
  
  // Add click handler for the view icon
  // const viewIcon = document.querySelector('.view-online-users');
  // if (viewIcon) {
  //   viewIcon.addEventListener('click', function(e) {
  //     e.stopPropagation(); // Prevent triggering parent element click events
  //     showOnlineUsersList(onlineUsersList);
  //   });
  // }

  // Update returning users count with view icon
  const returningUsersElement = document.querySelector('#returning-users .card-value');
  returningUsersElement.innerHTML = `${returningUsersCount} <i class="view-returning-users fas fa-eye" title="View returning users"></i>`;
  returningUsersElement.setAttribute('title', `Users with multiple visits: ${returningUsersCount}`);
  returningUsersElement.setAttribute('data-emails', JSON.stringify(returningUsersList));
  
  // Add click handlers for each view icon
  setupViewIconHandlers();
  
  // Ensure the close handlers are properly set up
  setupModalCloseHandlers();
  
  
  console.log({ todayFormatted, usersToday, topService });
}


// Setup modal close handlers
function setupModalCloseHandlers() {
  ensureModalStructureExists();
  
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const closeBtn = document.getElementById('close-expanded');
  
  if (closeBtn) {
    closeBtn.onclick = function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    };
  }
  
  if (overlay) {
    overlay.onclick = function() {
      overlay.style.display = 'none';
      expandedContent.style.display = 'none';
    };
  }
}


function setupViewIconHandlers() {
  // Online users view icon
  const onlineViewIcon = document.querySelector('.view-online-users');
  if (onlineViewIcon) {
    onlineViewIcon.addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent triggering parent element click events
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Online Users');
      }
    });
  }
  
  // Users today view icon
  const todayViewIcon = document.querySelector('.view-users-today');
  if (todayViewIcon) {
    todayViewIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Users Active Today');
      }
    });
  }
  
  // Returning users view icon
  const returningViewIcon = document.querySelector('.view-returning-users');
  if (returningViewIcon) {
    returningViewIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      const emailsData = this.parentNode.getAttribute('data-emails');
      if (emailsData) {
        showUsersList(JSON.parse(emailsData), 'Returning Users');
      }
    });
  }
}

// Unified function to show user lists (replaces showOnlineUsersList)
function showUsersList(emails, title) {
  ensureModalStructureExists();
  
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const expandedText = document.getElementById('expanded-text');
  const modalTitle = document.getElementById('modal-title');
  
  // Set the modal title
  //modalTitle.textContent = title;

  
  // Clear previous content
  expandedText.innerHTML = '';
  
  if (emails.length === 0) {
    const noUsers = document.createElement('p');
    noUsers.textContent = 'No Users Today';
    expandedText.appendChild(noUsers);
  } else {
    // Create list of emails
    const list = document.createElement('ul');
    list.className = 'online-users-list';
    
    emails.forEach(email => {
      const item = document.createElement('li');
      item.textContent = email;
      list.appendChild(item);
    });
    
    expandedText.appendChild(list);
  }
  
  // Show the overlay and expanded content
  overlay.style.display = 'block';
  expandedContent.style.display = 'block';
}


function ensureModalStructureExists() {
  // Check if the overlay and expanded content elements already exist
  if (!document.getElementById('overlay')) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    `;
    document.body.appendChild(overlay);
    
    // Create expanded content
    const expandedContent = document.createElement('div');
    expandedContent.id = 'expanded-content';
    expandedContent.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      min-width: 300px;
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    `;
    
    // Add content and close button to expanded content
    expandedContent.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 id="modal-title" style="margin: 0;">User List</h3>
        <button id="close-expanded" style="background: none; border: none; cursor: pointer; font-size: 18px;">√ó</button>
      </div>
      <div id="expanded-text"></div>
    `;
    
    document.body.appendChild(expandedContent);
  }
}


// Function to display the list of online users
function showOnlineUsersList(emails) {
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const expandedText = document.getElementById('expanded-text');
  const closeBtn = document.getElementById('close-expanded');
  
  // Clear previous content
  expandedText.innerHTML = '';
  
  // Create title
  const title = document.createElement('h3');
  title.textContent = 'Online Users';
  expandedText.appendChild(title);
  
  if (emails.length === 0) {
    const noUsers = document.createElement('p');
    noUsers.textContent = 'No users currently online';
    expandedText.appendChild(noUsers);
  } else {
    // Create list of emails
    const list = document.createElement('ul');
    list.className = 'online-users-list';
    
    emails.forEach(email => {
      const item = document.createElement('li');
      item.textContent = email;
      list.appendChild(item);
    });
    
    expandedText.appendChild(list);
  }
  
  // Show the overlay and expanded content
  overlay.style.display = 'block';
  expandedContent.style.display = 'block';
  
  // Ensure close button works
  closeBtn.onclick = function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  };
  
  // Ensure clicking on overlay also closes the modal
  overlay.onclick = function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  };
}


// Update the updateCharts function to include the summary
const originalUpdateCharts = updateCharts;
updateCharts = function(data) {
  originalUpdateCharts(data);
  updateDashboardSummary(data);
};

// Call this function when the page loads
window.addEventListener('load', function() {
  // Add the dashboard summary section
  addDashboardSummary();
});


// Function to create chart containers if they don't exist
function createChartContainers() {
  console.log("Setting up chart containers...");
  
  // Check if the charts container exists
  let chartsContainer = document.querySelector('.charts');
  
  // If it doesn't exist, create it
  if (!chartsContainer) {
    console.log("Creating charts container...");
    const rightPanel = document.querySelector('.right-panel');
    
    if (!rightPanel) {
      console.error("Right panel not found! Creating one...");
      const mainContainer = document.querySelector('.main-container');
      if (!mainContainer) {
        console.error("Main container not found! Creating the entire structure...");
        const body = document.body;
        
        // Create main container
        const newMainContainer = document.createElement('div');
        newMainContainer.className = 'main-container';
        
        // Create left panel
        const leftPanel = document.createElement('div');
        leftPanel.className = 'left-panel';
        
        // Create right panel
        const newRightPanel = document.createElement('div');
        newRightPanel.className = 'right-panel';
        
        // Create charts container
        chartsContainer = document.createElement('div');
        chartsContainer.className = 'charts';
        
        // Assemble structure
        newRightPanel.appendChild(chartsContainer);
        newMainContainer.appendChild(leftPanel);
        newMainContainer.appendChild(newRightPanel);
        
        // Add to body before any other content
        body.insertBefore(newMainContainer, body.firstChild);
      } else {
        const newRightPanel = document.createElement('div');
        newRightPanel.className = 'right-panel';
        chartsContainer = document.createElement('div');
        chartsContainer.className = 'charts';
        newRightPanel.appendChild(chartsContainer);
        mainContainer.appendChild(newRightPanel);
      }
    } else {
      chartsContainer = document.createElement('div');
      chartsContainer.className = 'charts';
      rightPanel.appendChild(chartsContainer);
    }
  }
  
  // Create/check individual chart containers
  const chartIds = ['barChart', 'lineChart', 'emailChart', 'pieChart'];
  const chartTitles = ['Sessions per Service', 'Sessions per Day', 'Unique Emails per Day', 'Service Distribution'];
  
  chartIds.forEach((id, index) => {
    if (!document.getElementById(id)) {
      console.log(`Creating chart container for ${id}...`);
      const chartBox = document.createElement('div');
      chartBox.className = 'chart-box';
      chartBox.innerHTML = `
        <h3>${chartTitles[index]}</h3>
        <canvas id="${id}"></canvas>
      `;
      chartsContainer.appendChild(chartBox);
    }
  });
  
 
  
  // Apply basic styling if needed
  if (!document.querySelector('style#chart-styles')) {
    const style = document.createElement('style');
    style.id = 'chart-styles';
    style.textContent = `
      .charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 30px;
        margin-bottom: 30px;
      }
      
      .chart-box {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      .chart-box h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
        text-align: center;
      }
      
      canvas {
        width: 100% !important;
        height: 300px !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  console.log("Chart containers setup complete!");
}



// Function to update charts based on data with detailed logging
function updateCharts(data) {
  console.log(`Updating charts with ${data.length} records...`);
  
  try {
    // Ensure Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error("Chart.js is not loaded! Charts cannot be rendered.");
      return;
    }
    
    // Clean up any existing charts to prevent memory leaks
    try {
      Chart.helpers.each(Chart.instances, function(instance) {
        instance.destroy();
      });
    } catch (e) {
      console.warn("Could not clean up existing charts", e);
    }
    
    // Update the individual charts
    try {
      updateSessionsPerServiceChart(data);
      console.log("Sessions per Service chart updated");
    } catch (e) {
      console.error("Error updating Sessions per Service chart:", e);
    }
    
    try {
      updateSessionsPerDayChart(data);
      console.log("Sessions per Day chart updated");
    } catch (e) {
      console.error("Error updating Sessions per Day chart:", e);
    }
    
    try {
      updateUniqueEmailsPerDayChart(data);
      console.log("Unique Emails per Day chart updated");
    } catch (e) {
      console.error("Error updating Unique Emails per Day chart:", e);
    }
    
    try {
      updateServiceDistributionChart(data);
      console.log("Service Distribution chart updated");
    } catch (e) {
      console.error("Error updating Service Distribution chart:", e);
    }
    
    try {
    //   updateUserActivityChart(data);
      console.log("User Activity chart updated");
    } catch (e) {
      console.error("Error updating User Activity chart:", e);
    }
    
    console.log("All charts updated successfully!");
  } catch (error) {
    console.error("Error in updateCharts function:", error);
  }
}

// 1. Bar Chart - Sessions per Service
function updateSessionsPerServiceChart(data) {
  const canvas = document.getElementById('barChart');
  if (!canvas) {
    console.error("Bar chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Count sessions per service
  const serviceCounts = {};
  data.forEach(item => {
    const service = item.service || 'Unknown';
    if (!serviceCounts[service]) {
      serviceCounts[service] = 0;
    }
    serviceCounts[service]++;
  });
  
  // Prepare chart data
  const labels = Object.keys(serviceCounts);
  const values = Object.values(serviceCounts);
  
  // Create color array
  const backgroundColors = labels.map((_, index) => {
    return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
  });
  
  // Create the chart
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Number of Sessions',
        data: values,
        backgroundColor: backgroundColors,
        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Sessions: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 2. Line Chart - Sessions per Day
function updateSessionsPerDayChart(data) {
  const canvas = document.getElementById('lineChart');
  if (!canvas) {
    console.error("Line chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Group sessions by day
  const sessionsPerDay = {};
  
  // Group sessions by day
  data.forEach(item => {
    // Extract date from the time field
    let dateStr = "";
    
    if (item.time && item.time.includes(" ")) {
      dateStr = item.time.split(" ")[0]; 
    } else if (item.date) {
      dateStr = item.date;
    }
    
    if (!dateStr) return;
    
    // Initialize counter for this date if not exists
    if (!sessionsPerDay[dateStr]) {
      sessionsPerDay[dateStr] = 0;
    }
    
    sessionsPerDay[dateStr]++;
  });
  
  // Sort dates chronologically
  const sortedDates = Object.keys(sessionsPerDay).sort((a, b) => new Date(a) - new Date(b));
  
  // Prepare chart data
  const chartData = {
    labels: sortedDates,
    datasets: [{
      label: 'Number of Sessions',
      data: sortedDates.map(date => sessionsPerDay[date]),
      fill: false,
      borderColor: 'rgba(75, 192, 192, 1)',
      tension: 0.1,
      pointBackgroundColor: 'rgba(75, 192, 192, 1)',
      pointRadius: 4
    }]
  };
  
  // Create the chart
  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Sessions: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 3. Line Chart - Unique Emails per Day
function updateUniqueEmailsPerDayChart(data) {
  const canvas = document.getElementById('emailChart');
  if (!canvas) {
    console.error("Email chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Group emails by day
  const emailsByDay = {};
  
  // Group emails by day
  data.forEach(item => {
    // Extract date from the time field
    let dateStr = "";
    
    if (item.time && item.time.includes(" ")) {
      dateStr = item.time.split(" ")[0]; 
    } else if (item.date) {
      dateStr = item.date;
    }
    
    if (!dateStr || !item.email) return;
    
    // Initialize set for this date if not exists
    if (!emailsByDay[dateStr]) {
      emailsByDay[dateStr] = new Set();
    }
    
    // Add email to the set (sets only keep unique values)
    emailsByDay[dateStr].add(item.email);
  });
  
  // Sort dates chronologically
  const sortedDates = Object.keys(emailsByDay).sort((a, b) => new Date(a) - new Date(b));
  
  // Prepare chart data
  const chartData = {
    labels: sortedDates,
    datasets: [{
      label: 'Unique Emails',
      data: sortedDates.map(date => emailsByDay[date].size),
      fill: false,
      borderColor: '#87CEEB',
      tension: 0.1,
      pointBackgroundColor: '#87CEEB',
      pointRadius: 4
    }]
  };
  
  // Create the chart
  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Unique Emails: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// 4. Pie Chart - Service Distribution
function updateServiceDistributionChart(data) {
  const canvas = document.getElementById('pieChart');
  if (!canvas) {
    console.error("Pie chart canvas not found!");
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Count users per service
  const serviceCounts = {};
  
  // Count users per service
  data.forEach(item => {
    const service = item.service || 'Unknown';
    if (!serviceCounts[service]) {
      serviceCounts[service] = 0;
    }
    serviceCounts[service]++;
  });
  
  // Prepare chart data
  const labels = Object.keys(serviceCounts);
  const values = Object.values(serviceCounts);
  
  // Create color array
  const backgroundColors = labels.map((_, index) => {
    return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
  });
  
  // Create the chart
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: backgroundColors,
        borderColor: '#ffffff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            boxWidth: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}



// // 5. User Activity Chart - User Activity Timeline
// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }
  
//   const ctx = canvas.getContext('2d');
  
//   // Process the data to create a timeline of activity
//   const activityByHour = {};
  
//   // Initialize hours (0-23) with zero count
//   for (let i = 0; i < 24; i++) {
//     activityByHour[i] = 0;
//   }
  
//   // Count activities by hour
//   data.forEach(item => {
//     let hourOfDay = 0;
    
//     if (item.time) {
//       let timeStr = item.time;
//       if (item.time.includes(" ")) {
//         timeStr = item.time.split(" ")[1]; // Get the time part
//       }
      
//       // Extract hour from the time string (assuming format HH:MM:SS)
//       const hourMatch = timeStr.match(/^(\d{1,2}):/);
//       if (hourMatch) {
//         hourOfDay = parseInt(hourMatch[1]);
//       }
//     }
    
//     // Increment counter for this hour
//     activityByHour[hourOfDay]++;
//   });
  
//   // Prepare chart data
//   const hours = Object.keys(activityByHour).map(Number).sort((a, b) => a - b);
//   const activityCounts = hours.map(hour => activityByHour[hour]);
  
//   // Format hour labels (00:00, 01:00, etc.)
//   const hourLabels = hours.map(hour => {
//     const formattedHour = hour.toString().padStart(2, '0');
//     return `${formattedHour}:00`;
//   });
  
//   // Create the chart
//   new Chart(ctx, {
//     type: 'bar',
//     data: {
//       labels: hourLabels,
//       datasets: [{
//         label: 'User Activity',
//         data: activityCounts,
//         backgroundColor: 'rgba(153, 102, 255, 0.6)',
//         borderColor: 'rgba(153, 102, 255, 1)',
//         borderWidth: 1
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       scales: {
//         y: {
//           beginAtZero: true,
//           ticks: {
//             precision: 0
//           },
//           title: {
//             display: true,
//             text: 'Number of Sessions'
//           }
//         },
//         x: {
//           title: {
//             display: true,
//             text: 'Hour of Day'
//           }
//         }
//       },
//       plugins: {
//         title: {
//           display: true,
//           text: 'User Activity Distribution by Hour'
//         },
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               return `Sessions: ${context.raw}`;
//             }
//           }
//         }
//       }
//     }
//   });
// }

// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }

//   const ctx = canvas.getContext('2d');

//   const serviceStats = {};

//   data.forEach(item => {
//     const service = item.service || "Unknown";
//     if (!serviceStats[service]) {
//       serviceStats[service] = { sessions: 0, users: new Set() };
//     }
//     serviceStats[service].sessions += 1;
//     if (item.email) {
//       serviceStats[service].users.add(item.email);
//     }
//   });

//   const bubbleData = Object.entries(serviceStats).map(([service, stats]) => ({
//     x: stats.sessions,
//     y: stats.users.size,
//     r: Math.sqrt(stats.sessions) + 5, // Bubble radius (scaled)
//     serviceName: service
//   }));

//   new Chart(ctx, {
//     type: 'bubble',
//     data: {
//       datasets: [{
//         label: 'Service Engagement',
//         data: bubbleData,
//         backgroundColor: 'rgba(54, 162, 235, 0.5)',
//         borderColor: 'rgba(54, 162, 235, 1)',
//         borderWidth: 1,
//         parsing: false
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       plugins: {
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               const { x, y, r, serviceName } = context.raw;
//               return [
//                 `Service: ${serviceName}`,
//                 `Sessions: ${x}`,
//                 `Users: ${y}`,
//                 `Bubble Size: ${r.toFixed(1)}`
//               ];
//             }
//           }
//         },
//         title: {
//           display: true,
//           text: 'Service vs Sessions vs Users (Bubble Chart)'
//         }
//       },
//       scales: {
//         x: {
//           title: {
//             display: true,
//             text: 'Sessions'
//           },
//           beginAtZero: true
//         },
//         y: {
//           title: {
//             display: true,
//             text: 'Unique Users'
//           },
//           beginAtZero: true
//         }
//       }
//     }
//   });
// }


// Call initialization
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeCharts);
} else {
  initializeCharts();
}


// Call loadUserData when the page loads
window.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, initializing dashboard...");
  loadUserData();
//   addDashboardSummary();
});


    // Add these event listeners after existing event listeners in your JS code
    document.getElementById("downloadUserInfo").addEventListener("click", function() {
    openUserInfoPage();
    });

    document.getElementById("downloadUserDetails").addEventListener("click", function() {
    openUserDetailsPages();
    });

    // Function to open a new page with user information
    async function openUserInfoPage() {
    try {
        // Load data from Firestore
        const snapshot = await db.collection("testAlloy_UserDetails").get();
        let userData = [];
        
        snapshot.forEach(doc => {
        userData.push(doc.data());
        });
        
        // Generate HTML content
        const htmlContent = generateUserInfoHTML(userData);
        
        // Open new window with the content
        const newWindow = window.open('', '_blank');
        newWindow.document.write(htmlContent);
        newWindow.document.close();
    } catch (error) {
        console.error("Error opening user info page:", error);
        alert("Error loading user information. Please try again.");
    }
    }

    // Function to open a new page with user details (queries)
    async function openUserDetailsPage() {
    try {
        // Load data from Firestore
        const snapshot = await db.collection("testalloy_queries").get();
        let queryData = [];
        
        snapshot.forEach(doc => {
        queryData.push(doc.data());
        });
        
        // Generate HTML content
        const htmlContent = generateUserDetailsHTML(queryData);
        
        // Open new window with the content
        const newWindow = window.open('', '_blank');
        newWindow.document.write(htmlContent);
        newWindow.document.close();
    } catch (error) {
        console.error("Error opening user details page:", error);
        alert("Error loading user details. Please try again.");
    }
    }



function generateUserInfoHTML(userData) {
    // Normalize and sort data by datetime (descending)
    const sortedData = userData.map(user => {
        let rawTime = user.time || user.date || "";
        let date = "";
        let time = "";
        let dateObj = null;

        if (rawTime.includes("T")) {
            // Format: 2025-04-14T18:54:10
            [date, time] = rawTime.split("T");
            dateObj = new Date(`${date}T${time}`);
        } else if (rawTime.includes(" ")) {
            // Format: 2025-04-22 11:16:18
            [date, time] = rawTime.split(" ");
            dateObj = new Date(`${date}T${time}`);
        } else {
            // Fallback (if no recognizable format)
            date = rawTime;
            time = "";
            dateObj = new Date(date);
        }

        return {
            ...user,
            formattedDate: date,
            formattedTime: time,
            dateObj: dateObj
        };
    }).sort((a, b) => b.dateObj - a.dateObj); // Descending sort

    // Generate table rows
    const tableRows = sortedData.map(user => `
        <tr>
            <td>${user.username || ""}</td>
            <td>${user.email || ""}</td>
            <td>${user.service || ""}</td>
            <td>${user.session_id || user.sessionid || ""}</td>
            <td>${user.formattedDate}</td>
            <td>${user.formattedTime}</td>
        </tr>
    `).join('');

    // Return full HTML with logo instead of title text and smaller font for table
    return `
        <html>
        <head>
            <title>User Info</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                .header {
                    display: flex;
                    align-items: center;
                    margin-bottom: 20px;
                }
                .logo-img {
                    height: 40px;
                    margin-right: 15px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.85em; /* Smaller font size for table */
                }
                th, td {
                    border: 1px solid #ccc;
                    padding: 6px; /* Reduced padding */
                    text-align: left;
                }
                th {
                    background-color: #f2f2f2;
                    font-weight: bold;
                }
                h2 {
                    margin: 0;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
                <h2>User Information</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Service</th>
                        <th>Session ID</th>
                        <th>Date</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </body>
        </html>
    `;
}
// Helper function to parse timestamp for comparison (ignoring seconds)
function parseTimestampForComparison(timeStr) {
  if (!timeStr) return null;
  
  let date;
  
  // Handle format "2025-04-17 10:36:57"
  if (typeof timeStr === 'string' && timeStr.includes(' ')) {
    const [dateStr, timeStrPart] = timeStr.split(' ');
    const [year, month, day] = dateStr.split('-').map(Number);
    const [hours, minutes] = timeStrPart.split(':').map(Number);
    date = new Date(year, month - 1, day, hours, minutes, 0);
    return date;
  }
  
  // Handle ISO format "2025-04-15T12:46:23.657471"
  if (typeof timeStr === 'string' && timeStr.includes('T')) {
    date = new Date(timeStr);
    // Zero out the seconds for comparison
    date.setSeconds(0, 0);
    return date;
  }
  
  // Try to parse as generic date string
  try {
    date = new Date(timeStr);
    date.setSeconds(0, 0);
    return date;
  } catch (e) {
    console.error("Error parsing timestamp:", e);
    return null;
  }
}

// Helper function to format timestamp for display
function formatTimestamp(date) {
  if (!date) return "";
  return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
}

// Helper to pad numbers with leading zero
function padZero(num) {
  return num.toString().padStart(2, '0');
}

// Helper to truncate text for display
function truncateText(text, maxLength) {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + "...";
}

// working
// function generateCombinedDetailsHTML(userData, queryData) {
//   // Normalize timestamp formats for both datasets
//   const normalizedUserData = userData.map(user => {
//     let timestamp = parseTimestampForComparison(user.time || user.date || "");
//     return {
//       ...user,
//       sessionId: user.session_id || user.sessionid || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });
  
//   const normalizedQueryData = queryData.map(query => {
//     let timestamp;
//     if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
//       timestamp = query.timestamp.toDate();
//     } else {
//       timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
//     }
//     return {
//       ...query,
//       sessionId: query.sessionId || query.session_id || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });
  
//   // Group queries by session ID for quicker lookup
//   const queryBySessionId = {};
//   normalizedQueryData.forEach(query => {
//     if (query.sessionId) {
//       queryBySessionId[query.sessionId] = query;
//     }
//   });
  
//   // Combine data with session ID matching first, then timestamp matching
//   const combinedData = [];
  
//   normalizedUserData.forEach(user => {
//     // First try to match by session ID
//     if (user.sessionId && queryBySessionId[user.sessionId]) {
//       const query = queryBySessionId[user.sessionId];
//       combinedData.push({
//         username: user.username || "",
//         email: user.email || "",
//         service: user.service || "",
//         sessionId_user: user.sessionId,
//         sessionId_query: query.sessionId,
//         userTime: user.timeString,
//         queryTime: query.timeString,
//         query_by_bot1: query.query_by_bot1 || "",
//         response_by_bot1: query.response_by_bot1 || "",
//         query_by_bot2: query.query_by_bot2 || "",
//         response_by_bot2: query.response_by_bot2 || "",
//         query_by_bot3: query.query_by_bot3 || "",
//         response_by_bot3: query.response_by_bot3 || ""
//       });
//     } else {
//       // If session ID doesn't match, try time-based matching
//       const userTime = user.normalizedTime;
//       if (!userTime) {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//         return;
//       }
      
//       // Find matching queries within 3-minute window
//       const matchingQueries = normalizedQueryData.filter(query => {
//         const queryTime = query.normalizedTime;
//         if (!queryTime) return false;
        
//         // Compare timestamps with 3-minute window (180000 ms)
//         const timeDiff = Math.abs(userTime - queryTime);
//         return timeDiff <= 180000; // 3 minutes in milliseconds
//       });
      
//       if (matchingQueries.length > 0) {
//         // Use the closest matching query by time
//         matchingQueries.sort((a, b) => {
//           const diffA = Math.abs(userTime - a.normalizedTime);
//           const diffB = Math.abs(userTime - b.normalizedTime);
//           return diffA - diffB;
//         });
        
//         const closestQuery = matchingQueries[0];
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: closestQuery.sessionId,
//           userTime: user.timeString,
//           queryTime: closestQuery.timeString,
//           query_by_bot1: closestQuery.query_by_bot1 || "",
//           response_by_bot1: closestQuery.response_by_bot1 || "",
//           query_by_bot2: closestQuery.query_by_bot2 || "",
//           response_by_bot2: closestQuery.response_by_bot2 || "",
//           query_by_bot3: closestQuery.query_by_bot3 || "",
//           response_by_bot3: closestQuery.response_by_bot3 || ""
//         });
//       } else {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//       }
//     }
//   });

//   const tableRows = combinedData.map(item => `
//     <tr>
//       <td>${escapeHtml(item.username)}</td>
//       <td>${escapeHtml(item.email)}</td>
//       <td>${escapeHtml(item.service)}</td>
//       <td>${escapeHtml(item.sessionId_user)}</td>
//       <td>${escapeHtml(item.sessionId_query)}</td>
//       <td>${escapeHtml(item.userTime)}</td>
//       <td>${escapeHtml(item.queryTime)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
//     </tr>
//   `).join('');
//   return `
//         <html>
//         <head>
//             <title>User Details</title>
//             <style>
//                 table { width: 100%; border-collapse: collapse; }
//                 .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
//                 .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
//                 .overlay { background: rgba(0,0,0,0.5); }
//                 .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
//                 .close-button { float: right; cursor: pointer; font-size: 20px; }
            

//                 body {
//                     font-family: Arial, sans-serif;
//                     margin: 20px;
//                 }
//                 .header {
//                     display: flex;
//                     align-items: center;
//                     margin-bottom: 20px;
//                 }
//                 .logo-img {
//                     height: 40px;
//                     margin-right: 15px;
//                 }
//                 table {
//                     width: 100%;
//                     border-collapse: collapse;
//                     font-size: 0.85em; /* Smaller font size for table */
//                 }
//                 th, td {
//                     border: 1px solid #ccc;
//                     padding: 6px;
//                     text-align: left;
//                 }
//                 th {
//                     background-color: #f2f2f2;
//                     font-weight: bold;
//                 }
//                 h2 {
//                     margin: 0;
//                 }
//             </style>
//         </head>
//         <body>
//             <div class="header">
//                 <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
//                 <h2>User Information</h2>
//             </div>
//             <table id="dataTable">
//         <thead>
//           <tr>
//             <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
//             <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
//             <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
//           </tr>
//         </thead>
//         <tbody>${tableRows}</tbody>
//       </table>
//       <div id="overlay" class="overlay"></div>
//       <div id="expanded-content" class="expanded-content">
//         <span id="close-expanded" class="close-button">&times;</span>
//         <div id="expanded-text"></div>
//       </div>
//         </body>
//         </html>
//     `;
//     document.addEventListener("DOMContentLoaded", function() {
//           const expandableCells = document.querySelectorAll('.expandable-cell');
//           const overlay = document.getElementById('overlay');
//           const expandedContent = document.getElementById('expanded-content');
//           const expandedText = document.getElementById('expanded-text');
//           const closeBtn = document.getElementById('close-expanded');

//           expandableCells.forEach(cell => {
//             cell.addEventListener('click', function() {
//               const content = decodeURIComponent(this.getAttribute('data-content'));
//               expandedText.innerHTML = content;
//               overlay.style.display = 'block';
//               expandedContent.style.display = 'block';
//             });
//           });

//           closeBtn.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           overlay.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           document.getElementById('exportExcel').addEventListener('click', function() {
//             const table = document.getElementById('dataTable');
//             const wb = XLSX.utils.table_to_book(table);
//             XLSX.writeFile(wb, 'UserDetails.xlsx');
//             });
//             });
//    }

    function generateCombinedDetailsHTML(userData, queryData) {
      // Normalize timestamp formats for both datasets
      const normalizedUserData = userData.map(user => {
        let timestamp = parseTimestampForComparison(user.time || user.date || "");
        return {
          ...user,
          sessionId: user.session_id || user.sessionid || "",
          normalizedTime: timestamp,
          timeString: formatTimestamp(timestamp)
        };
      });
      
      const normalizedQueryData = queryData.map(query => {
        let timestamp;
        if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
          timestamp = query.timestamp.toDate();
        } else {
          timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
        }
        return {
          ...query,
          sessionId: query.sessionId || query.session_id || "",
          normalizedTime: timestamp,
          timeString: formatTimestamp(timestamp)
        };
      });
      
      // Group queries by session ID
      const queryBySessionId = {};
      normalizedQueryData.forEach(query => {
        if (query.sessionId) {
          queryBySessionId[query.sessionId] = query;
        }
      });

      const combinedData = [];

      normalizedUserData.forEach(user => {
        if (user.sessionId && queryBySessionId[user.sessionId]) {
          const query = queryBySessionId[user.sessionId];
          combinedData.push({
            ...combineUserQuery(user, query)
          });
        } else {
          const userTime = user.normalizedTime;
          if (!userTime) {
            combinedData.push({
              ...combineUserQuery(user, null)
            });
            return;
          }

          const matchingQueries = normalizedQueryData.filter(query => {
            const queryTime = query.normalizedTime;
            if (!queryTime) return false;
            const timeDiff = Math.abs(userTime - queryTime);
            return timeDiff <= 180000;
          });

          if (matchingQueries.length > 0) {
            matchingQueries.sort((a, b) => {
              const diffA = Math.abs(userTime - a.normalizedTime);
              const diffB = Math.abs(userTime - b.normalizedTime);
              return diffA - diffB;
            });
            const closestQuery = matchingQueries[0];
            combinedData.push({
              ...combineUserQuery(user, closestQuery)
            });
          } else {
            combinedData.push({
              ...combineUserQuery(user, null)
            });
          }
        }
      });

      // Sort by the latest time (descending)
      combinedData.sort((a, b) => {
        const timeA = parseTimestampForComparison(a.userTime || a.queryTime);
        const timeB = parseTimestampForComparison(b.userTime || b.queryTime);
        return timeB - timeA;
      });

      const tableRows = combinedData.map(item => `
        <tr>
          <td>${escapeHtml(item.username)}</td>
          <td>${escapeHtml(item.email)}</td>
          <td>${escapeHtml(item.service)}</td>
          <td>${escapeHtml(item.sessionId_user)}</td>
          <td>${escapeHtml(item.sessionId_query)}</td>
          <td>${escapeHtml(item.userTime)}</td>
          <td>${escapeHtml(item.queryTime)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
        </tr>
      `).join('');

      return `
        <html>
        <head>
          <title>User Details</title>
          <style>
             table { width: 100%; border-collapse: collapse; }
                .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
                .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
                .overlay { background: rgba(0,0,0,0.5); }
                .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
                .close-button { float: right; cursor: pointer; font-size: 20px; }
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { display: flex; align-items: center; margin-bottom: 20px; }
            .logo-img { height: 60px; margin-right: 15px; }
            table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            h2 { margin: 0; }
          </style>
        </head>
        <body>
          <div class="header">
            <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
            <h2>User Information</h2>
          </div>
          <table id="dataTable">
            <thead>
              <tr>
                <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
                <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
                <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </body>
        </html>
      `;

      // Helper function to merge user and query into one object
      function combineUserQuery(user, query) {
        return {
          username: user.username || "",
          email: user.email || "",
          service: user.service || "",
          sessionId_user: user.sessionId,
          sessionId_query: query?.sessionId || "",
          userTime: user.timeString,
          queryTime: query?.timeString || "",
          query_by_bot1: query?.query_by_bot1 || "",
          response_by_bot1: query?.response_by_bot1 || "",
          query_by_bot2: query?.query_by_bot2 || "",
          response_by_bot2: query?.response_by_bot2 || "",
          query_by_bot3: query?.query_by_bot3 || "",
          response_by_bot3: query?.response_by_bot3 || ""
        };
      }
    }

  document.addEventListener('DOMContentLoaded', function () {
    const downloadIcon1 = document.querySelector('.download-icon');

    if (downloadIcon1) {
      downloadIcon1.addEventListener('click', function () {
        exportUserInfoAsExcel();
      });
    }
  });


  function exportUserInfoAsExcel() {
    const table = document.getElementById("data-table");
    if (!table) return;

    const clonedTable = table.cloneNode(true);

    const headers = Array.from(clonedTable.querySelectorAll("thead tr th"));
    const dateColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "date");
    const timeColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "time");

    if (dateColIndex === -1 || timeColIndex === -1) {
      alert("Date or Time column not found!");
      return;
    }

    const rows = Array.from(clonedTable.querySelectorAll("tbody tr"));

    const rowsWithDatetime = rows.map(row => {
      const cells = row.querySelectorAll("td");
      const timeVal = cells[timeColIndex].textContent.trim();
      const currentDateVal = cells[dateColIndex].textContent.trim();

      let date = "";
      let time = "";

      if (timeVal.includes("T")) {
        [date, time] = timeVal.split("T");
      } else if (timeVal.includes(" ")) {
        [date, time] = timeVal.split(" ");
      } else {
        time = timeVal;
      }

      // Only update Date column if it's empty
      if (!currentDateVal) {
        cells[dateColIndex].textContent = date;
      }

      // Always update the Time column to just time part
      cells[timeColIndex].textContent = time;

      // Use date from Time column if available, else fall back to existing Date column
      const fullDateStr = date || currentDateVal;
      const fullDateTime = new Date(`${fullDateStr}T${time}`);

      return { row, datetime: fullDateTime };
    });

    // Sort in descending order
    rowsWithDatetime.sort((a, b) => b.datetime - a.datetime);

    const tbody = clonedTable.querySelector("tbody");
    tbody.innerHTML = "";
    rowsWithDatetime.forEach(({ row }) => tbody.appendChild(row));

    const wb = XLSX.utils.table_to_book(clonedTable, { sheet: "User Info" });
    XLSX.writeFile(wb, "User_Information.xlsx");
  }

// Function to open a new page with combined user details
async function openUserDetailsPages() {
  try {
    document.body.style.cursor = 'wait'; // Show waiting cursor
    
    // Load data from both Firestore collections
    const userSnapshot = await db.collection("testAlloy_UserDetails").get();
    const querySnapshot = await db.collection("testalloy_queries").get();
    
    let userData = [];
    let queryData = [];
    
    userSnapshot.forEach(doc => {
      userData.push(doc.data());
    });
    
    querySnapshot.forEach(doc => {
      queryData.push(doc.data());
    });
    
    // Generate HTML content with combined data
    const htmlContent = generateCombinedDetailsHTML(userData, queryData);
    
    // Open new window with the content
    const newWindow = window.open('', '_blank');
    newWindow.document.write(htmlContent);
    newWindow.document.close();
    document.body.style.cursor = 'default'; // Reset cursor
  } catch (error) {
    console.error("Error opening combined details page:", error);
    alert("Error loading combined user details. Please try again.");
    document.body.style.cursor = 'default'; // Reset cursor
  }
}
document.getElementById("refreshBtn").addEventListener("click", () => {
  location.reload();
});

function escapeHtml(str) {
  return str?.replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;',
    '"': '&quot;', "'": '&#039;'
  })[m]) || '';
}
</script>
</body>
</html>

===============

index.html

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Register</title> -->
  <title>Register</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="login-container">
    <img src="https://testalloy-bot-testrig.web.app/image.png
    " alt="Test Alloy Logo" style="width: 200px; margin-bottom: 20px;" />
    <form id="registerForm">
      <!-- <input type="text" id="regUsername" placeholder="Username" required /> -->
      <input type="email" id="regEmail" placeholder="Email" required />
      <input type="password" id="regPassword" placeholder="Password" required />
      <button type="submit">Register</button>
      <p id="registerMessage"></p>
    </form>
    
      
    <button id="googleLoginBtn" style="background: none; border: none; padding: 0; margin-top: 5px;">
      <img src="https://testalloy-bot-testrig.web.app/sign_up_google%20.jpeg" alt="Register with Google" style="width: 200px;" />
    </button>
    <p>Already have an account? <a href="login.html">Login</a></p>
  </div>
  <script>
    //  Your Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDutX02xinG0RmqoXx6k8eWznlzaHwAgsE",
        authDomain: "chat-bot-project-452312.firebaseapp.com",
        projectId: "chat-bot-project-452312",
        storageBucket: "chat-bot-project-452312.firebasestorage.app",
        messagingSenderId: "61875479783",
        appId: "1:61875479783:web:4dc5ce48b44aa43ec22e42"
    };
      
    //  Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    //  Handle form submission
    document.getElementById("registerForm").addEventListener("submit", function(e) {
      e.preventDefault(); 

      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;
      const username = document.getElementById("regUsername").value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          return user.updateProfile({ displayName: username }); 
        })
        .then(() => {
          document.getElementById("registerMessage").innerText = "Registered successfully!";
        })
        .catch((error) => {
          document.getElementById("registerMessage").innerText = "‚ùå Error: " + error.message;
        });
    });
   
    //Sign in function
    function signInWithGoogle(event) {
      event.preventDefault();
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          console.log("Signed in user:", user);
          alert("Signed in as: " + user.email);
        })
        .catch((error) => {
          console.error("Sign-in error:", error);
        });
    }
    // Attach listener after DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("googleLoginBtn").addEventListener("click", signInWithGoogle);
    });
    
  </script>
</body>
</html>

login.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login Page</title>
  <link rel="stylesheet" href="styles.css"/>
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="loginin-container">
    <img src="https://testalloy-bot-testrig.web.app/image.png
    " alt="Test Alloy Logo" style="width: 200px; margin-bottom: 20px;" />
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required/>
      <input type="password" id="password" placeholder="Password" required/>
      <button type="submit">Login</button>
      <p id="error" class="error-message"></p>


    </form>

    

      <button id="googleLoginBtn" style="background: none; border: none; padding: 0; margin-top: 5px;">
        <img src="https://testalloy-bot-testrig.web.app/google_signin.png" alt="Register with Google" style="width: 200px;" />
      </button>
      
      <p id="status" class="error-message" style="color: red; margin-top: 10px;"></p>
      
   
    <!-- <button onclick="loginWithGoogle()">Login with Google</button>
    <p id="status" style="color: red;"></p> -->


    <p>Don't have an account? <a href="index.html">Register</a></p>
  </div>  

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDutX02xinG0RmqoXx6k8eWznlzaHwAgsE",
        authDomain: "chat-bot-project-452312.firebaseapp.com",
        projectId: "chat-bot-project-452312",
        storageBucket: "chat-bot-project-452312.firebasestorage.app",
        messagingSenderId: "61875479783",
        appId: "1:61875479783:web:4dc5ce48b44aa43ec22e42"
    };

    // ‚úÖ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ‚úÖ Login Logic
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // ‚úÖ Redirect on success
          window.location.href = "dash.html";
        })
        .catch((error) => {
          // ‚ùå Show error message
          document.getElementById("error").innerText = "Login failed,: " + error.message;
        });
    });
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();

      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;

          // ‚úÖ Check if user exists (sign-in successful)
          if (user && user.email) {
            // Optional: email verification check (skip if not needed)
            if (!user.emailVerified) {
               document.getElementById("status").innerText = "Please verify your email.";
              return;
             }

            // ‚úÖ Login successful, redirect
            window.location.href = "dash.html";
          } else {
            document.getElementById("status").innerText = "Login failed, please register your email ID.";
          }
        })
        .catch((error) => {
          //Catch sign-in errors
          console.error("Login error:", error);
          document.getElementById("status").innerText = "Login failed, please register your email ID.";
        });
    }
    // Attach listener after DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("googleLoginBtn").addEventListener("click", loginWithGoogle);
    });
  </script>
</body>
</html>


//Global variables to store data
let allUserData = [];
let allQueryData = [];
let combinedData = [];
let filteredData = [];

// Improved applyFilters function to filter data and update charts
function applyFilters() {
const startDateStr = document.getElementById("startDate").value;
const endDateStr = document.getElementById("endDate").value;
const serviceFilter = document.getElementById("serviceFilter").value;

console.log("Applying filters:", startDateStr, endDateStr, serviceFilter);

// Create Date objects for comparison (set to start/end of day)
let startDate = null;
let endDate = null;

if (startDateStr) {
  startDate = new Date(startDateStr);
  startDate.setHours(0, 0, 0, 0);
}

if (endDateStr) {
  endDate = new Date(endDateStr);
  endDate.setHours(23, 59, 59, 999);
}

// Filter the data based on selected criteria
filteredData = allUserData.filter(item => {
  // Parse the timestamp from the item
  let itemDate = null;
  
  // Handle different date formats
  if (item.time && typeof item.time === 'string') {
    if (item.time.includes(' ')) {
      // Format: "2025-04-17 10:36:57"
      const [dateStr, timeStr] = item.time.split(' ');
      itemDate = new Date(dateStr);
    } else if (item.time.includes('T')) {
      // ISO format
      itemDate = new Date(item.time);
    }
  } else if (item.date) {
    // Just date field
    itemDate = new Date(item.date);
  }
  
  // Check if date is in range
  let passesDateFilter = true;
  if (startDate && itemDate && itemDate < startDate) {
    passesDateFilter = false;
  }
  if (endDate && itemDate && itemDate > endDate) {
    passesDateFilter = false;
  }
  
  // Check if service matches
  let passesServiceFilter = true;
  if (serviceFilter && item.service !== serviceFilter) {
    passesServiceFilter = false;
  }
  
  return passesDateFilter && passesServiceFilter;
});

console.log(`Data filtered: ${filteredData.length} records match criteria`);

// Update the table with filtered data
updateTableWithFilteredData(filteredData);

// Update charts with filtered data
updateCharts(filteredData);
}

  // Function to update the table with filtered data
  function updateTableWithFilteredData(data) {
    const tableBody = document.getElementById("table-body");
    tableBody.innerHTML = "";
    
    if (data.length === 0) {
      tableBody.innerHTML = "<tr><td colspan='6'>No data matches the selected filters</td></tr>";
      return;
    }
    
    data.forEach(item => {
      // Split datetime into date and time parts if needed
      let date = "";
      let time = "";
      
      if (item.time && item.time.includes(" ")) {
        const timeParts = item.time.split(" ");
        date = timeParts[0];
        time = timeParts[1];
      } else {
        date = item.date || "";
        time = item.time || "";
      }
      
      const row = `
        <tr>
          <td>${item.username || ""}</td>
          <td>${item.email || ""}</td>
          <td>${item.service || ""}</td>
          <td>${item.session_id || item.sessionid || ""}</td>
          <td>${date}</td>
          <td>${time}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  // Update the event listener for the Apply button
  document.getElementById("applyFilters").addEventListener("click", function() {
    applyFilters();
  });

  // Update the event listener for the Reset button
  document.getElementById("resetFilters").addEventListener("click", function() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("serviceFilter").value = "";
    
    // Reset to show all data
    filteredData = allUserData;
    updateTableWithFilteredData(allUserData);
    updateCharts(allUserData);
  });


// Helper function to parse timestamp
function parseTimestamp(timeStr) {
  if (!timeStr) return null;
  
  // Handle format "2025-04-17 10:36:57"
  const dateParts = timeStr.split(' ');
  if (dateParts.length === 2) {
    const [dateStr, timeStr] = dateParts;
    const [year, month, day] = dateStr.split('-').map(Number);
    const [hours, minutes, seconds] = timeStr.split(':').map(Number);
    return new Date(year, month - 1, day, hours, minutes, seconds);
  }
  
  // Try to parse as ISO string
  try {
    return new Date(timeStr);
  } catch (e) {
    console.error("Error parsing timestamp:", e);
    return null;
  }
}




// Load user data from Firestore
async function loadUserData() {
  try {
    document.getElementById("tableLoader").style.display = "block";
    const snapshot = await db.collection("testrig_UserDetails").get();
    const tableBody = document.getElementById("table-body");
    tableBody.innerHTML = "";
    allUserData = [];

    if (snapshot.empty) {
      tableBody.innerHTML = "<tr><td colspan='6'>No data available</td></tr>";
      document.getElementById("tableLoader").style.display = "none";
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      // Store data for filtering
      allUserData.push(data);
      
      // Check if time field contains both date and time
      let date = "";
      let time = "";
      
      if (data.time && data.time.includes(" ")) {
        // Split datetime into date and time parts
        const timeParts = data.time.split(" ");
        date = timeParts[0];
        time = timeParts[1];
      } else {
        // If separate fields exist, use them
        date = data.date || "";
        time = data.time || "";
      }
      
      const row = `
        <tr>
          <td>${data.username || ""}</td>
          <td>${data.email || ""}</td>
          <td>${data.service || ""}</td>
          <td>${data.session_id || data.sessionid || ""}</td>
          <td>${date}</td>
          <td>${time}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
    
    // Populate service dropdown with unique services
    populateServiceDropdown();
    
    // Update charts
    updateCharts(allUserData);
    
    document.getElementById("tableLoader").style.display = "none";
  } catch (error) {
    console.error("Error loading user data: ", error);
    document.getElementById("table-body").innerHTML = 
      "<tr><td colspan='6'>Error loading data. Please try again.</td></tr>";
    document.getElementById("tableLoader").style.display = "none";
  }
}

 


// Function to initialize charts
function initializeCharts() {
 console.log("Initializing charts");

// Check if Chart.js is loaded
 if (typeof Chart === 'undefined') {
   console.error("Chart.js not loaded! Adding it now...");
  
  // Load Chart.js dynamically if not already loaded
   const script = document.createElement('script');
   script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
   script.onload = function() {
    console.log("Chart.js loaded successfully!");
    // Create chart containers if they don't exist
    createChartContainers();
  };
  document.head.appendChild(script);
} else {
  console.log("Chart.js already loaded!");
  // Create chart containers if they don't exist
  createChartContainers();
}
}

// Load query data from Firestore
async function loadQueryData() {
  try {
    document.getElementById("chatLoader").style.display = "block";
    const snapshot = await db.collection("testrig_queries").get();
    const chatBody = document.getElementById("chat-body");
    chatBody.innerHTML = "";
    allQueryData = [];

    if (snapshot.empty) {
      chatBody.innerHTML = "<tr><td colspan='5'>No chat data available</td></tr>";
      document.getElementById("chatLoader").style.display = "none";
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      // Store data for combining
      allQueryData.push(data);
      
      // Format timestamp
      let formattedTime = "";
      if (data.timestamp) {
        const timestamp = typeof data.timestamp === 'object' && data.timestamp.toDate ? 
                          data.timestamp.toDate() : 
                          new Date(data.timestamp);
        formattedTime = timestamp.toLocaleString();
      }
      
      const row = `
        <tr>
          <td>${data.session_id || ""}</td>
          <td class="expandable-cell" data-content="${encodeURIComponent(data.query || "")}">
            <span class="truncate">${data.query || ""}</span>
          </td>
          <td class="expandable-cell" data-content="${encodeURIComponent(data.response || "")}">
            <span class="truncate">${data.response || ""}</span>
          </td>
          <td>${data.bot || ""}</td>
          <td>${formattedTime}</td>
        </tr>
      `;
      chatBody.innerHTML += row;
    });
    
    // Add click handlers for expandable cells
    setupExpandableCells();
    
    document.getElementById("chatLoader").style.display = "none";
  } catch (error) {
    console.error("Error loading query data: ", error);
    document.getElementById("chat-body").innerHTML = 
      "<tr><td colspan='5'>Error loading chat data. Please try again.</td></tr>";
    document.getElementById("chatLoader").style.display = "none";
  }
}

// Setup handlers for expandable cells
function setupExpandableCells() {
  const expandableCells = document.querySelectorAll('.expandable-cell');
  const overlay = document.getElementById('overlay');
  const expandedContent = document.getElementById('expanded-content');
  const expandedText = document.getElementById('expanded-text');
  const closeBtn = document.getElementById('close-expanded');
  
  expandableCells.forEach(cell => {
    cell.addEventListener('click', function() {
      const content = decodeURIComponent(this.getAttribute('data-content'));
      expandedText.textContent = content;
      overlay.style.display = 'block';
      expandedContent.style.display = 'block';
    });
  });
  
  closeBtn.addEventListener('click', function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  });
  
  overlay.addEventListener('click', function() {
    overlay.style.display = 'none';
    expandedContent.style.display = 'none';
  });
}

// Populate service dropdown from the data
function populateServiceDropdown() {
  const serviceFilter = document.getElementById("serviceFilter");
  // Keep the first option "All Services"
  serviceFilter.innerHTML = '<option value="">All Services</option>';
  
  // Get unique services
  const uniqueServices = [...new Set(allUserData.map(item => item.service))];
  
  // Add each unique service to the dropdown
  uniqueServices.forEach(service => {
    if (service) { // Only add non-empty services
      const option = document.createElement("option");
      option.value = service;
      option.textContent = service;
      serviceFilter.appendChild(option);
    }
  });
}

// Function to update charts based on data
function updateCharts(data) {
  // Implementation of chart updates will go here
  // This is a placeholder for now
  console.log("Chart data updated with", data.length, "records");
}

// Apply filters
document.getElementById("applyFilters").addEventListener("click", function() {
  applyFilters();
});

// Reset filters
document.getElementById("resetFilters").addEventListener("click", function() {
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  document.getElementById("serviceFilter").value = "";
  document.getElementById("searchInput").value = "";
  
  // Reset to original data
  if (document.getElementById("tableContainer").style.display === "block") {
    loadUserData();
  } else if (document.getElementById("combinedContainer").style.display === "block") {
    updateCombinedTable(combinedData);
  }
});



// Search button
document.getElementById("searchBtn").addEventListener("click", function() {
  applyFilters();
});

// Clear search
document.getElementById("clearSearch").addEventListener("click", function() {
  document.getElementById("searchInput").value = "";
  applyFilters();
});


// Function to load and combine data from both collections
async function loadCombinedData() {
try {
  document.getElementById("combinedLoader").style.display = "block";
  combinedData = [];
  
  // Make sure we have both data sets
  if (allUserData.length === 0) {
    const userSnapshot = await db.collection("testrig_UserDetails").get();
    userSnapshot.forEach(doc => {
      allUserData.push(doc.data());
    });
  }
  
  // Load query data with the actual field structure
  const querySnapshot = await db.collection("testrig_queries").get();
  allQueryData = [];
  querySnapshot.forEach(doc => {
    allQueryData.push(doc.data());
  });
  
  // Create a map to store queries by session_id
  const queryMap = {};
  
  allQueryData.forEach(query => {
    const sessionId = query.sessionId || "";
    if (!sessionId) return;
    
    // Store the query by session ID
    queryMap[sessionId] = {
      query_by_bot1: query.query_by_bot1 || "",
      response_by_bot1: query.response_by_bot1 || "",
      query_by_bot2: query.query_by_bot2 || "",
      response_by_bot2: query.response_by_bot2 || "",
      timestamp: query.timestamp || query.time
    };
  });
  
  // Combine user data with query data
  allUserData.forEach(userData => {
    const sessionId = userData.session_id || userData.sessionid || "";
    if (!sessionId) return;
    
    // Create a combined record
    const combined = {
      username: userData.username || "",
      email: userData.email || "",
      service: userData.service || "",
      sessionid_details: sessionId,
      date: "",
      time: "",
      query_by_bot1: "",
      response_by_bot1: "",
      query_by_bot2: "",
      response_by_bot2: "",
      sessionid_queries: ""
    };
    
    // Format the date and time
    if (userData.time && userData.time.includes(" ")) {
      const parts = userData.time.split(" ");
      combined.date = parts[0];
      combined.time = parts[1];
    } else {
      combined.date = userData.date || "";
      combined.time = userData.time || "";
    }
    
    // Parse user timestamp
    let userTime = parseTimestamp(userData.time);
    
    // If we have corresponding query data by session ID, add it
    if (queryMap[sessionId]) {
      combined.query_by_bot1 = queryMap[sessionId].query_by_bot1 || "";
      combined.response_by_bot1 = queryMap[sessionId].response_by_bot1 || "";
      combined.query_by_bot2 = queryMap[sessionId].query_by_bot2 || "";
      combined.response_by_bot2 = queryMap[sessionId].response_by_bot2 || "";
      combined.sessionid_queries = sessionId;
    } else {
      // Try to find query data based on timestamp matching
      // within a 3-minute window (180 seconds)
      allQueryData.forEach(query => {
        if (!query.timestamp && !query.time) return;
        
        let queryTime;
        if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
          queryTime = query.timestamp.toDate();
        } else {
          queryTime = parseTimestamp(query.timestamp || query.time);
        }
        
        if (!queryTime || !userTime) return;
        
        // Compare timestamps with 180-second window
        const timeDiff = Math.abs(userTime - queryTime) / 1000; // difference in seconds
        if (timeDiff <= 180) { // 3 minutes
          combined.query_by_bot1 = query.query_by_bot1 || "";
          combined.response_by_bot1 = query.response_by_bot1 || "";
          combined.query_by_bot2 = query.query_by_bot2 || "";
          combined.response_by_bot2 = query.response_by_bot2 || "";
          combined.sessionid_queries = query.sessionId || "";
        }
      });
    }
    
    combinedData.push(combined);
  });
  
  // Update the combined table
  updateCombinedTable(combinedData);
  
  document.getElementById("combinedLoader").style.display = "none";
} catch (error) {
  console.error("Error loading combined data: ", error);
  document.getElementById("combined-body").innerHTML = 
    "<tr><td colspan='12'>Error loading combined data. Please try again.</td></tr>";
  document.getElementById("combinedLoader").style.display = "none";
}
}

// Update the combined data table with the new structure
function updateCombinedTable(data) {
const tableBody = document.getElementById("combined-body");
tableBody.innerHTML = "";

if (data.length === 0) {
  tableBody.innerHTML = "<tr><td colspan='12'>No combined data available</td></tr>";
  return;
}

// Update table headers to match the new structure
const tableHeaders = document.querySelector("#combined-table thead tr");
tableHeaders.innerHTML = `
  <th>Username</th>
  <th>Email</th>
  <th>Service</th>
  <th>SessionID Details</th>
  <th>SessionID Queries</th>
  <th>Date</th>
  <th>Time</th>
  <th>Query Bot 1</th>
  <th>Response Bot 1</th>
  <th>Query Bot 2</th>
  <th>Response Bot 2</th>
`;

data.forEach(item => {
  const row = `
    <tr>
      <td>${item.username}</td>
      <td>${item.email}</td>
      <td>${item.service}</td>
      <td>${item.sessionid_details}</td>
      <td>${item.sessionid_queries}</td>
      <td>${item.date}</td>
      <td>${item.time}</td>
      <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">
        <span class="truncate">${item.query_by_bot1}</span>
      </td>
      <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">
        <span class="truncate">${item.response_by_bot1}</span>
      </td>
      <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">
        <span class="truncate">${item.query_by_bot2}</span>
      </td>
      <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">
        <span class="truncate">${item.response_by_bot2}</span>
      </td>
    </tr>
  `;
  tableBody.innerHTML += row;
});

// Setup expandable cells
setupExpandableCells();
}

// Improved timestamp parsing function to handle different formats
function parseTimestamp(timeStr) {
if (!timeStr) return null;

// Handle format "2025-04-17 10:36:57"
if (typeof timeStr === 'string' && timeStr.includes(' ')) {
  const dateParts = timeStr.split(' ');
  if (dateParts.length === 2) {
    const [dateStr, timeStr] = dateParts;
    const [year, month, day] = dateStr.split('-').map(Number);
    const [hours, minutes, seconds] = timeStr.split(':').map(Number);
    return new Date(year, month - 1, day, hours, minutes, seconds);
  }
}

// Handle ISO format "2025-04-15T12:46:23.657471"
if (typeof timeStr === 'string' && timeStr.includes('T')) {
  return new Date(timeStr);
}

// Handle Firebase timestamp objects
if (typeof timeStr === 'object' && timeStr.toDate) {
  return timeStr.toDate();
}

// Handle string like "15 April 2025 at 18:16:23.6"
if (typeof timeStr === 'string' && timeStr.includes('at')) {
  const dateRegex = /(\d+)\s+(\w+)\s+(\d+)\s+at\s+(\d+):(\d+):(\d+)/;
  const match = timeStr.match(dateRegex);
  if (match) {
    const [_, day, month, year, hours, minutes, seconds] = match;
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const monthIndex = monthNames.findIndex(m => m === month);
    if (monthIndex !== -1) {
      return new Date(parseInt(year), monthIndex, parseInt(day), parseInt(hours), parseInt(minutes), parseInt(seconds));
    }
  }
}

// Try to parse as generic date string
try {
  return new Date(timeStr);
} catch (e) {
  console.error("Error parsing timestamp:", e);
  return null;
}
}



// function addDashboardSummary() {
// // Create a summary section above the charts
// const rightPanel = document.querySelector('.right-panel');
// const chartsContainer = document.querySelector('.charts');

// // Create summary section element
// const summarySection = document.createElement('div');
// summarySection.className = 'dashboard-summary';
// summarySection.innerHTML = `
//   <div class="dashboard-header">
//   </div>
//   <div class="summary-cards">
//   <div class="summary-card" id="total-users">
//       <div class="card-icon">üë§</div>
//       <div class="card-content">
//       <h3>Total Users</h3>
//       <p class="card-value">0</p>
//       </div>
//   </div>
//   <div class="summary-card" id="users-today">
//       <div class="card-icon">üë§</div>
//       <div class="card-content">
//       <h3>Users Today</h3>
//       <p class="card-value">-</p>
//       </div>    
//   </div>
//   <div class="summary-card" id="returning-users">
//       <div class="card-icon">üë§</div>
//       <div class="card-content">
//       <h3>Returning Users</h3>
//       <p class="card-value">-</p>
//       </div>

//   </div>
//   <div class="summary-card" id="online-users">
//       <div class="card-icon">üë§</div>
//       <div class="card-content">
//       <h3>Online Users</h3>
//       <p class="card-value">-</p>
//       </div>
//   </div>
//   <div class="summary-card" id="total-sessions">
//       <div class="card-icon">üîÑ</div>
//       <div class="card-content">
//       <h3>Total Sessions</h3>
//       <p class="card-value">0</p>
//       </div>
//   </div>
//   <div class="summary-card" id="active-services">
//       <div class="card-icon">üß©</div>
//       <div class="card-content">
//       <h3>Number of Services</h3>
//       <p class="card-value">0</p>
//       </div>
//   </div>
//   <div class="summary-card" id="top-service">
//       <div class="card-icon">üî•</div>
//       <div class="card-content">
//       <h3>Top Service</h3>
//       <p class="card-value">-</p>
//       </div>
//   </div>
//   <div class="summary-card" id="avg-sessions">
//       <div class="card-icon">üìä</div>
//       <div class="card-content">
//       <h3>Avg Sessions per User</h3>
//       <p class="card-value">0</p>
//       </div>
//   </div>
// `;

function addDashboardSummary() {
    const rightPanel = document.querySelector('.right-panel');
    const chartsContainer = document.querySelector('.charts');
  
    const summarySection = document.createElement('div');
    summarySection.className = 'dashboard-summary';
    summarySection.innerHTML = `
      <div class="dashboard-header"></div>
      <div class="summary-cards">
        <div class="summary-card" id="total-users">
          <div class="card-icon">üë§</div>
          <div class="card-content">
            <h3>Total Users</h3>
            <p class="card-value">0</p>
          </div>
        </div>
        <div class="summary-card" id="users-today">
          <div class="card-icon">üìÖ</div>
          <div class="card-content">
            <h3>Users Today</h3>
            <p class="card-value">-</p>
          </div>    
        </div>
        <div class="summary-card" id="returning-users">
          <div class="card-icon">üîÅ</div>
          <div class="card-content">
            <h3>Returning Users</h3>
            <p class="card-value">-</p>
          </div>
        </div>
        <div class="summary-card" id="todays-new-users">
          <div class="card-icon">üÜï</div>
          <div class="card-content">
            <h3>Today's New Users</h3>
            <p class="card-value">-</p>
          </div>
        </div>
        <div class="summary-card" id="total-sessions">
          <div class="card-icon">üîÑ</div>
          <div class="card-content">
            <h3>Total Sessions</h3>
            <p class="card-value">0</p>
          </div>
        </div>
        <div class="summary-card" id="active-services">
          <div class="card-icon">üß©</div>
          <div class="card-content">
            <h3>Number of Services</h3>
            <p class="card-value">0</p>
          </div>
        </div>
        <div class="summary-card" id="top-service">
          <div class="card-icon">üî•</div>
          <div class="card-content">
            <h3>Top Service</h3>
            <p class="card-value">-</p>
          </div>
        </div>
        <div class="summary-card" id="avg-sessions">
          <div class="card-icon">üìä</div>
          <div class="card-content">
            <h3>Avg Sessions per User</h3>
            <p class="card-value">0</p>
          </div>
        </div>
      </div>
    `;

// Insert the summary section before the charts
rightPanel.insertBefore(summarySection, chartsContainer);

// Add CSS for the summary section
const style = document.createElement('style');
style.textContent = `
  .dashboard-summary {
    margin-bottom: 30px;
  }
  
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .summary-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  
  .card-icon {
    font-size: 24px;
    margin-right: 15px;
  }
  
  .card-content h3 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #666;
  }
  
  .card-value {
    margin: 0;
    
    font-weight: bold;
    color: #333;
  }
  
  @media (max-width: 1024px) {
    .summary-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 576px) {
    .summary-cards {
      grid-template-columns: 1fr;
    }
  }
`;
document.head.appendChild(style);

// Update the summary cards with data
updateDashboardSummary(allUserData);
}

function parseTimestamping(timestamp) {
if (!timestamp) return null;
const dateObj = new Date(timestamp);
return isNaN(dateObj) ? null : dateObj;
}

function formatDateToISOString(dateObj) {
const yyyy = dateObj.getFullYear();
const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
const dd = String(dateObj.getDate()).padStart(2, '0');
return `${yyyy}-${mm}-${dd}`;
}

// function updateDashboardSummary(data) {
// const uniqueEmails = new Set();
// const emailCount = {};
// const serviceCount = {};

// // Get today's date in Indian Standard Time (IST)
// const now = new Date();
// const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));

// // Format today's date as YYYY-MM-DD for comparison with database dates
// const todayFormatted = todayIST.getFullYear() + '-' + 
//                        String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
//                        String(todayIST.getDate()).padStart(2, '0');

// let usersToday = 0;
// let onlineUsers = 0;

// // Set to track unique users today (to avoid counting the same user multiple times)
// const uniqueUsersToday = new Set();

// data.forEach(item => {
//   // Unique emails
//   if (item.email) {
//     uniqueEmails.add(item.email);
//     emailCount[item.email] = (emailCount[item.email] || 0) + 1;
//   }

//   // Count services
//   if (item.service) {
//     serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
//   }

  

//   if (item.time) {
//     const itemDate = item.time.split(" ")[0]; // Extract '2025-04-22' from '2025-04-22 11:16:18'
//     if (itemDate === todayFormatted && item.email) {
//       uniqueUsersToday.add(item.email);
//     }
//   }


//   // Online users: session within last 5 minutes
//   if (item.date && item.time) {
//     const sessionTime = parseTimestamping(`${item.date} ${item.time}`);
//     if (sessionTime && (now - sessionTime) / 1000 <= 300) {
//       onlineUsers++;
//     }
//   }
// });

// // Set usersToday to the count of unique users who interacted today
// usersToday = uniqueUsersToday.size;

// // Total sessions
// const totalSessions = data.length;

// // Active unique services
// const uniqueServices = new Set(Object.keys(serviceCount));

// // Avg sessions per user
// const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;

// // Top engaged service
// let topService = "-";
// let maxServiceCount = 0;
// for (const [service, count] of Object.entries(serviceCount)) {
//   if (count > maxServiceCount) {
//     topService = service;
//     maxServiceCount = count;
//   }
// }

// // Returning users: email seen more than once
// const returningUsers = Object.values(emailCount).filter(count => count > 1).length;

// document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
// document.querySelector('#total-users .card-value').setAttribute('title', `Unique users: ${uniqueEmails.size}`);

// document.querySelector('#total-sessions .card-value').textContent = totalSessions;
// document.querySelector('#total-sessions .card-value').setAttribute('title', `Total sessions: ${totalSessions}`);

// document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
// document.querySelector('#active-services .card-value').setAttribute('title', `Unique services used: ${uniqueServices.size}`);

// document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
// document.querySelector('#avg-sessions .card-value').setAttribute('title', `Avg sessions per user: ${avgSessions}`);

// // document.querySelector('#top-service .card-value').innerHTML = `<h6>${topService}</small>`;
// // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
// // document.querySelector('#top-service .card-value').textContent = topService;
// // document.querySelector('#top-service .card-value').setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);

// document.querySelector('#users-today .card-value').textContent = usersToday;
// document.querySelector('#users-today .card-value').setAttribute('title', `Users Today: ${usersToday}`);

// document.querySelector('#online-users .card-value').textContent = onlineUsers;
// document.querySelector('#online-users .card-value').setAttribute('title', `Active within 5 mins: ${onlineUsers}`);

// document.querySelector('#returning-users .card-value').textContent = returningUsers;
// document.querySelector('#returning-users .card-value').setAttribute('title', `Users with multiple visits: ${returningUsers}`);

// const topServiceElem = document.querySelector('#top-service .card-value');
// topServiceElem.textContent = topService;
// topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
// topServiceElem.classList.add('h6-style'); // Add a CSS class




// const allCards = document.querySelectorAll('.summary-card h3');
// allCards.forEach(card => {
//   const title = card.textContent.trim();
//   const valueElem = card.parentNode.querySelector('.card-value');

//   if (title === 'Users Interacted today') {
//     valueElem.textContent = usersToday;
//     valueElem.setAttribute('title', `Users today: ${usersToday}`);
//   } else if (title === 'Online Users') {
//     valueElem.textContent = onlineUsers;
//     valueElem.setAttribute('title', `Active within 5 mins: ${onlineUsers}`);
//   } else if (title === 'Returning Users') {
//     valueElem.textContent = returningUsers;
//     valueElem.setAttribute('title', `Users with multiple visits: ${returningUsers}`);
//   }
// });

// console.log({ todayFormatted, usersToday, topService });
// }


// function updateDashboardSummary(data) {
//     const uniqueEmails = new Set();
//     const emailCount = {};
//     const serviceCount = {};
  
//     // Get current time in IST
//     const nowIST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//     // Format today's date as YYYY-MM-DD
//     const todayFormatted = nowIST.getFullYear() + '-' + 
//                            String(nowIST.getMonth() + 1).padStart(2, '0') + '-' + 
//                            String(nowIST.getDate()).padStart(2, '0');
  
//     let usersToday = 0;
//     let onlineUsers = 0;
//     const recentUsers = new Set();
//     const uniqueUsersToday = new Set();
  
//     data.forEach(item => {
//       if (item.email) {
//         uniqueEmails.add(item.email);
//         emailCount[item.email] = (emailCount[item.email] || 0) + 1;
//       }
  
//       if (item.service) {
//         serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
//       }
  
//       if (item.time) {
//         const itemDate = item.time.split(" ")[0];
//         if (itemDate === todayFormatted && item.email) {
//           uniqueUsersToday.add(item.email);
//         }
//       }
  
//       // Online user check (within last 5 mins IST)
//       if (item.date && item.time && item.email) {
//         const sessionIST = new Date(`${item.date}T${item.time}`);
//         const sessionLocalIST = new Date(sessionIST.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//         const diffSeconds = (nowIST - sessionLocalIST) / 1000;
//         if (diffSeconds >= 0 && diffSeconds <= 300) {
//           onlineUsers++;
//           recentUsers.add(item.email);
//         }
//       }
//     });
  
//     usersToday = uniqueUsersToday.size;
  
//     const totalSessions = data.length;
//     const uniqueServices = new Set(Object.keys(serviceCount));
//     const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;
  
//     let topService = "-";
//     let maxServiceCount = 0;
//     for (const [service, count] of Object.entries(serviceCount)) {
//       if (count > maxServiceCount) {
//         topService = service;
//         maxServiceCount = count;
//       }
//     }
  
//     const returningUsers = Object.values(emailCount).filter(count => count > 1).length;
  
//     document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
//     document.querySelector('#total-users .card-value').setAttribute('title', `Unique users: ${uniqueEmails.size}`);
  
//     document.querySelector('#total-sessions .card-value').textContent = totalSessions;
//     document.querySelector('#total-sessions .card-value').setAttribute('title', `Total sessions: ${totalSessions}`);
  
//     document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
//     document.querySelector('#active-services .card-value').setAttribute('title', `Unique services used: ${uniqueServices.size}`);
  
//     document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
//     document.querySelector('#avg-sessions .card-value').setAttribute('title', `Avg sessions per user: ${avgSessions}`);
  
//     document.querySelector('#users-today .card-value').textContent = usersToday;
//     document.querySelector('#users-today .card-value').setAttribute('title', `Users Today: ${usersToday}`);
  
//     document.querySelector('#online-users .card-value').textContent = recentUsers.size;
//     document.querySelector('#online-users .card-value').setAttribute('title', `Active within 5 mins: ${recentUsers.size}`);
  
//     document.querySelector('#returning-users .card-value').textContent = returningUsers;
//     document.querySelector('#returning-users .card-value').setAttribute('title', `Users with multiple visits: ${returningUsers}`);
  
//     const topServiceElem = document.querySelector('#top-service .card-value');
//     topServiceElem.textContent = topService;
//     topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
//     topServiceElem.classList.add('h6-style');
  
//     console.log({ todayFormatted, usersToday, recentUsers, topService,onlineUsers });
//   }

// function updateDashboardSummary(data) {
//     const uniqueEmails = new Set();
//     const emailCount = {};
//     const serviceCount = {};
  
//     const now = new Date();
//     const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//     const todayFormatted = todayIST.getFullYear() + '-' + 
//                            String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
//                            String(todayIST.getDate()).padStart(2, '0');
  
//     let usersToday = 0;
  
//     const uniqueUsersToday = new Set();
  
//     data.forEach(item => {
//       if (item.email) {
//         uniqueEmails.add(item.email);
//         emailCount[item.email] = (emailCount[item.email] || 0) + 1;
//       }
  
//       if (item.service) {
//         serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
//       }
  
//       if (item.time) {
//         const itemDate = item.time.split(" ")[0];
//         if (itemDate === todayFormatted && item.email) {
//           uniqueUsersToday.add(item.email);
//         }
//       }
//     });
  
//     const todaysNewUsers = uniqueUsersToday.size;
//     usersToday = todaysNewUsers;
  
//     const totalSessions = data.length;
//     const uniqueServices = new Set(Object.keys(serviceCount));
//     const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;
  
//     let topService = "-";
//     let maxServiceCount = 0;
//     for (const [service, count] of Object.entries(serviceCount)) {
//       if (count > maxServiceCount) {
//         topService = service;
//         maxServiceCount = count;
//       }
//     }
  
//     const returningUsers = Object.values(emailCount).filter(count => count > 1).length;
  
//     document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
//     document.querySelector('#total-sessions .card-value').textContent = totalSessions;
//     document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
//     document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
//     document.querySelector('#users-today .card-value').textContent = usersToday;
//     document.querySelector('#returning-users .card-value').textContent = returningUsers;
//     document.querySelector('#todays-new-users .card-value').textContent = todaysNewUsers;
  
//     const topServiceElem = document.querySelector('#top-service .card-value');
//     topServiceElem.textContent = topService;
//     topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  
//     console.log({ todayFormatted, usersToday, topService });
//   }
  
// function updateDashboardSummary(data) {
//     const uniqueEmails = new Set();
//     const emailCount = {};
//     const serviceCount = {};
  
//     // Get current time in IST
//     const nowIST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//     // Format today's date as YYYY-MM-DD
//     const todayFormatted = nowIST.getFullYear() + '-' + 
//                            String(nowIST.getMonth() + 1).padStart(2, '0') + '-' + 
//                            String(nowIST.getDate()).padStart(2, '0');
  
//     let usersToday = 0;
//     let onlineUsers = 0;
//     const recentUsers = new Set();
//     const uniqueUsersToday = new Set();
  
//     data.forEach(item => {
//       if (item.email) {
//         uniqueEmails.add(item.email);
//         emailCount[item.email] = (emailCount[item.email] || 0) + 1;
//       }
  
//       if (item.service) {
//         serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
//       }
  
//       if (item.time) {
//         const itemDate = item.time.split(" ")[0];
//         if (itemDate === todayFormatted && item.email) {
//           uniqueUsersToday.add(item.email);
//         }
//       }
  
//       // Online user check (within last 5 mins IST)
//       if (item.date && item.time && item.email) {
//         const sessionIST = new Date(`${item.date}T${item.time}`);
//         const sessionLocalIST = new Date(sessionIST.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//         const diffSeconds = (nowIST - sessionLocalIST) / 1000;
//         if (diffSeconds >= 0 && diffSeconds <= 300) {
//           onlineUsers++;
//           recentUsers.add(item.email);
//         }
//       }
//     });
  
//     usersToday = uniqueUsersToday.size;
  
//     const totalSessions = data.length;
//     const uniqueServices = new Set(Object.keys(serviceCount));
//     const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;
  
//     let topService = "-";
//     let maxServiceCount = 0;
//     for (const [service, count] of Object.entries(serviceCount)) {
//       if (count > maxServiceCount) {
//         topService = service;
//         maxServiceCount = count;
//       }
//     }
  
//     const returningUsers = Object.values(emailCount).filter(count => count > 1).length;
  
//     document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
//     document.querySelector('#total-users .card-value').setAttribute('title', `Unique users: ${uniqueEmails.size}`);
  
//     document.querySelector('#total-sessions .card-value').textContent = totalSessions;
//     document.querySelector('#total-sessions .card-value').setAttribute('title', `Total sessions: ${totalSessions}`);
  
//     document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
//     document.querySelector('#active-services .card-value').setAttribute('title', `Unique services used: ${uniqueServices.size}`);
  
//     document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
//     document.querySelector('#avg-sessions .card-value').setAttribute('title', `Avg sessions per user: ${avgSessions}`);
  
//     document.querySelector('#users-today .card-value').textContent = usersToday;
//     document.querySelector('#users-today .card-value').setAttribute('title', `Users Today: ${usersToday}`);
  
//     document.querySelector('#online-users .card-value').textContent = recentUsers.size;
//     document.querySelector('#online-users .card-value').setAttribute('title', `Active within 5 mins: ${recentUsers.size}`);
  
//     document.querySelector('#returning-users .card-value').textContent = returningUsers;
//     document.querySelector('#returning-users .card-value').setAttribute('title', `Users with multiple visits: ${returningUsers}`);
  
//     const topServiceElem = document.querySelector('#top-service .card-value');
//     topServiceElem.textContent = topService;
//     topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
//     topServiceElem.classList.add('h6-style');
  
//     console.log({ todayFormatted, usersToday, recentUsers, topService });
//   }

// function updateDashboardSummary(data, previousEmails) {
//     const uniqueEmails = new Set();
//     const emailCount = {};
//     const serviceCount = {};
  
//     const now = new Date();
//     const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
//     const todayFormatted = todayIST.getFullYear() + '-' + 
//                            String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
//                            String(todayIST.getDate()).padStart(2, '0');
  
//     let usersToday = 0;
//     let onlineUsers = 0;
//     const uniqueUsersToday = new Set();
//     const allTimeNewUsers = new Set();
  
//     const seenEmails = new Set(previousEmails || []);
  
//     data.forEach(item => {
//       if (item.email) {
//         uniqueEmails.add(item.email);
//         emailCount[item.email] = (emailCount[item.email] || 0) + 1;
  
//         // Check if this is a new user (not in previous Firestore emails)
//         if (!seenEmails.has(item.email)) {
//           allTimeNewUsers.add(item.email);
//         }
//       }
  
//       if (item.service) {
//         serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
//       }
  
//       if (item.time) {
//         const itemDate = item.time.split(" ")[0];
//         if (itemDate === todayFormatted && item.email) {
//           uniqueUsersToday.add(item.email);
//         }
//       }
  
//       if (item.date && item.time) {
//         const sessionTime = parseTimestamping(`${item.date} ${item.time}`);
//         if (sessionTime && (now - sessionTime) / 1000 <= 300) {
//           onlineUsers++;
//         }
//       }
//     });
  
//     usersToday = uniqueUsersToday.size;
//     const totalSessions = data.length;
//     const uniqueServices = new Set(Object.keys(serviceCount));
//     const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;
  
//     let topService = "-";
//     let maxServiceCount = 0;
//     for (const [service, count] of Object.entries(serviceCount)) {
//       if (count > maxServiceCount) {
//         topService = service;
//         maxServiceCount = count;
//       }
//     }
  
//     const returningUsers = Object.values(emailCount).filter(count => count > 1).length;
  
//     // Update dashboard UI
//     document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
//     document.querySelector('#total-sessions .card-value').textContent = totalSessions;
//     document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
//     document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
//     document.querySelector('#users-today .card-value').textContent = usersToday;
//     document.querySelector('#returning-users .card-value').textContent = returningUsers;
//     document.querySelector('#online-users .card-value').textContent = onlineUsers;
  
//     const topServiceElem = document.querySelector('#top-service .card-value');
//     topServiceElem.textContent = topService;
//     topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  
//     // Set the all-time new user count
//     document.querySelector('#todays-new-users .card-value').textContent = allTimeNewUsers.size;
//     document.querySelector('#todays-new-users .card-value').setAttribute('title', `New users (not in Firestore): ${allTimeNewUsers.size}`);
  
//     console.log({ todayFormatted, usersToday, allTimeNewUsers: allTimeNewUsers.size });
//   }
  
function updateDashboardSummary(data) {
    const uniqueEmails = new Set();
    const emailCount = {};
    const serviceCount = {};
  
    const now = new Date();
    const todayIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  
    const todayFormatted = todayIST.getFullYear() + '-' + 
                           String(todayIST.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(todayIST.getDate()).padStart(2, '0');
  
    let usersToday = 0;
  
    const uniqueUsersToday = new Set();
  
    data.forEach(item => {
      if (item.email) {
        uniqueEmails.add(item.email);
        emailCount[item.email] = (emailCount[item.email] || 0) + 1;
      }
  
      if (item.service) {
        serviceCount[item.service] = (serviceCount[item.service] || 0) + 1;
      }
  
      if (item.time) {
        const itemDate = item.time.split(" ")[0];
        if (itemDate === todayFormatted && item.email) {
          uniqueUsersToday.add(item.email);
        }
      }
    });
  
    const todaysNewUsers = uniqueUsersToday.size;
    usersToday = todaysNewUsers;
  
    const totalSessions = data.length;
    const uniqueServices = new Set(Object.keys(serviceCount));
    const avgSessions = uniqueEmails.size > 0 ? (totalSessions / uniqueEmails.size).toFixed(1) : 0;
  
    let topService = "-";
    let maxServiceCount = 0;
    for (const [service, count] of Object.entries(serviceCount)) {
      if (count > maxServiceCount) {
        topService = service;
        maxServiceCount = count;
      }
    }
  
    const returningUsers = Object.values(emailCount).filter(count => count > 1).length;
  
    document.querySelector('#total-users .card-value').textContent = uniqueEmails.size;
    document.querySelector('#total-sessions .card-value').textContent = totalSessions;
    document.querySelector('#active-services .card-value').textContent = uniqueServices.size;
    document.querySelector('#avg-sessions .card-value').textContent = avgSessions;
    document.querySelector('#users-today .card-value').textContent = usersToday;
    document.querySelector('#returning-users .card-value').textContent = returningUsers;
    document.querySelector('#todays-new-users .card-value').textContent = todaysNewUsers;
  
    const topServiceElem = document.querySelector('#top-service .card-value');
    topServiceElem.textContent = topService;
    topServiceElem.setAttribute('title', `Most used service: ${topService} (${maxServiceCount} times)`);
  
    console.log({ todayFormatted, usersToday, topService });
  }


// Update the updateCharts function to include the summary
const originalUpdateCharts = updateCharts;
updateCharts = function(data) {
originalUpdateCharts(data);
updateDashboardSummary(data);
};

// Call this function when the page loads
window.addEventListener('load', function() {
// Add the dashboard summary section
addDashboardSummary();
});


// Function to create chart containers if they don't exist
function createChartContainers() {
console.log("Setting up chart containers...");

// Check if the charts container exists
let chartsContainer = document.querySelector('.charts');

// If it doesn't exist, create it
if (!chartsContainer) {
  console.log("Creating charts container...");
  const rightPanel = document.querySelector('.right-panel');
  
  if (!rightPanel) {
    console.error("Right panel not found! Creating one...");
    const mainContainer = document.querySelector('.main-container');
    if (!mainContainer) {
      console.error("Main container not found! Creating the entire structure...");
      const body = document.body;
      
      // Create main container
      const newMainContainer = document.createElement('div');
      newMainContainer.className = 'main-container';
      
      // Create left panel
      const leftPanel = document.createElement('div');
      leftPanel.className = 'left-panel';
      
      // Create right panel
      const newRightPanel = document.createElement('div');
      newRightPanel.className = 'right-panel';
      
      // Create charts container
      chartsContainer = document.createElement('div');
      chartsContainer.className = 'charts';
      
      // Assemble structure
      newRightPanel.appendChild(chartsContainer);
      newMainContainer.appendChild(leftPanel);
      newMainContainer.appendChild(newRightPanel);
      
      // Add to body before any other content
      body.insertBefore(newMainContainer, body.firstChild);
    } else {
      const newRightPanel = document.createElement('div');
      newRightPanel.className = 'right-panel';
      chartsContainer = document.createElement('div');
      chartsContainer.className = 'charts';
      newRightPanel.appendChild(chartsContainer);
      mainContainer.appendChild(newRightPanel);
    }
  } else {
    chartsContainer = document.createElement('div');
    chartsContainer.className = 'charts';
    rightPanel.appendChild(chartsContainer);
  }
}

// Create/check individual chart containers
const chartIds = ['barChart', 'lineChart', 'emailChart', 'pieChart'];
const chartTitles = ['Sessions per Service', 'Sessions per Day', 'Unique Emails per Day', 'Service Distribution'];

chartIds.forEach((id, index) => {
  if (!document.getElementById(id)) {
    console.log(`Creating chart container for ${id}...`);
    const chartBox = document.createElement('div');
    chartBox.className = 'chart-box';
    chartBox.innerHTML = `
      <h3>${chartTitles[index]}</h3>
      <canvas id="${id}"></canvas>
    `;
    chartsContainer.appendChild(chartBox);
  }
});

// Add additional user activity chart
//   if (!document.getElementById('activityChart')) {
//     console.log("Creating activity chart container...");
//     const activityChartBox = document.createElement('div');
//     activityChartBox.className = 'chart-box';
//     activityChartBox.innerHTML = `
//       <h3>User Activity Timeline</h3>
//       <canvas id="activityChart"></canvas>
//     `;
//     chartsContainer.appendChild(activityChartBox);
//   }

// Apply basic styling if needed
if (!document.querySelector('style#chart-styles')) {
  const style = document.createElement('style');
  style.id = 'chart-styles';
  style.textContent = `
    .charts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      margin-bottom: 30px;
    }
    
    .chart-box {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chart-box h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 16px;
      color: #333;
      text-align: center;
    }
    
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
  `;
  document.head.appendChild(style);
}

console.log("Chart containers setup complete!");
}



// Function to update charts based on data with detailed logging
function updateCharts(data) {
console.log(`Updating charts with ${data.length} records...`);

try {
  // Ensure Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error("Chart.js is not loaded! Charts cannot be rendered.");
    return;
  }
  
  // Clean up any existing charts to prevent memory leaks
  try {
    Chart.helpers.each(Chart.instances, function(instance) {
      instance.destroy();
    });
  } catch (e) {
    console.warn("Could not clean up existing charts", e);
  }
  
  // Update the individual charts
  try {
    updateSessionsPerServiceChart(data);
    console.log("Sessions per Service chart updated");
  } catch (e) {
    console.error("Error updating Sessions per Service chart:", e);
  }
  
  try {
    updateSessionsPerDayChart(data);
    console.log("Sessions per Day chart updated");
  } catch (e) {
    console.error("Error updating Sessions per Day chart:", e);
  }
  
  try {
    updateUniqueEmailsPerDayChart(data);
    console.log("Unique Emails per Day chart updated");
  } catch (e) {
    console.error("Error updating Unique Emails per Day chart:", e);
  }
  
  try {
    updateServiceDistributionChart(data);
    console.log("Service Distribution chart updated");
  } catch (e) {
    console.error("Error updating Service Distribution chart:", e);
  }
  
  try {
  //   updateUserActivityChart(data);
    console.log("User Activity chart updated");
  } catch (e) {
    console.error("Error updating User Activity chart:", e);
  }
  
  console.log("All charts updated successfully!");
} catch (error) {
  console.error("Error in updateCharts function:", error);
}
}

// // 1. Bar Chart - Sessions per Service
// function updateSessionsPerServiceChart(data) {
// const canvas = document.getElementById('barChart');
// if (!canvas) {
//   console.error("Bar chart canvas not found!");
//   return;
// }

// const ctx = canvas.getContext('2d');

// // Count sessions per service
// const serviceCounts = {};
// data.forEach(item => {
//   const service = item.service || 'Unknown';
//   if (!serviceCounts[service]) {
//     serviceCounts[service] = 0;
//   }
//   serviceCounts[service]++;
// });

// // Prepare chart data
// const labels = Object.keys(serviceCounts);
// const values = Object.values(serviceCounts);

// // Create color array
// const backgroundColors = labels.map((_, index) => {
//   return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
// });

// // Create the chart
// new Chart(ctx, {
//   type: 'bar',
//   data: {
//     labels: labels,
//     datasets: [{
//       label: 'Number of Sessions',
//       data: values,
//       backgroundColor: backgroundColors,
//       borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
//       borderWidth: 1
//     }]
//   },
//   options: {
//     responsive: true,
//     maintainAspectRatio: false,
//     scales: {
//       y: {
//         beginAtZero: true,
//         ticks: {
//           precision: 0
//         }
//       }
//     },
//     plugins: {
//       legend: {
//         display: false
//       },
//       tooltip: {
//         callbacks: {
//           label: function(context) {
//             return `Sessions: ${context.raw}`;
//           }
//         }
//       }
//     }
//   }
// });
// }


function updateSessionsPerServiceChart(data) {
    const canvas = document.getElementById('barChart');
    if (!canvas) {
      console.error("Bar chart canvas not found!");
      return;
    }
  
    const ctx = canvas.getContext('2d');
  
    // Count sessions per service
    const serviceCounts = {};
    data.forEach(item => {
      const service = item.service || 'Unknown';
      if (!serviceCounts[service]) {
        serviceCounts[service] = 0;
      }
      serviceCounts[service]++;
    });
  
    // Sort services by count in descending order
    const sortedEntries = Object.entries(serviceCounts)
      .sort((a, b) => b[1] - a[1]); // descending
  
    const labels = sortedEntries.map(entry => entry[0]);
    const values = sortedEntries.map(entry => entry[1]);
  
    // Create color array
    const backgroundColors = labels.map((_, index) => {
      return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
    });
  
    // Create the chart
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Sessions',
          data: values,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Sessions: ${context.raw}`;
              }
            }
          }
        }
      }
    });
  }
  

// 2. Line Chart - Sessions per Day
function updateSessionsPerDayChart(data) {
const canvas = document.getElementById('lineChart');
if (!canvas) {
  console.error("Line chart canvas not found!");
  return;
}

const ctx = canvas.getContext('2d');

// Group sessions by day
const sessionsPerDay = {};

// Group sessions by day
data.forEach(item => {
  // Extract date from the time field
  let dateStr = "";
  
  if (item.time && item.time.includes(" ")) {
    dateStr = item.time.split(" ")[0]; 
  } else if (item.date) {
    dateStr = item.date;
  }
  
  if (!dateStr) return;
  
  // Initialize counter for this date if not exists
  if (!sessionsPerDay[dateStr]) {
    sessionsPerDay[dateStr] = 0;
  }
  
  sessionsPerDay[dateStr]++;
});

// Sort dates chronologically
const sortedDates = Object.keys(sessionsPerDay).sort((a, b) => new Date(a) - new Date(b));

// Prepare chart data
const chartData = {
  labels: sortedDates,
  datasets: [{
    label: 'Number of Sessions',
    data: sortedDates.map(date => sessionsPerDay[date]),
    fill: false,
    borderColor: 'rgba(75, 192, 192, 1)',
    tension: 0.1,
    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
    pointRadius: 4
  }]
};

// Create the chart
new Chart(ctx, {
  type: 'line',
  data: chartData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0
        }
      },
      x: {
        ticks: {
          maxRotation: 45,
          minRotation: 45
        }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            return `Sessions: ${context.raw}`;
          }
        }
      }
    }
  }
});
}

// 3. Line Chart - Unique Emails per Day
function updateUniqueEmailsPerDayChart(data) {
const canvas = document.getElementById('emailChart');
if (!canvas) {
  console.error("Email chart canvas not found!");
  return;
}

const ctx = canvas.getContext('2d');

// Group emails by day
const emailsByDay = {};

// Group emails by day
data.forEach(item => {
  // Extract date from the time field
  let dateStr = "";
  
  if (item.time && item.time.includes(" ")) {
    dateStr = item.time.split(" ")[0]; 
  } else if (item.date) {
    dateStr = item.date;
  }
  
  if (!dateStr || !item.email) return;
  
  // Initialize set for this date if not exists
  if (!emailsByDay[dateStr]) {
    emailsByDay[dateStr] = new Set();
  }
  
  // Add email to the set (sets only keep unique values)
  emailsByDay[dateStr].add(item.email);
});

// Sort dates chronologically
const sortedDates = Object.keys(emailsByDay).sort((a, b) => new Date(a) - new Date(b));

// Prepare chart data
const chartData = {
  labels: sortedDates,
  datasets: [{
    label: 'Unique Emails',
    data: sortedDates.map(date => emailsByDay[date].size),
    fill: false,
    borderColor: '#87CEEB',
    tension: 0.1,
    pointBackgroundColor: '#87CEEB',
    pointRadius: 4
  }]
};

// Create the chart
new Chart(ctx, {
  type: 'line',
  data: chartData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0
        }
      },
      x: {
        ticks: {
          maxRotation: 45,
          minRotation: 45
        }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            return `Unique Emails: ${context.raw}`;
          }
        }
      }
    }
  }
});
}

// 4. Pie Chart - Service Distribution
function updateServiceDistributionChart(data) {
const canvas = document.getElementById('pieChart');
if (!canvas) {
  console.error("Pie chart canvas not found!");
  return;
}

const ctx = canvas.getContext('2d');

// Count users per service
const serviceCounts = {};

// Count users per service
data.forEach(item => {
  const service = item.service || 'Unknown';
  if (!serviceCounts[service]) {
    serviceCounts[service] = 0;
  }
  serviceCounts[service]++;
});

// Prepare chart data
const labels = Object.keys(serviceCounts);
const values = Object.values(serviceCounts);

// Create color array
const backgroundColors = labels.map((_, index) => {
  return `hsla(${index * (360 / labels.length)}, 70%, 60%, 0.7)`;
});

// Create the chart
new Chart(ctx, {
  type: 'pie',
  data: {
    labels: labels,
    datasets: [{
      data: values,
      backgroundColor: backgroundColors,
      borderColor: '#ffffff',
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: {
          boxWidth: 15
        }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const label = context.label || '';
            const value = context.raw || 0;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${label}: ${value} (${percentage}%)`;
          }
        }
      }
    }
  }
});
}



// // 5. User Activity Chart - User Activity Timeline
// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }

//   const ctx = canvas.getContext('2d');

//   // Process the data to create a timeline of activity
//   const activityByHour = {};

//   // Initialize hours (0-23) with zero count
//   for (let i = 0; i < 24; i++) {
//     activityByHour[i] = 0;
//   }

//   // Count activities by hour
//   data.forEach(item => {
//     let hourOfDay = 0;
  
//     if (item.time) {
//       let timeStr = item.time;
//       if (item.time.includes(" ")) {
//         timeStr = item.time.split(" ")[1]; // Get the time part
//       }
    
//       // Extract hour from the time string (assuming format HH:MM:SS)
//       const hourMatch = timeStr.match(/^(\d{1,2}):/);
//       if (hourMatch) {
//         hourOfDay = parseInt(hourMatch[1]);
//       }
//     }
  
//     // Increment counter for this hour
//     activityByHour[hourOfDay]++;
//   });

//   // Prepare chart data
//   const hours = Object.keys(activityByHour).map(Number).sort((a, b) => a - b);
//   const activityCounts = hours.map(hour => activityByHour[hour]);

//   // Format hour labels (00:00, 01:00, etc.)
//   const hourLabels = hours.map(hour => {
//     const formattedHour = hour.toString().padStart(2, '0');
//     return `${formattedHour}:00`;
//   });

//   // Create the chart
//   new Chart(ctx, {
//     type: 'bar',
//     data: {
//       labels: hourLabels,
//       datasets: [{
//         label: 'User Activity',
//         data: activityCounts,
//         backgroundColor: 'rgba(153, 102, 255, 0.6)',
//         borderColor: 'rgba(153, 102, 255, 1)',
//         borderWidth: 1
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       scales: {
//         y: {
//           beginAtZero: true,
//           ticks: {
//             precision: 0
//           },
//           title: {
//             display: true,
//             text: 'Number of Sessions'
//           }
//         },
//         x: {
//           title: {
//             display: true,
//             text: 'Hour of Day'
//           }
//         }
//       },
//       plugins: {
//         title: {
//           display: true,
//           text: 'User Activity Distribution by Hour'
//         },
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               return `Sessions: ${context.raw}`;
//             }
//           }
//         }
//       }
//     }
//   });
// }

// function updateUserActivityChart(data) {
//   const canvas = document.getElementById('activityChart');
//   if (!canvas) {
//     console.error("Activity chart canvas not found!");
//     return;
//   }

//   const ctx = canvas.getContext('2d');

//   const serviceStats = {};

//   data.forEach(item => {
//     const service = item.service || "Unknown";
//     if (!serviceStats[service]) {
//       serviceStats[service] = { sessions: 0, users: new Set() };
//     }
//     serviceStats[service].sessions += 1;
//     if (item.email) {
//       serviceStats[service].users.add(item.email);
//     }
//   });

//   const bubbleData = Object.entries(serviceStats).map(([service, stats]) => ({
//     x: stats.sessions,
//     y: stats.users.size,
//     r: Math.sqrt(stats.sessions) + 5, // Bubble radius (scaled)
//     serviceName: service
//   }));

//   new Chart(ctx, {
//     type: 'bubble',
//     data: {
//       datasets: [{
//         label: 'Service Engagement',
//         data: bubbleData,
//         backgroundColor: 'rgba(54, 162, 235, 0.5)',
//         borderColor: 'rgba(54, 162, 235, 1)',
//         borderWidth: 1,
//         parsing: false
//       }]
//     },
//     options: {
//       responsive: true,
//       maintainAspectRatio: false,
//       plugins: {
//         tooltip: {
//           callbacks: {
//             label: function(context) {
//               const { x, y, r, serviceName } = context.raw;
//               return [
//                 `Service: ${serviceName}`,
//                 `Sessions: ${x}`,
//                 `Users: ${y}`,
//                 `Bubble Size: ${r.toFixed(1)}`
//               ];
//             }
//           }
//         },
//         title: {
//           display: true,
//           text: 'Service vs Sessions vs Users (Bubble Chart)'
//         }
//       },
//       scales: {
//         x: {
//           title: {
//             display: true,
//             text: 'Sessions'
//           },
//           beginAtZero: true
//         },
//         y: {
//           title: {
//             display: true,
//             text: 'Unique Users'
//           },
//           beginAtZero: true
//         }
//       }
//     }
//   });
// }


// Call initialization
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', initializeCharts);
} else {
initializeCharts();
}


// Call loadUserData when the page loads
window.addEventListener('DOMContentLoaded', function() {
console.log("DOM loaded, initializing dashboard...");
loadUserData();
//   addDashboardSummary();
});


  // Add these event listeners after existing event listeners in your JS code
  document.getElementById("downloadUserInfo").addEventListener("click", function() {
  openUserInfoPage();
  });

  document.getElementById("downloadUserDetails").addEventListener("click", function() {
  openUserDetailsPages();
  });

  // Function to open a new page with user information
  async function openUserInfoPage() {
  try {
      // Load data from Firestore
      const snapshot = await db.collection("testrig_UserDetails").get();
      let userData = [];
      
      snapshot.forEach(doc => {
      userData.push(doc.data());
      });
      
      // Generate HTML content
      const htmlContent = generateUserInfoHTML(userData);
      
      // Open new window with the content
      const newWindow = window.open('', '_blank');
      newWindow.document.write(htmlContent);
      newWindow.document.close();
  } catch (error) {
      console.error("Error opening user info page:", error);
      alert("Error loading user information. Please try again.");
  }
  }

  // Function to open a new page with user details (queries)
  async function openUserDetailsPage() {
  try {
      // Load data from Firestore
      const snapshot = await db.collection("testrig_queries").get();
      let queryData = [];
      
      snapshot.forEach(doc => {
      queryData.push(doc.data());
      });
      
      // Generate HTML content
      const htmlContent = generateUserDetailsHTML(queryData);
      
      // Open new window with the content
      const newWindow = window.open('', '_blank');
      newWindow.document.write(htmlContent);
      newWindow.document.close();
  } catch (error) {
      console.error("Error opening user details page:", error);
      alert("Error loading user details. Please try again.");
  }
  }



function generateUserInfoHTML(userData) {
  // Normalize and sort data by datetime (descending)
  const sortedData = userData.map(user => {
      let rawTime = user.time || user.date || "";
      let date = "";
      let time = "";
      let dateObj = null;

      if (rawTime.includes("T")) {
          // Format: 2025-04-14T18:54:10
          [date, time] = rawTime.split("T");
          dateObj = new Date(`${date}T${time}`);
      } else if (rawTime.includes(" ")) {
          // Format: 2025-04-22 11:16:18
          [date, time] = rawTime.split(" ");
          dateObj = new Date(`${date}T${time}`);
      } else {
          // Fallback (if no recognizable format)
          date = rawTime;
          time = "";
          dateObj = new Date(date);
      }

      return {
          ...user,
          formattedDate: date,
          formattedTime: time,
          dateObj: dateObj
      };
  }).sort((a, b) => b.dateObj - a.dateObj); // Descending sort

  // Generate table rows
  const tableRows = sortedData.map(user => `
      <tr>
          <td>${user.username || ""}</td>
          <td>${user.email || ""}</td>
          <td>${user.service || ""}</td>
          <td>${user.session_id || user.sessionid || ""}</td>
          <td>${user.formattedDate}</td>
          <td>${user.formattedTime}</td>
      </tr>
  `).join('');

  // Return full HTML with logo instead of title text and smaller font for table
  return `
      <html>
      <head>
          <title>User Info</title>
          <style>
              body {
                  font-family: Arial, sans-serif;
                  margin: 20px;
              }
              .header {
                  display: flex;
                  align-items: center;
                  margin-bottom: 20px;
              }
              .logo-img {
                  height: 40px;
                  margin-right: 15px;
              }
              table {
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 0.85em; /* Smaller font size for table */
              }
              th, td {
                  border: 1px solid #ccc;
                  padding: 6px; /* Reduced padding */
                  text-align: left;
              }
              th {
                  background-color: #f2f2f2;
                  font-weight: bold;
              }
              h2 {
                  margin: 0;
              }
          </style>
      </head>
      <body>
          <div class="header">
              <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
              <h2>User Information</h2>
          </div>
          <table>
              <thead>
                  <tr>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Service</th>
                      <th>Session ID</th>
                      <th>Date</th>
                      <th>Time</th>
                  </tr>
              </thead>
              <tbody>
                  ${tableRows}
              </tbody>
          </table>
      </body>
      </html>
  `;
}
// Helper function to parse timestamp for comparison (ignoring seconds)
function parseTimestampForComparison(timeStr) {
if (!timeStr) return null;

let date;

// Handle format "2025-04-17 10:36:57"
if (typeof timeStr === 'string' && timeStr.includes(' ')) {
  const [dateStr, timeStrPart] = timeStr.split(' ');
  const [year, month, day] = dateStr.split('-').map(Number);
  const [hours, minutes] = timeStrPart.split(':').map(Number);
  date = new Date(year, month - 1, day, hours, minutes, 0);
  return date;
}

// Handle ISO format "2025-04-15T12:46:23.657471"
if (typeof timeStr === 'string' && timeStr.includes('T')) {
  date = new Date(timeStr);
  // Zero out the seconds for comparison
  date.setSeconds(0, 0);
  return date;
}

// Try to parse as generic date string
try {
  date = new Date(timeStr);
  date.setSeconds(0, 0);
  return date;
} catch (e) {
  console.error("Error parsing timestamp:", e);
  return null;
}
}

// Helper function to format timestamp for display
function formatTimestamp(date) {
if (!date) return "";
return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
}

// Helper to pad numbers with leading zero
function padZero(num) {
return num.toString().padStart(2, '0');
}

// Helper to truncate text for display
function truncateText(text, maxLength) {
if (!text) return "";
if (text.length <= maxLength) return text;
return text.substring(0, maxLength) + "...";
}

// working
// function generateCombinedDetailsHTML(userData, queryData) {
//   // Normalize timestamp formats for both datasets
//   const normalizedUserData = userData.map(user => {
//     let timestamp = parseTimestampForComparison(user.time || user.date || "");
//     return {
//       ...user,
//       sessionId: user.session_id || user.sessionid || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });

//   const normalizedQueryData = queryData.map(query => {
//     let timestamp;
//     if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
//       timestamp = query.timestamp.toDate();
//     } else {
//       timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
//     }
//     return {
//       ...query,
//       sessionId: query.sessionId || query.session_id || "",
//       normalizedTime: timestamp,
//       timeString: formatTimestamp(timestamp)
//     };
//   });

//   // Group queries by session ID for quicker lookup
//   const queryBySessionId = {};
//   normalizedQueryData.forEach(query => {
//     if (query.sessionId) {
//       queryBySessionId[query.sessionId] = query;
//     }
//   });

//   // Combine data with session ID matching first, then timestamp matching
//   const combinedData = [];

//   normalizedUserData.forEach(user => {
//     // First try to match by session ID
//     if (user.sessionId && queryBySessionId[user.sessionId]) {
//       const query = queryBySessionId[user.sessionId];
//       combinedData.push({
//         username: user.username || "",
//         email: user.email || "",
//         service: user.service || "",
//         sessionId_user: user.sessionId,
//         sessionId_query: query.sessionId,
//         userTime: user.timeString,
//         queryTime: query.timeString,
//         query_by_bot1: query.query_by_bot1 || "",
//         response_by_bot1: query.response_by_bot1 || "",
//         query_by_bot2: query.query_by_bot2 || "",
//         response_by_bot2: query.response_by_bot2 || "",
//         query_by_bot3: query.query_by_bot3 || "",
//         response_by_bot3: query.response_by_bot3 || ""
//       });
//     } else {
//       // If session ID doesn't match, try time-based matching
//       const userTime = user.normalizedTime;
//       if (!userTime) {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//         return;
//       }
    
//       // Find matching queries within 3-minute window
//       const matchingQueries = normalizedQueryData.filter(query => {
//         const queryTime = query.normalizedTime;
//         if (!queryTime) return false;
      
//         // Compare timestamps with 3-minute window (180000 ms)
//         const timeDiff = Math.abs(userTime - queryTime);
//         return timeDiff <= 180000; // 3 minutes in milliseconds
//       });
    
//       if (matchingQueries.length > 0) {
//         // Use the closest matching query by time
//         matchingQueries.sort((a, b) => {
//           const diffA = Math.abs(userTime - a.normalizedTime);
//           const diffB = Math.abs(userTime - b.normalizedTime);
//           return diffA - diffB;
//         });
      
//         const closestQuery = matchingQueries[0];
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: closestQuery.sessionId,
//           userTime: user.timeString,
//           queryTime: closestQuery.timeString,
//           query_by_bot1: closestQuery.query_by_bot1 || "",
//           response_by_bot1: closestQuery.response_by_bot1 || "",
//           query_by_bot2: closestQuery.query_by_bot2 || "",
//           response_by_bot2: closestQuery.response_by_bot2 || "",
//           query_by_bot3: closestQuery.query_by_bot3 || "",
//           response_by_bot3: closestQuery.response_by_bot3 || ""
//         });
//       } else {
//         // Add user without matching query
//         combinedData.push({
//           username: user.username || "",
//           email: user.email || "",
//           service: user.service || "",
//           sessionId_user: user.sessionId,
//           sessionId_query: "",
//           userTime: user.timeString,
//           queryTime: "",
//           query_by_bot1: "",
//           response_by_bot1: "",
//           query_by_bot2: "",
//           response_by_bot2: "",
//           query_by_bot3: "",
//           response_by_bot3: ""
//         });
//       }
//     }
//   });

//   const tableRows = combinedData.map(item => `
//     <tr>
//       <td>${escapeHtml(item.username)}</td>
//       <td>${escapeHtml(item.email)}</td>
//       <td>${escapeHtml(item.service)}</td>
//       <td>${escapeHtml(item.sessionId_user)}</td>
//       <td>${escapeHtml(item.sessionId_query)}</td>
//       <td>${escapeHtml(item.userTime)}</td>
//       <td>${escapeHtml(item.queryTime)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
//       <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
//     </tr>
//   `).join('');
//   return `
//         <html>
//         <head>
//             <title>User Details</title>
//             <style>
//                 table { width: 100%; border-collapse: collapse; }
//                 .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
//                 .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
//                 .overlay { background: rgba(0,0,0,0.5); }
//                 .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
//                 .close-button { float: right; cursor: pointer; font-size: 20px; }
          

//                 body {
//                     font-family: Arial, sans-serif;
//                     margin: 20px;
//                 }
//                 .header {
//                     display: flex;
//                     align-items: center;
//                     margin-bottom: 20px;
//                 }
//                 .logo-img {
//                     height: 40px;
//                     margin-right: 15px;
//                 }
//                 table {
//                     width: 100%;
//                     border-collapse: collapse;
//                     font-size: 0.85em; /* Smaller font size for table */
//                 }
//                 th, td {
//                     border: 1px solid #ccc;
//                     padding: 6px;
//                     text-align: left;
//                 }
//                 th {
//                     background-color: #f2f2f2;
//                     font-weight: bold;
//                 }
//                 h2 {
//                     margin: 0;
//                 }
//             </style>
//         </head>
//         <body>
//             <div class="header">
//                 <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
//                 <h2>User Information</h2>
//             </div>
//             <table id="dataTable">
//         <thead>
//           <tr>
//             <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
//             <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
//             <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
//           </tr>
//         </thead>
//         <tbody>${tableRows}</tbody>
//       </table>
//       <div id="overlay" class="overlay"></div>
//       <div id="expanded-content" class="expanded-content">
//         <span id="close-expanded" class="close-button">&times;</span>
//         <div id="expanded-text"></div>
//       </div>
//         </body>
//         </html>
//     `;
//     document.addEventListener("DOMContentLoaded", function() {
//           const expandableCells = document.querySelectorAll('.expandable-cell');
//           const overlay = document.getElementById('overlay');
//           const expandedContent = document.getElementById('expanded-content');
//           const expandedText = document.getElementById('expanded-text');
//           const closeBtn = document.getElementById('close-expanded');

//           expandableCells.forEach(cell => {
//             cell.addEventListener('click', function() {
//               const content = decodeURIComponent(this.getAttribute('data-content'));
//               expandedText.innerHTML = content;
//               overlay.style.display = 'block';
//               expandedContent.style.display = 'block';
//             });
//           });

//           closeBtn.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           overlay.addEventListener('click', function() {
//             overlay.style.display = 'none';
//             expandedContent.style.display = 'none';
//           });

//           document.getElementById('exportExcel').addEventListener('click', function() {
//             const table = document.getElementById('dataTable');
//             const wb = XLSX.utils.table_to_book(table);
//             XLSX.writeFile(wb, 'UserDetails.xlsx');
//             });
//             });
//    }

  function generateCombinedDetailsHTML(userData, queryData) {
    // Normalize timestamp formats for both datasets
    const normalizedUserData = userData.map(user => {
      let timestamp = parseTimestampForComparison(user.time || user.date || "");
      return {
        ...user,
        sessionId: user.session_id || user.sessionid || "",
        normalizedTime: timestamp,
        timeString: formatTimestamp(timestamp)
      };
    });
    
    const normalizedQueryData = queryData.map(query => {
      let timestamp;
      if (typeof query.timestamp === 'object' && query.timestamp.toDate) {
        timestamp = query.timestamp.toDate();
      } else {
        timestamp = parseTimestampForComparison(query.timestamp || query.time || "");
      }
      return {
        ...query,
        sessionId: query.sessionId || query.session_id || "",
        normalizedTime: timestamp,
        timeString: formatTimestamp(timestamp)
      };
    });
    
    // Group queries by session ID
    const queryBySessionId = {};
    normalizedQueryData.forEach(query => {
      if (query.sessionId) {
        queryBySessionId[query.sessionId] = query;
      }
    });

    const combinedData = [];

    normalizedUserData.forEach(user => {
      if (user.sessionId && queryBySessionId[user.sessionId]) {
        const query = queryBySessionId[user.sessionId];
        combinedData.push({
          ...combineUserQuery(user, query)
        });
      } else {
        const userTime = user.normalizedTime;
        if (!userTime) {
          combinedData.push({
            ...combineUserQuery(user, null)
          });
          return;
        }

        const matchingQueries = normalizedQueryData.filter(query => {
          const queryTime = query.normalizedTime;
          if (!queryTime) return false;
          const timeDiff = Math.abs(userTime - queryTime);
          return timeDiff <= 180000;
        });

        if (matchingQueries.length > 0) {
          matchingQueries.sort((a, b) => {
            const diffA = Math.abs(userTime - a.normalizedTime);
            const diffB = Math.abs(userTime - b.normalizedTime);
            return diffA - diffB;
          });
          const closestQuery = matchingQueries[0];
          combinedData.push({
            ...combineUserQuery(user, closestQuery)
          });
        } else {
          combinedData.push({
            ...combineUserQuery(user, null)
          });
        }
      }
    });

    // Sort by the latest time (descending)
    combinedData.sort((a, b) => {
      const timeA = parseTimestampForComparison(a.userTime || a.queryTime);
      const timeB = parseTimestampForComparison(b.userTime || b.queryTime);
      return timeB - timeA;
    });

    const tableRows = combinedData.map(item => `
      <tr>
        <td>${escapeHtml(item.username)}</td>
        <td>${escapeHtml(item.email)}</td>
        <td>${escapeHtml(item.service)}</td>
        <td>${escapeHtml(item.sessionId_user)}</td>
        <td>${escapeHtml(item.sessionId_query)}</td>
        <td>${escapeHtml(item.userTime)}</td>
        <td>${escapeHtml(item.queryTime)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot1)}">${truncateText(escapeHtml(item.query_by_bot1), 30)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot1)}">${truncateText(escapeHtml(item.response_by_bot1), 30)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot2)}">${truncateText(escapeHtml(item.query_by_bot2), 30)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot2)}">${truncateText(escapeHtml(item.response_by_bot2), 30)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.query_by_bot3)}">${truncateText(escapeHtml(item.query_by_bot3), 30)}</td>
        <td class="expandable-cell" data-content="${encodeURIComponent(item.response_by_bot3)}">${truncateText(escapeHtml(item.response_by_bot3), 30)}</td>
      </tr>
    `).join('');

    return `
      <html>
      <head>
        <title>User Details</title>
        <style>
           table { width: 100%; border-collapse: collapse; }
              .expandable-cell { cursor: pointer; color: blue; text-decoration: underline; }
              .overlay, .expanded-content { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
              .overlay { background: rgba(0,0,0,0.5); }
              .expanded-content { background: #fff; padding: 20px; z-index: 1001; max-height: 90%; overflow: auto; margin: 50px auto; border: 1px solid #ccc; }
              .close-button { float: right; cursor: pointer; font-size: 20px; }
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { display: flex; align-items: center; margin-bottom: 20px; }
          .logo-img { height: 60px; margin-right: 15px; }
          table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
          th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
          th { background-color: #f2f2f2; font-weight: bold; }
          h2 { margin: 0; }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="https://chat-bot-project-781b9.web.app/test_alloy_logo_green_.png" alt="Test Alloy Logo" class="logo-img"/>
          <h2>User Information</h2>
        </div>
        <table id="dataTable">
          <thead>
            <tr>
              <th>Username</th><th>Email</th><th>Service</th><th>SessionID User</th><th>SessionID Query</th>
              <th>User Time</th><th>Query Time</th><th>Query Bot 1</th><th>Response Bot 1</th>
              <th>Query Bot 2</th><th>Response Bot 2</th><th>Query Bot 3</th><th>Response Bot 3</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </body>
      </html>
    `;

    // Helper function to merge user and query into one object
    function combineUserQuery(user, query) {
      return {
        username: user.username || "",
        email: user.email || "",
        service: user.service || "",
        sessionId_user: user.sessionId,
        sessionId_query: query?.sessionId || "",
        userTime: user.timeString,
        queryTime: query?.timeString || "",
        query_by_bot1: query?.query_by_bot1 || "",
        response_by_bot1: query?.response_by_bot1 || "",
        query_by_bot2: query?.query_by_bot2 || "",
        response_by_bot2: query?.response_by_bot2 || "",
        query_by_bot3: query?.query_by_bot3 || "",
        response_by_bot3: query?.response_by_bot3 || ""
      };
    }
  }

document.addEventListener('DOMContentLoaded', function () {
  const downloadIcon1 = document.querySelector('.download-icon');

  if (downloadIcon1) {
    downloadIcon1.addEventListener('click', function () {
      exportUserInfoAsExcel();
    });
  }
});


function exportUserInfoAsExcel() {
  const table = document.getElementById("data-table");
  if (!table) return;

  const clonedTable = table.cloneNode(true);

  const headers = Array.from(clonedTable.querySelectorAll("thead tr th"));
  const dateColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "date");
  const timeColIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === "time");

  if (dateColIndex === -1 || timeColIndex === -1) {
    alert("Date or Time column not found!");
    return;
  }

  const rows = Array.from(clonedTable.querySelectorAll("tbody tr"));

  const rowsWithDatetime = rows.map(row => {
    const cells = row.querySelectorAll("td");
    const timeVal = cells[timeColIndex].textContent.trim();
    const currentDateVal = cells[dateColIndex].textContent.trim();

    let date = "";
    let time = "";

    if (timeVal.includes("T")) {
      [date, time] = timeVal.split("T");
    } else if (timeVal.includes(" ")) {
      [date, time] = timeVal.split(" ");
    } else {
      time = timeVal;
    }

    // Only update Date column if it's empty
    if (!currentDateVal) {
      cells[dateColIndex].textContent = date;
    }

    // Always update the Time column to just time part
    cells[timeColIndex].textContent = time;

    // Use date from Time column if available, else fall back to existing Date column
    const fullDateStr = date || currentDateVal;
    const fullDateTime = new Date(`${fullDateStr}T${time}`);

    return { row, datetime: fullDateTime };
  });

  // Sort in descending order
  rowsWithDatetime.sort((a, b) => b.datetime - a.datetime);

  const tbody = clonedTable.querySelector("tbody");
  tbody.innerHTML = "";
  rowsWithDatetime.forEach(({ row }) => tbody.appendChild(row));

  const wb = XLSX.utils.table_to_book(clonedTable, { sheet: "User Info" });
  XLSX.writeFile(wb, "User_Information.xlsx");
}

// Function to open a new page with combined user details
async function openUserDetailsPages() {
try {
  document.body.style.cursor = 'wait'; // Show waiting cursor
  
  // Load data from both Firestore collections
  const userSnapshot = await db.collection("testrig_UserDetails").get();
  const querySnapshot = await db.collection("testrig_queries").get();
  
  let userData = [];
  let queryData = [];
  
  userSnapshot.forEach(doc => {
    userData.push(doc.data());
  });
  
  querySnapshot.forEach(doc => {
    queryData.push(doc.data());
  });
  
  // Generate HTML content with combined data
  const htmlContent = generateCombinedDetailsHTML(userData, queryData);
  
  // Open new window with the content
  const newWindow = window.open('', '_blank');
  newWindow.document.write(htmlContent);
  newWindow.document.close();
  document.body.style.cursor = 'default'; 
} catch (error) {
  console.error("Error opening combined details page:", error);
  alert("Error loading combined user details. Please try again.");
  document.body.style.cursor = 'default'; // Reset cursor
}
}
document.getElementById("refreshBtn").addEventListener("click", () => {
location.reload();
});

function escapeHtml(str) {
return str?.replace(/[&<>"']/g, m => ({
  '&': '&amp;', '<': '&lt;', '>': '&gt;',
  '"': '&quot;', "'": '&#039;'
})[m]) || '';
}



styles.css

body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  
  .login-container {
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
    width: 300px;
    text-align: center;
  }
  
  .login-container h2 {
    margin-bottom: 20px;
  }


  .loginin-container {
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
    width: 300px;
    text-align: center;
  }
  
  .loginin-container h2 {
    margin-bottom: 20px;
  }

  .loginin-container input {
    width: 92%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  
  
  .login-container input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  
  button {
    width: 100%;
    padding: 10px;
    background: #20bc75;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  
  button:hover {
    background: #4CAF50;
  }
  .error-message {
    color: red;
    font-size: 14px;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 20px;
    background-color: #f5f5f5;
  }
  
  .logo-img {
    max-height: 60px;
  }
  
  .top-right-controls {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
  }
  
  #refreshBtn {
    background-color: #20bc75;
    color: white;
    border: none;
    padding: 6px 12px;
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
  }
  
  .search-box {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .search-box input {
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  
  .search-box button {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  #searchBtn {
    background-color: #20bc75;
    color: white;
  }
  
  #clearSearch {
    background-color: #f44336;
    color: white;
  }
  

================













